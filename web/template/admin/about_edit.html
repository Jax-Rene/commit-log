{{template "base" .}}

{{define "content"}}
<div class="space-y-10" x-data="aboutForm({{printf "%q" .content}}, {{printf "%q" .updatedAt}}, {{printf "%q" .language}})" x-init="init()">
	<header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
		<div>
			<h1 class="text-3xl font-semibold text-slate-900 dark:text-slate-100">{{tr .language "Edit About Me" "编辑关于我"}}</h1>
			<p class="mt-2 text-sm text-slate-500 dark:text-slate-400">{{tr .language "Write in Markdown with live preview." "使用 Markdown 撰写个人介绍，支持实时预览。"}}</p>
			<p class="mt-1 text-xs text-slate-400 dark:text-slate-500" x-show="updatedAt" x-cloak>{{tr .language "Last saved:" "最近保存："}}<span x-text="updatedAt"></span></p>
		</div>
		<div class="flex flex-col gap-3 sm:flex-row sm:items-center">
			<label class="flex items-center gap-2 text-xs font-medium text-slate-500 dark:text-slate-400">
				<span>{{tr .language "Language" "语言"}}</span>
				<select x-model="language" @change="switchLanguage()" class="rounded-lg border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-600 shadow-sm transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-200 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30">
					<option value="zh">{{tr .language "Chinese" "中文"}}</option>
					<option value="en">{{tr .language "English" "英文"}}</option>
				</select>
			</label>
			<a href="/about" target="_blank" class="inline-flex items-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">{{tr .language "View public page" "查看前台页面"}}</a>
		</div>
	</header>

	{{if .error}}
	<div class="rounded-2xl border border-rose-200 bg-rose-50 p-6 text-sm text-rose-600 dark:border-rose-500/50 dark:bg-rose-500/10 dark:text-rose-200">
		{{if eq .language "en"}}Failed to load About content. Please try again.{{else}}{{.error}}{{end}}
	</div>
	{{end}}

	<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
		<label class="flex flex-col gap-2">
			<span class="text-sm font-medium text-slate-700 dark:text-slate-200">{{tr .language "About Me content" "关于我内容"}}<span class="ml-1 text-rose-500">*</span></span>
			<p class="text-xs text-slate-500 dark:text-slate-400">{{tr .language "Supports Markdown. Include background, strengths, and contact info." "支持 Markdown 语法，建议包含个人背景、擅长方向与联系渠道。"}}</p>
			<textarea id="about-content" class="hidden">{{- .content -}}</textarea>
		</label>
	</section>

	<section class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
		<div class="space-y-1">
			<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">{{tr .language "Actions" "操作"}}</h2>
			<p class="text-xs text-slate-500 dark:text-slate-400">{{tr .language "Preview the layout, then save to the database." "先预览确认排版，再保存到数据库。"}}</p>
		</div>
		<div class="flex flex-col gap-3 sm:flex-row">
			<button type="button" @click="preview()" class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">{{tr .language "Preview" "预览"}}</button>
			<button type="button" @click="submit()" :disabled="loading" class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 disabled:cursor-not-allowed disabled:bg-slate-300 dark:hover:bg-blue-500/90 dark:disabled:bg-slate-700/80">
				<span x-show="!loading">{{tr .language "Save" "保存"}}</span>
				<span x-show="loading">{{tr .language "Saving..." "保存中..."}}</span>
			</button>
		</div>
	</section>
</div>

<script>
	function aboutForm(initialContent, initialUpdatedAt, initialLanguage) {
		const preferServerMessage = {{if eq .language "zh"}}true{{else}}false{{end}};
		return {
			editor: null,
			fullscreenWatcher: null,
			loading: false,
			form: {
				content: initialContent ? initialContent : ''
			},
			updatedAt: initialUpdatedAt ? initialUpdatedAt : '',
			language: initialLanguage ? initialLanguage : 'zh',

			init() {
				this.initializeEditor();
			},

			initializeEditor() {
				if (this.editor) {
					return;
				}
				const textarea = document.getElementById('about-content');
				if (!textarea) {
					return;
				}
				const easyMDE = new EasyMDE({
					element: textarea,
					spellChecker: false,
					autosave: {
						enabled: true,
						uniqueId: 'about-page',
						delay: 1000,
					},
					status: ['words'],
					renderingConfig: {
						singleLineBreaks: false,
					},
					toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', 'table', 'code', '|', 'preview', 'side-by-side', 'fullscreen'],
					initialValue: this.form.content || ''
				});

				easyMDE.codemirror.on('change', () => {
					this.form.content = easyMDE.value();
				});

				easyMDE.codemirror.on('refresh', () => this.syncFullscreenState());
				this.fullscreenWatcher = () => this.syncFullscreenState();
				window.addEventListener('keyup', this.fullscreenWatcher);
				window.addEventListener('resize', this.fullscreenWatcher);
				window.addEventListener('click', this.fullscreenWatcher);
				this.syncFullscreenState();

				this.editor = easyMDE;
			},

			syncFullscreenState() {
				if (!this.editor) {
					document.body.classList.remove('mde-fullscreen');
					return;
				}
				const isFull = this.editor.isFullscreenActive && this.editor.isFullscreenActive();
				document.body.classList.toggle('mde-fullscreen', !!isFull);
			},

			destroy() {
				if (this.fullscreenWatcher) {
					window.removeEventListener('keyup', this.fullscreenWatcher);
					window.removeEventListener('resize', this.fullscreenWatcher);
					window.removeEventListener('click', this.fullscreenWatcher);
					this.fullscreenWatcher = null;
				}
				document.body.classList.remove('mde-fullscreen');
			},

			submit() {
				const content = this.editor ? this.editor.value() : this.form.content;
				if (!content || !content.trim()) {
					window.AdminUI.toast({ message: {{toJSON (tr .language "Please fill in the About Me content" "请填写关于我内容")}}, type: 'warning' });
					return;
				}

				this.loading = true;
				fetch('/admin/api/pages/about', {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ content, language: this.language })
				})
					.then(response => response.json())
					.then(data => {
						if (data.error) {
							const fallback = {{toJSON (tr .language "Save failed. Please try again." "保存失败，请稍后重试")}};
							const message = (preferServerMessage && data.error) ? data.error : fallback;
							window.AdminUI.toast({ message, type: 'error' });
							return;
						}
						if (data.message || !data.error) {
							const fallback = {{toJSON (tr .language "About page updated" "关于页面已更新")}};
							const message = (preferServerMessage && data.message) ? data.message : fallback;
							this.form.content = content;
							window.AdminUI.toast({ message, type: 'success' });
							this.updatedAt = data.page && data.page.updatedAt ? data.page.updatedAt : this.updatedAt;
							if (this.editor && this.editor.clearAutosavedValue) {
								this.editor.clearAutosavedValue();
							}
						}
					})
					.catch(() => {
						window.AdminUI.toast({ message: {{toJSON (tr .language "Save failed. Please try again." "保存失败，请稍后重试")}}, type: 'error' });
					})
					.finally(() => {
						this.loading = false;
					});
			},

			switchLanguage() {
				const url = new URL(window.location.href);
				url.searchParams.set('lang', this.language);
				window.location.href = url.toString();
			},

			preview() {
				const markdown = this.editor ? this.editor.value() : this.form.content;
				const previewWindow = window.open('', '_blank');
				const parsed = this.editor ? this.editor.markdown(markdown) : markdown;
				previewWindow.document.write(`
					<html>
					<head>
						<title>{{tr .language "Preview · About Me" "预览 · 关于我"}}</title>
                                                <link rel="stylesheet" href="/static/dist/assets/input.css">
                                                <link rel="stylesheet" href="/static/dist/assets/admin.css">
						<style>
							:root { color-scheme: light dark; }
                                                    body { font-family: var(--font-body); max-width: 780px; margin: 0 auto; padding: 2rem; color: #1f2937; background: #ffffff; line-height: 1.65; transition: color 0.2s ease, background 0.2s ease; }
							h1, h2, h3, h4 { margin-top: 1.5rem; margin-bottom: 0.75rem; }
							p { margin: 1rem 0; line-height: 1.7; }
							code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
							pre { background: #0f172a; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
							img { max-width: 100%; border-radius: 0.5rem; }
							@media (prefers-color-scheme: dark) {
								body { color: #e2e8f0; background: #020617; }
								code { background: rgba(148, 163, 184, 0.12); color: #e2e8f0; }
							}
						</style>
                                                <script>window.hljs = window.hljs || (window.opener && window.opener.hljs);</script>
					</head>
					<body>
						<h1>{{tr .language "About Me" "关于我"}}</h1>
						<div>${parsed}</div>
                                                <script>
                                                        const highlight = window.hljs || (window.opener && window.opener.hljs);
                                                        if (highlight) {
                                                                document.querySelectorAll('pre code').forEach(block => highlight.highlightElement(block));
                                                        }
                                                </script>
					</body>
					</html>
				`);
				previewWindow.document.close();
			}
		};
	}

	window.addEventListener('beforeunload', () => {
		document.body.classList.remove('mde-fullscreen');
	});
</script>
{{end}}
