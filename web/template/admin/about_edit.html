{{template "base" .}}

{{define "content"}}
<div class="space-y-10" x-data="aboutForm({{printf "%q" .content}}, {{printf "%q" .updatedAt}})" x-init="init()">
	<header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
		<div>
			<h1 class="text-3xl font-semibold text-slate-900 dark:text-slate-100">编辑关于我</h1>
			<p class="mt-2 text-sm text-slate-500 dark:text-slate-400">使用 Markdown 撰写个人介绍，支持实时预览。</p>
			<p class="mt-1 text-xs text-slate-400 dark:text-slate-500" x-show="updatedAt" x-cloak>最近保存：<span x-text="updatedAt"></span></p>
		</div>
		<a href="/about" target="_blank" class="inline-flex items-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">查看前台页面</a>
	</header>

	{{if .error}}
	<div class="rounded-2xl border border-rose-200 bg-rose-50 p-6 text-sm text-rose-600 dark:border-rose-500/50 dark:bg-rose-500/10 dark:text-rose-200">{{.error}}</div>
	{{end}}

	<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
		<div class="flex flex-col gap-2">
			<span class="text-sm font-medium text-slate-700 dark:text-slate-200">关于我内容<span class="ml-1 text-rose-500">*</span></span>
			<p class="text-xs text-slate-500 dark:text-slate-400">支持 Markdown 语法，建议包含个人背景、擅长方向与联系渠道。</p>
                        <div id="about-editor" class="milkdown-editor" aria-label="关于我内容编辑器"></div>
		</div>
	</section>

	<section class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
		<div class="space-y-1">
			<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">操作</h2>
			<p class="text-xs text-slate-500 dark:text-slate-400">先预览确认排版，再保存到数据库。</p>
		</div>
		<div class="flex flex-col gap-3 sm:flex-row">
			<button type="button" @click="preview()" class="inline-flex items-center justify-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">预览</button>
			<button type="button" @click="submit()" :disabled="loading" class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 disabled:cursor-not-allowed disabled:bg-slate-300 dark:hover:bg-blue-500/90 dark:disabled:bg-slate-700/80">
				<span x-show="!loading">保存</span>
				<span x-show="loading">保存中...</span>
			</button>
		</div>
	</section>
</div>

<script>
        function aboutForm(initialContent, initialUpdatedAt) {
                return {
                        editor: null,
                        loading: false,
                        autosaveTimer: null,
                        autosaveKey: 'about-page',
                        form: {
                                content: initialContent ? initialContent : ''
                        },
                        updatedAt: initialUpdatedAt ? initialUpdatedAt : '',

                        async init() {
                                this.loadAutosavedContent();
                                await this.initializeEditor();
                        },

                        async initializeEditor() {
                                if (this.editor) {
                                        return;
                                }
                                const container = document.getElementById('about-editor');
                                if (!container || !window.AdminMilkdown) {
                                        return;
                                }
                                try {
                                        this.editor = await window.AdminMilkdown.createEditor({
                                                element: container,
                                                initialValue: this.form.content || '',
                                                onChange: markdown => {
                                                        this.form.content = markdown;
                                                        this.scheduleAutosave();
                                                },
                                        });
                                } catch (error) {
                                        console.error('初始化 Milkdown 失败', error);
                                }
                        },

                        loadAutosavedContent() {
                                const keys = [
                                        `Milkdown-autosave-${this.autosaveKey}`,
                                        `EasyMDE-autosave-${this.autosaveKey}`
                                ];
                                for (const key of keys) {
                                        const raw = window.localStorage.getItem(key);
                                        if (!raw) {
                                                continue;
                                        }
                                        try {
                                                const parsed = typeof raw === 'string' ? JSON.parse(raw) : raw;
                                                if (parsed && typeof parsed.value === 'string' && parsed.value.trim()) {
                                                        this.form.content = parsed.value;
                                                        break;
                                                }
                                        } catch (error) {
                                                console.warn('读取草稿失败', error);
                                        }
                                }
                        },

                        scheduleAutosave() {
                                if (this.autosaveTimer) {
                                        clearTimeout(this.autosaveTimer);
                                }
                                this.autosaveTimer = setTimeout(() => {
                                        const payload = {
                                                time: Date.now(),
                                                value: this.form.content || ''
                                        };
                                        window.localStorage.setItem(
                                                `Milkdown-autosave-${this.autosaveKey}`,
                                                JSON.stringify(payload)
                                        );
                                }, 800);
                        },

                        clearAutosave() {
                                if (this.autosaveTimer) {
                                        clearTimeout(this.autosaveTimer);
                                        this.autosaveTimer = null;
                                }
                                window.localStorage.removeItem(`Milkdown-autosave-${this.autosaveKey}`);
                                window.localStorage.removeItem(`EasyMDE-autosave-${this.autosaveKey}`);
                        },

                        destroy() {
                                if (this.editor && this.editor.destroy) {
                                        this.editor.destroy();
                                }
                                this.clearAutosave();
                        },

                        submit() {
                                const content = this.editor && this.editor.getMarkdown
                                        ? this.editor.getMarkdown()
                                        : this.form.content;
                                if (!content || !content.trim()) {
                                        window.AdminUI.toast({ message: '请填写关于我内容', type: 'warning' });
                                        return;
                                }

                                this.loading = true;
                                fetch('/admin/api/pages/about', {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ content })
                                })
                                        .then(response => response.json())
                                        .then(data => {
                                                if (data.error) {
                                                        window.AdminUI.toast({ message: data.error, type: 'error' });
                                                        return;
                                                }
                                                if (data.message) {
                                                        this.form.content = content;
                                                        window.AdminUI.toast({ message: data.message, type: 'success' });
                                                        this.updatedAt = data.page && data.page.updatedAt ? data.page.updatedAt : this.updatedAt;
                                                        this.clearAutosave();
                                                }
                                        })
                                        .catch(() => {
                                                window.AdminUI.toast({ message: '保存失败，请稍后重试', type: 'error' });
                                        })
                                        .finally(() => {
                                                this.loading = false;
                                        });
                        },

                        preview() {
                                const markdown = this.editor && this.editor.getMarkdown
                                        ? this.editor.getMarkdown()
                                        : this.form.content;
                                const previewWindow = window.open('', '_blank');
                                const parsed = this.editor && this.editor.getHTML
                                        ? this.editor.getHTML()
                                        : window.AdminMilkdown.renderMarkdown(markdown);
                                previewWindow.document.write(`
                                        <html>
                                        <head>
                                                <title>预览 · 关于我</title>
                                                <link rel="stylesheet" href="/static/dist/assets/input.css">
                                                <link rel="stylesheet" href="/static/dist/assets/admin.css">
                                                <style>
                                                        :root { color-scheme: light dark; }
                                                        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 780px; margin: 0 auto; padding: 2rem; color: #1f2937; background: #ffffff; transition: color 0.2s ease, background 0.2s ease; }
                                                        h1, h2, h3, h4 { margin-top: 1.5rem; margin-bottom: 0.75rem; }
                                                        p { margin: 1rem 0; line-height: 1.7; }
                                                        code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
                                                        pre { background: #0f172a; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
                                                        img { max-width: 100%; border-radius: 0.5rem; }
                                                        @media (prefers-color-scheme: dark) {
                                                                body { color: #e2e8f0; background: #020617; }
                                                                code { background: rgba(148, 163, 184, 0.12); color: #e2e8f0; }
                                                        }
                                                </style>
                                                <script>window.hljs = window.hljs || (window.opener && window.opener.hljs);</script>
                                        </head>
                                        <body>
                                                <h1>关于我</h1>
                                                <div>${parsed}</div>
                                                <script>
                                                        const highlight = window.hljs || (window.opener && window.opener.hljs);
                                                        if (highlight) {
                                                                document.querySelectorAll('pre code').forEach(block => highlight.highlightElement(block));
                                                        }
                                                </script>
                                        </body>
                                        </html>
                                `);
                                previewWindow.document.close();
                        }
                };
        }
</script>
{{end}}
