{{template "base" .}}

{{define "content"}}
<div class="space-y-10" x-data="postForm()" x-init="init()">
	<header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm sm:flex-row sm:items-center sm:justify-between">
		<div>
			<h1 class="text-3xl font-semibold text-slate-900">{{if .post.ID}}编辑文章{{else}}创建新文章{{end}}</h1>
			<p class="mt-2 text-sm text-slate-500">支持 Markdown 编辑与图片上传。</p>
		</div>
		<a href="/admin/posts" class="inline-flex items-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100">返回列表</a>
	</header>

	<form id="post-form" @submit.prevent="submitForm" class="grid gap-6 lg:grid-cols-[2fr,1fr]">
		<section class="space-y-6">
			<label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
				<span class="text-sm font-medium text-slate-700">文章标题<span class="ml-1 text-rose-500">*</span></span>
				<input type="text" x-model="post.title" placeholder="请输入文章标题" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100" required>
			</label>

			<label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
				<span class="text-sm font-medium text-slate-700">文章摘要</span>
				<textarea x-model="post.summary" rows="4" placeholder="简要描述文章的核心观点" class="w-full resize-none rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100"></textarea>
			</label>

			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
				<label class="flex flex-col gap-2">
					<span class="text-sm font-medium text-slate-700">文章内容<span class="ml-1 text-rose-500">*</span></span>
					<textarea id="content" rows="18" x-model="post.content" class="hidden"></textarea>
				</label>
			</section>
		</section>

		<aside class="space-y-6">
			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
				<h2 class="text-sm font-semibold text-slate-900">发布设置</h2>
				<div class="mt-4 space-y-3">
					<label class="flex items-center gap-2 text-sm text-slate-600">
						<input type="radio" value="draft" x-model="post.status" class="h-4 w-4 border-slate-300 text-blue-600 focus:ring-blue-500">
						<span>草稿</span>
					</label>
					<label class="flex items-center gap-2 text-sm text-slate-600">
						<input type="radio" value="published" x-model="post.status" class="h-4 w-4 border-slate-300 text-blue-600 focus:ring-blue-500">
						<span>已发布</span>
					</label>
				</div>
			</section>

			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
				<h2 class="text-sm font-semibold text-slate-900">标签</h2>
				<p class="mt-2 text-xs text-slate-500">最多选择 5 个标签，帮助读者快速理解主题。</p>
				<div class="mt-4 flex flex-wrap gap-2">
					<template x-for="tag in allTags" :key="tag.id">
						<label class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-3 py-1 text-xs font-medium text-slate-600 transition-colors" :class="post.tagIds.includes(tag.id.toString()) ? 'border-blue-500 bg-blue-50 text-blue-600' : 'hover:border-blue-300 hover:bg-blue-50'">
							<input type="checkbox" class="sr-only" :value="tag.id" @change="toggleTag(tag.id)">
							<span x-text="tag.name"></span>
						</label>
					</template>
				</div>
			</section>

			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
				<h2 class="text-sm font-semibold text-slate-900">操作</h2>
				<div class="mt-4 space-y-3">
					<button type="button" @click="previewPost" class="w-full rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100">预览文章</button>
					<button type="submit" :disabled="loading" class="w-full rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 disabled:cursor-not-allowed disabled:bg-slate-300">
						<span x-show="!loading">{{if .post.ID}}保存修改{{else}}发布文章{{end}}</span>
						<span x-show="loading">保存中...</span>
					</button>
				</div>
			</section>
		</aside>
	</form>
</div>

<script>
	function postForm() {
		return {
			loading: false,
			editor: null,
			allTags: [],
			initialTagIds: '{{- range $index, $tag := .post.Tags -}}{{if $index}},{{end}}{{ $tag.ID }}{{- end -}}',
			post: {
				title: '{{.post.Title}}' || '',
				summary: '{{.post.Summary}}' || '',
				content: '{{.post.Content}}' || '',
				status: '{{if .post.Status}}{{.post.Status}}{{else}}draft{{end}}',
				tagIds: []
			},

			init() {
				this.applyInitialTagSelection();
				this.initializeEditor();
				this.fetchTags();
			},

			applyInitialTagSelection() {
				if (!this.initialTagIds) {
					return;
				}
				this.post.tagIds = this.initialTagIds.split(',').map(id => id.trim()).filter(Boolean);
			},

			fetchTags() {
				fetch('/admin/api/tags')
					.then(response => response.json())
					.then(data => {
						this.allTags = data.tags || [];
						if (this.post.tagIds.length === 0) {
							return;
						}
						const available = new Set(this.allTags.map(tag => tag.id.toString()));
						this.post.tagIds = this.post.tagIds.filter(id => available.has(id.toString()));
					})
					.catch(() => {
						this.allTags = [];
					});
			},

			toggleTag(id) {
				const value = id.toString();
				if (this.post.tagIds.includes(value)) {
					this.post.tagIds = this.post.tagIds.filter(tagId => tagId !== value);
				} else {
					this.post.tagIds.push(value);
				}
			},

			initializeEditor() {
				const easyMDE = new EasyMDE({
					element: document.getElementById('content'),
					spellChecker: false,
					status: ['lines', 'words', 'cursor'],
					toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', {
						name: 'image',
						action: EasyMDE.drawImage,
						className: 'fa fa-picture-o',
						title: '插入图片'
					}, 'table', 'code', '|', 'preview', 'side-by-side', 'fullscreen'],
					autosave: { enabled: true, uniqueId: 'post-content', delay: 1000 },
					uploadImage: true,
					imageUploadEndpoint: '/admin/api/upload/image',
					imagePathAbsolute: true,
					imageAccept: 'image/png, image/jpeg, image/gif, image/webp',
					imageMaxSize: 5 * 1024 * 1024,
					imageUploadFunction(file, onSuccess, onError) {
						const formData = new FormData();
						formData.append('image', file);
						fetch('/admin/api/upload/image', { method: 'POST', body: formData })
							.then(response => response.json())
							.then(data => {
								if (data.success === 1) {
									onSuccess(data.data.url);
								} else {
									onError(data.message || '上传失败');
								}
							})
							.catch(error => {
								onError('上传失败: ' + error.message);
							});
					},
					renderingConfig: { codeSyntaxHighlighting: false },
					initialValue: this.post.content
				});

				easyMDE.codemirror.on('change', () => {
					this.post.content = easyMDE.value();
				});

				this.editor = easyMDE;
			},

			submitForm() {
				this.loading = true;
				if (this.editor) {
					this.post.content = this.editor.value();
				}
				const payload = {
					title: this.post.title,
					summary: this.post.summary,
					content: this.post.content,
					status: this.post.status,
					tag_ids: this.post.tagIds.map(id => Number(id)).filter(id => !Number.isNaN(id))
				};

				let url = '/admin/api/posts';
				let method = 'POST';
				if (window.location.pathname.includes('/edit')) {
					const parts = window.location.pathname.split('/');
					const postId = parts[parts.length - 2];
					url = `/admin/api/posts/${postId}`;
					method = 'PUT';
				}

				fetch(url, {
					method,
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(payload)
				})
					.then(response => response.json())
					.then(data => {
						if (data.message) {
							alert(data.message);
							if (!window.location.pathname.includes('/edit')) {
								window.location.href = '/admin/posts';
							}
						}
					})
					.catch(() => {
						alert('保存失败，请稍后重试');
					})
					.finally(() => {
						this.loading = false;
					});
			},

			previewPost() {
				const preview = window.open('', '_blank');
				const parsed = this.editor ? this.editor.markdown(this.post.content) : this.post.content;
				preview.document.write(`
					<html>
					<head>
						<title>预览: ${this.post.title}</title>
						<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/github.min.css">
						<style>
							body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 780px; margin: 0 auto; padding: 2rem; color: #1f2937; }
							h1, h2, h3, h4 { margin-top: 1.5rem; margin-bottom: 0.75rem; }
							p { margin: 1rem 0; line-height: 1.7; }
							code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
							pre { background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
							img { max-width: 100%; border-radius: 0.5rem; }
						</style>
						<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/highlight.min.js"></script>
					</head>
					<body>
						<h1>${this.post.title}</h1>
						<div>${parsed}</div>
						<script>document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));</script>
					</body>
					</html>
				`);
				preview.document.close();
			}
		};
	}
</script>
{{end}}
