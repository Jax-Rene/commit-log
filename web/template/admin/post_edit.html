{{template "base" .}}

{{define "content"}}
<div class="space-y-10" x-data="postForm()" x-init="init()">
	<header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
		<div>
			<h1 class="text-3xl font-semibold text-slate-900 dark:text-slate-100">{{if .post.ID}}编辑文章{{else}}创建新文章{{end}}</h1>
			<p class="mt-2 text-sm text-slate-500 dark:text-slate-400">支持 Markdown 编辑与图片上传。</p>
		</div>
		<a href="/admin/posts" class="inline-flex items-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">返回列表</a>
	</header>

	<form id="post-form" @submit.prevent="submitForm" class="grid gap-6 lg:grid-cols-[2fr,1fr]">
		<section class="space-y-6">
			<label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<span class="text-sm font-medium text-slate-700 dark:text-slate-200">文章标题<span class="ml-1 text-rose-500">*</span></span>
				<input type="text" x-model="post.title" placeholder="请输入文章标题" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:placeholder-slate-500 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30" required>
			</label>

			<label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<span class="text-sm font-medium text-slate-700 dark:text-slate-200">文章摘要</span>
				<textarea x-model="post.summary" rows="4" placeholder="简要描述文章的核心观点" class="w-full resize-none rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:placeholder-slate-500 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30"></textarea>
			</label>

			<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
					<div>
						<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">文章封面<span class="ml-1 text-rose-500">*</span></h2>
						<p class="text-xs text-slate-500 dark:text-slate-400">支持横图或竖图，建议尺寸 ≥ 1200px，上传后可裁剪。</p>
					</div>
					<label class="inline-flex cursor-pointer items-center gap-2 rounded-lg border border-slate-300 px-4 py-2 text-xs font-medium text-slate-600 transition-colors hover:border-blue-300 hover:bg-blue-50 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:border-blue-400/60 dark:hover:bg-blue-500/10 dark:hover:text-slate-100">
						<input type="file" accept="image/*" class="hidden" @change="handleCoverFile">
						<span>选择图片</span>
					</label>
				</div>
				<div class="rounded-xl border border-dashed border-slate-300 bg-slate-50/60 p-4 transition-colors dark:border-slate-600 dark:bg-slate-900/60" x-show="cover.url" x-cloak>
					<div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
						<div class="flex items-center gap-4">
							<img :src="cover.url" alt="封面预览" class="h-28 w-28 rounded-lg object-cover" />
							<div class="space-y-2 text-xs text-slate-600 dark:text-slate-300">
								<p class="font-medium text-slate-800 dark:text-slate-200">当前封面</p>
								<p>尺寸：<span x-text="cover.width"></span> × <span x-text="cover.height"></span> px</p>
								<p class="text-[11px] text-slate-400 dark:text-slate-500">保存后首页将根据比例自动排版。</p>
							</div>
						</div>
						<div class="flex gap-3 text-xs">
							<button type="button" @click="reCropCover" class="rounded-lg border border-slate-200 px-3 py-1.5 font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">重新裁剪</button>
							<button type="button" @click="removeCover" class="rounded-lg border border-rose-200 px-3 py-1.5 font-medium text-rose-600 transition-colors hover:bg-rose-50 dark:border-rose-500/50 dark:text-rose-300 dark:hover:bg-rose-500/10">移除</button>
						</div>
					</div>
				</div>
			</section>

			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<label class="flex flex-col gap-2">
					<span class="text-sm font-medium text-slate-700 dark:text-slate-200">文章内容<span class="ml-1 text-rose-500">*</span></span>
					<textarea id="content" rows="18" x-model="post.content" class="hidden"></textarea>
				</label>
			</section>
		</section>

		<aside class="space-y-6">
			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">发布设置</h2>
				<div class="mt-4 space-y-3">
					<label class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
						<input type="radio" value="draft" x-model="post.status" class="h-4 w-4 border-slate-300 text-blue-600 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-900/60">
						<span>草稿</span>
					</label>
					<label class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
						<input type="radio" value="published" x-model="post.status" class="h-4 w-4 border-slate-300 text-blue-600 focus:ring-blue-500 dark:border-slate-600 dark:bg-slate-900/60">
						<span>已发布</span>
					</label>
				</div>
			</section>

			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">标签</h2>
				<p class="mt-2 text-xs text-slate-500 dark:text-slate-400">最多选择 5 个标签，帮助读者快速理解主题。</p>
				<div class="mt-4 flex flex-wrap gap-2">
					<template x-for="tag in allTags" :key="tag.id">
						<label class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-3 py-1 text-xs font-medium text-slate-600 transition-colors dark:border-slate-700 dark:text-slate-300" :class="post.tagIds.includes(tag.id.toString()) ? 'border-blue-500 bg-blue-50 text-blue-600 dark:border-blue-400/60 dark:bg-blue-500/20 dark:text-blue-200' : 'hover:border-blue-300 hover:bg-blue-50 dark:hover:border-blue-400/40 dark:hover:bg-blue-500/10'">
							<input type="checkbox" class="sr-only" :value="tag.id" @change="toggleTag(tag.id)">
							<span x-text="tag.name"></span>
						</label>
					</template>
				</div>
			</section>

			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">操作</h2>
                                <div class="mt-4 space-y-3">
                                        <button type="button" @click="optimizeContent" :disabled="optimizingContent" class="w-full rounded-lg bg-emerald-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-emerald-500 disabled:cursor-not-allowed disabled:bg-slate-300 dark:hover:bg-emerald-500/90 dark:disabled:bg-slate-700/70">
                                                <span x-show="!optimizingContent">AI 全文优化</span>
                                                <span x-show="optimizingContent">优化中…</span>
                                        </button>
                                        <button type="button" @click="generateSummary" :disabled="generatingSummary" class="w-full rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 disabled:cursor-not-allowed disabled:border-slate-200 disabled:text-slate-400 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100 dark:disabled:border-slate-700/70 dark:disabled:text-slate-600">
                                                <span x-show="!generatingSummary">生成 AI 摘要</span>
                                                <span x-show="generatingSummary">生成中…</span>
                                        </button>
                                        <button type="button" @click="previewPost" class="w-full rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">预览文章</button>
                                        <button type="submit" :disabled="loading" class="w-full rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 disabled:cursor-not-allowed disabled:bg-slate-300 dark:hover:bg-blue-500/90 dark:disabled:bg-slate-700/70">
						<span x-show="!loading">{{if .post.ID}}保存修改{{else}}发布文章{{end}}</span>
						<span x-show="loading">保存中...</span>
					</button>
				</div>
			</section>
		</aside>
	</form>
        <div x-show="coverModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4">
                <div class="relative w-full max-w-3xl rounded-2xl bg-white p-6 shadow-2xl transition-colors dark:bg-slate-950">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">裁剪封面</h3>
			<div class="mt-4 flex flex-col gap-4">
				<div class="flex justify-end gap-2 text-xs text-slate-500 dark:text-slate-400">
					<span class="self-center">裁剪比例：</span>
					<button type="button" @click="setAspect('16:9')"
						:class="cropAspect === '16:9' ? 'bg-blue-600 text-white border-blue-600 dark:bg-blue-500/90' : 'border-slate-200 text-slate-600 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800'"
						class="rounded-lg border px-3 py-1.5 transition-colors">16 : 9</button>
					<button type="button" @click="setAspect('3:4')"
						:class="cropAspect === '3:4' ? 'bg-blue-600 text-white border-blue-600 dark:bg-blue-500/90' : 'border-slate-200 text-slate-600 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800'"
						class="rounded-lg border px-3 py-1.5 transition-colors">3 : 4</button>
				</div>
				<div class="max-h-[60vh] overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700">
					<img x-ref="cropperImage" :src="coverSource" alt="裁剪预览" class="max-h-[60vh] w-full object-contain" />
				</div>
			</div>
			<div class="mt-6 flex justify-end gap-3 text-sm">
				<button type="button" class="rounded-lg border border-slate-200 px-4 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100" @click="closeCropper">取消</button>
				<button type="button" class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-500 dark:hover:bg-blue-500/90" @click="confirmCrop">确认裁剪</button>
                        </div>
                </div>
        </div>
        <div x-show="optimizationModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4">
                <div class="relative w-full max-w-5xl rounded-2xl border border-slate-200 bg-white p-6 shadow-2xl transition-colors dark:border-slate-800 dark:bg-slate-950">
                        <div class="flex items-start justify-between gap-4">
                                <div>
                                        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">AI 全文优化预览</h3>
                                        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">左右对照新旧版本，确认后可一键替换。</p>
                                </div>
                                <button type="button" @click="closeOptimizationModal" class="text-slate-400 transition-colors hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
                                        <span class="sr-only">关闭</span>
                                        ✕
                                </button>
                        </div>
                        <template x-if="optimizationUsage">
                                <div class="mt-4 flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
                                        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 dark:bg-slate-800/70">
                                                <span class="text-slate-500 dark:text-slate-400">提示词 Token：</span>
                                                <span x-text="optimizationUsage.prompt_tokens"></span>
                                        </span>
                                        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 dark:bg-slate-800/70">
                                                <span class="text-slate-500 dark:text-slate-400">生成 Token：</span>
                                                <span x-text="optimizationUsage.completion_tokens"></span>
                                        </span>
                                </div>
                        </template>
				<div class="relative mt-4">
					<div x-show="optimizingContent" x-cloak class="absolute inset-0 z-10 flex items-center justify-center rounded-xl border border-dashed border-slate-300 bg-white/80 backdrop-blur-sm dark:border-slate-700 dark:bg-slate-950/80">
						<div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
							<span class="animate-pulse">正在优化全文…</span>
						</div>
					</div>
					<div class="grid gap-4 lg:grid-cols-2">
						<div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-900/70">
							<div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
								<span>当前正文</span>
							</div>
							<div class="mt-3 max-h-[60vh] overflow-y-auto rounded-lg border border-slate-100/80 bg-slate-50/60 px-4 py-3 text-sm leading-6 text-slate-700 dark:border-slate-700/60 dark:bg-slate-900/40 dark:text-slate-200">
								<div class="space-y-4" x-html="optimizationSourceHtml || renderMarkdown(optimizationSource)"></div>
							</div>
						</div>
						<div class="rounded-xl border border-emerald-200 bg-emerald-50/70 p-4 text-sm leading-6 text-slate-700 dark:border-emerald-500/40 dark:bg-emerald-500/10 dark:text-emerald-100">
							<div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide">
								<span>优化提案</span>
							</div>
							<div class="mt-3 max-h-[60vh] overflow-y-auto rounded-lg border border-emerald-200/60 bg-white/70 px-4 py-3 text-sm leading-6 text-slate-700 dark:border-emerald-500/30 dark:bg-slate-900/60 dark:text-emerald-50">
								<div class="space-y-4" x-html="optimizedContentHtml || renderMarkdown(optimizedContent)"></div>
							</div>
						</div>
					</div>
				</div>
                        <div class="mt-6 flex justify-end gap-3 text-sm">
                                <button type="button" @click="closeOptimizationModal" class="rounded-lg border border-slate-200 px-4 py-2 text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">关闭</button>
                                <button type="button" @click="optimizeContent" :disabled="optimizingContent" class="rounded-lg border border-emerald-200 px-4 py-2 font-medium text-emerald-600 transition-colors hover:bg-emerald-50 disabled:cursor-not-allowed disabled:text-slate-400 dark:border-emerald-500/40 dark:text-emerald-300 dark:hover:bg-emerald-500/10">重新生成</button>
                                <button type="button" @click="applyOptimization" class="rounded-lg bg-emerald-600 px-4 py-2 font-medium text-white transition-colors hover:bg-emerald-500 dark:hover:bg-emerald-500/90">替换正文</button>
                        </div>
                </div>
        </div>

        <div x-show="summaryModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4">
                <div class="w-full max-w-xl rounded-2xl border border-slate-200 bg-white p-6 shadow-2xl transition-colors dark:border-slate-800 dark:bg-slate-950">
                        <div class="flex items-start justify-between gap-4">
                                <div>
                                        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">AI 摘要预览</h3>
                                        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">请确认是否替换当前摘要。</p>
                                </div>
                                <button type="button" @click="closeSummaryModal" class="text-slate-400 transition-colors hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
                                        <span class="sr-only">关闭</span>
                                        ✕
                                </button>
                        </div>
                        <div class="mt-4 space-y-4">
                                <div class="rounded-xl border border-slate-200 bg-slate-50/70 p-4 text-sm leading-6 text-slate-700 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-200">
                                        <pre class="max-h-72 overflow-y-auto whitespace-pre-wrap break-words font-sans" x-text="summaryPreview"></pre>
                                </div>
                                <template x-if="summaryUsage">
                                        <div class="flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
                                                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 dark:bg-slate-800/70">
                                                        <span class="text-slate-500 dark:text-slate-400">提示词 Token：</span>
                                                        <span x-text="summaryUsage.prompt_tokens"></span>
                                                </span>
                                                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 dark:bg-slate-800/70">
                                                        <span class="text-slate-500 dark:text-slate-400">生成 Token：</span>
                                                        <span x-text="summaryUsage.completion_tokens"></span>
                                                </span>
                                        </div>
                                </template>
                        </div>
                        <div class="mt-6 flex justify-end gap-3 text-sm">
                                <button type="button" @click="closeSummaryModal" class="rounded-lg border border-slate-200 px-4 py-2 text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">暂不替换</button>
                                <button type="button" @click="applySummary" class="rounded-lg bg-blue-600 px-4 py-2 font-medium text-white transition-colors hover:bg-blue-500 dark:hover:bg-blue-500/90">确认替换</button>
                        </div>
                </div>
        </div>
</div>

<script>
	function postForm() {
		return {
			loading: false,
			editor: null,
			allTags: [],
			initialTagIds: '{{- range $index, $tag := .post.Tags -}}{{if $index}},{{end}}{{ $tag.ID }}{{- end -}}',
			postId: '{{if .post.ID}}{{.post.ID}}{{else}}new{{end}}',
			post: {
				title: '{{.post.Title}}' || '',
				summary: '{{.post.Summary}}' || '',
				content: '{{.post.Content}}' || '',
				status: '{{if .post.Status}}{{.post.Status}}{{else}}draft{{end}}',
				tagIds: []
			},
			cover: {
				url: '{{with .post}}{{.CoverURL}}{{end}}' || '',
				width: {{with .post}}{{if gt .CoverWidth 0}}{{.CoverWidth}}{{else}}0{{end}}{{else}}0{{end}},
				height: {{with .post}}{{if gt .CoverHeight 0}}{{.CoverHeight}}{{else}}0{{end}}{{else}}0{{end}}
			},
			coverSource: '',
                        coverModal: false,
                        cropper: null,
                        cropAspect: '16:9',
                        generatingSummary: false,
                        optimizingContent: false,
                        summaryModal: false,
                        summaryPreview: '',
                        summaryUsage: null,
			optimizationModal: false,
			optimizationSource: '',
			optimizationSourceHtml: '',
			optimizedContent: '',
			optimizedContentHtml: '',
			optimizationUsage: null,

                        init() {
                                this.applyInitialTagSelection();
				this.initializeEditor();
				this.fetchTags();
			},

			applyInitialTagSelection() {
				if (!this.initialTagIds) {
					return;
				}
				this.post.tagIds = this.initialTagIds.split(',').map(id => id.trim()).filter(Boolean);
			},

			fetchTags() {
				fetch('/admin/api/tags')
					.then(response => response.json())
					.then(data => {
						this.allTags = data.tags || [];
						if (this.post.tagIds.length === 0) {
							return;
						}
						const available = new Set(this.allTags.map(tag => tag.id.toString()));
						this.post.tagIds = this.post.tagIds.filter(id => available.has(id.toString()));
					})
					.catch(() => {
						this.allTags = [];
					});
			},

			toggleTag(id) {
				const value = id.toString();
				if (this.post.tagIds.includes(value)) {
					this.post.tagIds = this.post.tagIds.filter(tagId => tagId !== value);
				} else {
					this.post.tagIds.push(value);
				}
			},

			handleCoverFile(event) {
				const input = event.target;
				const [file] = input.files || [];
				if (!file) {
					return;
				}
                                if (typeof window.Cropper === 'undefined') {
                                        window.AdminUI.toast({ message: '封面裁剪模块尚未加载，请刷新页面后重试', type: 'error' });
					return;
				}
				this.resetCropper();
				this.coverSource = URL.createObjectURL(file);
				this.coverModal = true;
				this.initCropperWhenReady();
				input.value = '';
			},

			reCropCover() {
				if (!this.cover.url) {
					return;
				}
				try {
					const url = new URL(this.cover.url, window.location.origin);
                                        if (url.origin !== window.location.origin) {
                                                window.AdminUI.toast({ message: '该封面来自外部链接，请重新上传新的封面图片', type: 'warning' });
						return;
					}
				} catch (error) {
					return;
				}
                                if (typeof window.Cropper === 'undefined') {
                                        window.AdminUI.toast({ message: '封面裁剪模块尚未加载，请刷新页面后重试', type: 'error' });
					return;
				}
				if (this.cover.width > 0 && this.cover.height > 0) {
					this.cropAspect = this.cover.width >= this.cover.height ? '16:9' : '3:4';
				}
				this.resetCropper();
				this.coverSource = this.cover.url;
				this.coverModal = true;
				this.initCropperWhenReady();
			},

			confirmCrop() {
				if (!this.cropper) {
					return;
				}
				this.cropper.getCroppedCanvas().toBlob(blob => {
					if (!blob) {
						return;
					}
					const formData = new FormData();
					formData.append('image', blob, `cover-${Date.now()}.png`);
					fetch('/admin/api/upload/image', {
						method: 'POST',
						body: formData
					})
						.then(response => response.json())
						.then(data => {
							if (data.success === 1) {
								this.cover.url = data.data.url;
								this.cover.width = data.data.width || 0;
								this.cover.height = data.data.height || 0;
                                                        } else {
                                                                window.AdminUI.toast({ message: data.error || data.message || '封面上传失败', type: 'error' });
							}
						})
                                                .catch(() => {
                                                        window.AdminUI.toast({ message: '封面上传失败，请稍后重试', type: 'error' });
						})
						.finally(() => {
							this.closeCropper();
						});
				}, 'image/png');
			},

			closeCropper() {
				this.resetCropper();
				if (this.coverSource && this.coverSource.startsWith('blob:')) {
					URL.revokeObjectURL(this.coverSource);
				}
				this.coverModal = false;
				this.coverSource = '';
			},

			removeCover() {
				this.cover = { url: '', width: 0, height: 0 };
			},

			setAspect(ratio) {
				this.cropAspect = ratio;
				if (this.cropper) {
					this.cropper.setAspectRatio(this.aspectValue());
					this.adjustCropBox();
				}
			},

			aspectValue() {
				return this.cropAspect === '3:4' ? 3 / 4 : 16 / 9;
			},

			resetCropper() {
				if (this.cropper) {
					this.cropper.destroy();
					this.cropper = null;
				}
			},

			initCropperWhenReady() {
				this.$nextTick(() => {
					const image = this.$refs.cropperImage;
					if (!image) {
						return;
					}
					const create = () => {
						this.resetCropper();
						this.cropper = new Cropper(image, {
							viewMode: 1,
							dragMode: 'move',
							autoCropArea: 0.85,
							background: true,
							responsive: true,
							movable: true,
							zoomable: true,
							minCropBoxWidth: 240,
							minCropBoxHeight: 240,
							aspectRatio: this.aspectValue(),
							ready: () => {
								this.adjustCropBox();
							},
						});
					};
					if (image.complete) {
						create();
					} else {
						image.addEventListener('load', create, { once: true });
					}
				});
			},

			adjustCropBox() {
				if (!this.cropper) {
					return;
				}
				const container = this.cropper.getContainerData();
				const ratio = this.aspectValue();
				let width = container.width * 0.8;
				let height = width / ratio;
				if (height > container.height) {
					height = container.height * 0.8;
					width = height * ratio;
				}
				this.cropper.setCropBoxData({
					left: (container.width - width) / 2,
					top: (container.height - height) / 2,
					width,
					height,
				});
			},

			initializeEditor() {
				if (this.editor) {
					return;
				}
				const easyMDE = new EasyMDE({
					element: document.getElementById('content'),
					spellChecker: false,
					status: ['lines', 'words', 'cursor'],
					toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', {
						name: 'image',
						action: EasyMDE.drawImage,
						className: 'fa fa-picture-o',
						title: '插入图片'
					}, 'table', 'code', '|', 'preview', 'side-by-side', 'fullscreen'],
					autosave: { enabled: true, uniqueId: `post-content-${this.postId}`, delay: 1000 },
					uploadImage: true,
					imageUploadEndpoint: '/admin/api/upload/image',
					imagePathAbsolute: true,
					imageAccept: 'image/png, image/jpeg, image/gif, image/webp',
					imageMaxSize: 5 * 1024 * 1024,
					imageUploadFunction(file, onSuccess, onError) {
						const formData = new FormData();
						formData.append('image', file);
						fetch('/admin/api/upload/image', { method: 'POST', body: formData })
							.then(response => response.json())
							.then(data => {
								if (data.success === 1) {
									onSuccess(data.data.url);
								} else {
									onError(data.message || '上传失败');
								}
							})
							.catch(error => {
								onError('上传失败: ' + error.message);
							});
					},
					renderingConfig: { codeSyntaxHighlighting: false },
					initialValue: this.post.content
				});

				easyMDE.codemirror.on('change', () => {
					this.post.content = easyMDE.value();
				});

				this.editor = easyMDE;
			},

			submitForm() {
				this.loading = true;
				if (this.editor) {
					this.post.content = this.editor.value();
				}
                                if (!this.cover.url || this.cover.width <= 0 || this.cover.height <= 0) {
                                        window.AdminUI.toast({ message: '请上传并裁剪文章封面', type: 'warning' });
					this.loading = false;
					return;
				}
				const payload = {
					title: this.post.title,
					summary: this.post.summary,
					content: this.post.content,
					status: this.post.status,
					tag_ids: this.post.tagIds.map(id => Number(id)).filter(id => !Number.isNaN(id)),
					cover_url: this.cover.url,
					cover_width: this.cover.width,
					cover_height: this.cover.height
				};

				let url = '/admin/api/posts';
				let method = 'POST';
				if (window.location.pathname.includes('/edit')) {
					const parts = window.location.pathname.split('/');
					const postId = parts[parts.length - 2];
					url = `/admin/api/posts/${postId}`;
					method = 'PUT';
				}

                fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                })
                        .then(response => response.json())
                        .then(data => {
                                if (data.post && typeof data.post.summary === 'string') {
                                        this.post.summary = data.post.summary;
                                }
                                if (Array.isArray(data.notices)) {
                                        data.notices.forEach(message => {
                                                window.AdminUI.toast({ message, type: 'info' });
                                        });
                                }
                                if (Array.isArray(data.warnings)) {
                                        data.warnings.forEach(message => {
                                                window.AdminUI.toast({ message, type: 'warning' });
                                        });
                                }
                                if (data.message) {
                                        if (this.editor && this.editor.clearAutosavedValue) {
                                                this.editor.clearAutosavedValue();
                                        }
                                        window.AdminUI.toast({ message: data.message, type: 'success' });
                                                        if (!window.location.pathname.includes('/edit')) {
                                                                window.location.href = '/admin/posts';
                                                        }
                                                }
                                        })
                                        .catch(() => {
                                                window.AdminUI.toast({ message: '保存失败，请稍后重试', type: 'error' });
					})
					.finally(() => {
						this.loading = false;
					});
			},

                        previewPost() {
                                const preview = window.open('', '_blank');
                                const parsed = this.editor ? this.editor.markdown(this.post.content) : this.post.content;
                                preview.document.write(`
					<html>
					<head>
						<title>预览: ${this.post.title}</title>
                                                <link rel="stylesheet" href="/static/dist/assets/input.css">
                                                <link rel="stylesheet" href="/static/dist/assets/admin.css">
						<style>
							:root { color-scheme: light dark; }
							body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 780px; margin: 0 auto; padding: 2rem; color: #1f2937; background: #ffffff; transition: color 0.2s ease, background 0.2s ease; }
							h1, h2, h3, h4 { margin-top: 1.5rem; margin-bottom: 0.75rem; }
							p { margin: 1rem 0; line-height: 1.7; }
							code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
							pre { background: #0f172a; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
							img { max-width: 100%; border-radius: 0.5rem; }
							@media (prefers-color-scheme: dark) {
								body { color: #e2e8f0; background: #020617; }
								code { background: rgba(148, 163, 184, 0.12); color: #e2e8f0; }
							}
						</style>
                                                <script>window.hljs = window.hljs || (window.opener && window.opener.hljs);</script>
					</head>
					<body>
						<h1>${this.post.title}</h1>
						<div>${parsed}</div>
                                                <script>
                                                        const highlight = window.hljs || (window.opener && window.opener.hljs);
                                                        if (highlight) {
                                                                document.querySelectorAll('pre code').forEach(block => highlight.highlightElement(block));
                                                        }
                                                </script>
					</body>
					</html>
                                `);
                                preview.document.close();
                        },

                        optimizeContent() {
                                if (this.optimizingContent) {
                                        return;
                                }
                                const title = (this.post.title || '').trim();
                                const sourceContent = this.editor ? this.editor.value() : this.post.content;
                                const trimmedContent = (sourceContent || '').trim();
                                if (!trimmedContent) {
                                        window.AdminUI.toast({ message: '请先填写文章正文再尝试全文优化', type: 'warning' });
                                        return;
                                }
				this.post.content = sourceContent;
				this.optimizationSource = sourceContent;
				this.optimizationSourceHtml = this.renderMarkdown(sourceContent);
				this.optimizedContent = '';
				this.optimizedContentHtml = '';
				this.optimizationUsage = null;
				this.optimizingContent = true;
				fetch('/admin/api/posts/optimize', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, content: trimmedContent })
                                })
                                        .then(async response => {
                                                const data = await response.json();
                                                if (!response.ok) {
                                                        const message = data.error || data.message || '全文优化失败，请稍后重试';
                                                        throw new Error(message);
						}
						const optimized = (data.optimized_content || '').trim();
						if (!optimized) {
							throw new Error('AI 全文优化未返回内容，请稍后重试');
						}
						this.optimizedContent = optimized;
						this.optimizedContentHtml = this.renderMarkdown(optimized);
						this.optimizationUsage = data.usage || null;
						this.optimizationModal = true;
					})
                                        .catch(error => {
                                                window.AdminUI.toast({ message: error.message || '全文优化失败，请稍后重试', type: 'error' });
                                        })
                                        .finally(() => {
                                                this.optimizingContent = false;
                                        });
                        },

                        closeOptimizationModal() {
                                this.optimizationModal = false;
                        },

			applyOptimization() {
				if (!this.optimizedContent) {
					this.closeOptimizationModal();
					return;
				}
				this.post.content = this.optimizedContent;
				if (this.editor) {
					this.editor.value(this.optimizedContent);
				}
				window.AdminUI.toast({ message: '已替换为优化后的正文', type: 'success' });
				this.closeOptimizationModal();
			},

			renderMarkdown(content) {
				const value = (content || '').trim();
				if (!value) {
					return '<p class="text-xs text-slate-400 dark:text-slate-500">暂无内容</p>';
				}
				if (this.editor && typeof this.editor.markdown === 'function') {
					return this.editor.markdown(value);
				}
				if (window.EasyMDE && typeof window.EasyMDE.prototype.markdown === 'function') {
					return window.EasyMDE.prototype.markdown(value);
				}
				return value
					.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;')
					.replace(/\n/g, '<br>');
			},

			generateSummary() {
				if (this.generatingSummary) {
					return;
				}
                                const title = (this.post.title || '').trim();
                                const content = this.editor ? this.editor.value() : this.post.content;
                                const trimmedContent = (content || '').trim();
                                if (!title && !trimmedContent) {
                                        window.AdminUI.toast({ message: '请先填写文章标题或正文内容再尝试生成摘要', type: 'warning' });
                                        return;
                                }
                                this.post.content = content;
                                this.summaryModal = false;
                                this.summaryPreview = '';
                                this.summaryUsage = null;
                                this.generatingSummary = true;
                                fetch('/admin/api/posts/summary', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ title, content: trimmedContent })
                                })
                                        .then(async response => {
                                                const data = await response.json();
                                                if (!response.ok) {
                                                        const message = data.error || data.message || '生成摘要失败，请稍后重试';
                                                        throw new Error(message);
                                                }
                                                const summary = (data.summary || '').trim();
                                                if (!summary) {
                                                        throw new Error('AI 摘要服务未返回内容，请稍后重试');
                                                }
                                                this.summaryPreview = summary;
                                                this.summaryUsage = data.usage || null;
                                                this.summaryModal = true;
                                        })
                                        .catch(error => {
                                                window.AdminUI.toast({ message: error.message || '生成摘要失败，请稍后重试', type: 'error' });
                                        })
                                        .finally(() => {
                                                this.generatingSummary = false;
                                        });
                        },

                        closeSummaryModal() {
                                this.summaryModal = false;
                        },

                        applySummary() {
                                if (!this.summaryPreview) {
                                        this.closeSummaryModal();
                                        return;
                                }
                                this.post.summary = this.summaryPreview;
                                this.closeSummaryModal();
                                window.AdminUI.toast({ message: '已使用最新生成的摘要', type: 'success' });
                        }
                };
        }
</script>
{{end}}
