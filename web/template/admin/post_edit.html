{{template "base" .}}

{{define "content"}}
<div class="space-y-10" x-data="postForm()" x-init="init()">
	<header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
		<div>
			<h1 class="text-3xl font-semibold text-slate-900 dark:text-slate-100">{{if .post.ID}}编辑文章{{else}}创建新文章{{end}}</h1>
			<p class="mt-2 text-sm text-slate-500 dark:text-slate-400">支持 Markdown 编辑与图片上传。</p>
		</div>
		<a href="/admin/posts" class="inline-flex items-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">返回列表</a>
	</header>

	<form id="post-form" @submit.prevent="saveDraft()" class="grid gap-6 lg:grid-cols-[2fr,1fr]">
		<section class="space-y-6">
			<label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<span class="text-sm font-medium text-slate-700 dark:text-slate-200">文章标题<span class="ml-1 text-rose-500">*</span></span>
                                <input type="text" x-model="post.title" @input="markDirty()" placeholder="请输入文章标题" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:placeholder-slate-500 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30" required>
			</label>

			<label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<span class="text-sm font-medium text-slate-700 dark:text-slate-200">文章摘要</span>
                                <textarea x-model="post.summary" @input="markDirty()" rows="4" placeholder="简要描述文章的核心观点" class="w-full resize-none rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:placeholder-slate-500 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30"></textarea>
			</label>

			<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
                                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                                        <div>
                                                <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">文章封面<span class="ml-2 rounded-full bg-slate-100 px-2 py-0.5 text-[11px] font-medium text-slate-500 dark:bg-slate-800/70 dark:text-slate-400">发布前必填</span></h2>
                                                <p class="text-xs text-slate-500 dark:text-slate-400">支持横图或竖图，建议尺寸 ≥ 1200px，上传后可裁剪。</p>
                                        </div>
					<label class="inline-flex cursor-pointer items-center gap-2 rounded-lg border border-slate-300 px-4 py-2 text-xs font-medium text-slate-600 transition-colors hover:border-blue-300 hover:bg-blue-50 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:border-blue-400/60 dark:hover:bg-blue-500/10 dark:hover:text-slate-100">
						<input type="file" accept="image/*" class="hidden" @change="handleCoverFile($event)">
						<span>选择图片</span>
					</label>
				</div>
				<div class="rounded-xl border border-dashed border-slate-300 bg-slate-50/60 p-4 transition-colors dark:border-slate-600 dark:bg-slate-900/60" x-show="cover.url" x-cloak>
					<div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
						<div class="flex items-center gap-4">
							<img :src="cover.url" alt="封面预览" class="h-28 w-28 rounded-lg object-cover" />
							<div class="space-y-2 text-xs text-slate-600 dark:text-slate-300">
								<p class="font-medium text-slate-800 dark:text-slate-200">当前封面</p>
								<p>尺寸：<span x-text="cover.width"></span> × <span x-text="cover.height"></span> px</p>
								<p class="text-[11px] text-slate-400 dark:text-slate-500">保存后首页将根据比例自动排版。</p>
							</div>
						</div>
						<div class="flex gap-3 text-xs">
							<button type="button" @click="reCropCover()" class="rounded-lg border border-slate-200 px-3 py-1.5 font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">重新裁剪</button>
							<button type="button" @click="removeCover()" class="rounded-lg border border-rose-200 px-3 py-1.5 font-medium text-rose-600 transition-colors hover:bg-rose-50 dark:border-rose-500/50 dark:text-rose-300 dark:hover:bg-rose-500/10">移除</button>
						</div>
					</div>
				</div>
			</section>

			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<label class="flex flex-col gap-2">
					<span class="text-sm font-medium text-slate-700 dark:text-slate-200">文章内容<span class="ml-1 text-rose-500">*</span></span>
					<textarea id="content" rows="18" x-model="post.content" class="hidden"></textarea>
				</label>
			</section>
		</section>

		<aside class="space-y-6">
			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">标签</h2>
				<p class="mt-2 text-xs text-slate-500 dark:text-slate-400">最多选择 5 个标签，帮助读者快速理解主题。</p>
				<div class="mt-4 flex flex-wrap gap-2">
					<template x-for="tag in allTags" :key="tag.id">
						<label class="inline-flex items-center gap-2 rounded-full border border-slate-300 px-3 py-1 text-xs font-medium text-slate-600 transition-colors dark:border-slate-700 dark:text-slate-300" :class="post.tagIds.includes(tag.id.toString()) ? 'border-blue-500 bg-blue-50 text-blue-600 dark:border-blue-400/60 dark:bg-blue-500/20 dark:text-blue-200' : 'hover:border-blue-300 hover:bg-blue-50 dark:hover:border-blue-400/40 dark:hover:bg-blue-500/10'">
							<input type="checkbox" class="sr-only" :value="tag.id" @change="toggleTag(tag.id)">
							<span x-text="tag.name"></span>
						</label>
					</template>
				</div>
			</section>

			<section class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<div class="flex items-center justify-between">
					<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">操作</h2>
					<span class="hidden rounded-full bg-slate-100 px-3 py-1 text-[10px] font-medium uppercase tracking-wide text-slate-500 dark:bg-slate-800/70 dark:text-slate-400 lg:inline-flex">写作助手</span>
				</div>
				<div class="mt-4 space-y-5">
					<div class="rounded-xl border border-slate-200 bg-slate-50/80 p-4 text-xs text-slate-500 shadow-inner shadow-slate-200/60 transition-colors dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-400 dark:shadow-none">
						<div class="flex items-center justify-between text-sm font-medium text-slate-600 dark:text-slate-200">
							<span>当前状态</span>
							<span x-text="post.status === 'published' ? '已发布' : '草稿'"></span>
						</div>
						<template x-if="latestPublication.publishedAt">
							<div class="mt-2 flex items-center justify-between text-xs text-slate-500 dark:text-slate-400">
								<span>最近发布</span>
								<span x-text="latestPublication.publishedAt"></span>
							</div>
						</template>
						<template x-if="latestPublication.version > 1">
							<div class="mt-1 text-right text-xs text-slate-400 dark:text-slate-500">版本 v<span x-text="latestPublication.version"></span></div>
						</template>
					</div>

					<div class="space-y-5">
						<div>
							<div class="flex items-center justify-between text-[11px] font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
								<span>智能助手</span>
								<span class="font-medium text-emerald-500 dark:text-emerald-300">AI</span>
							</div>
							<p class="mt-1 text-xs text-slate-400 dark:text-slate-500">利用 AI 调整全文和摘要，结果不会自动生效。</p>
							<div class="mt-3 space-y-2">
								<button type="button" @click="optimizeContent()" :disabled="optimizingContent" class="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-emerald-500 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition-all hover:bg-emerald-500/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-500 disabled:cursor-not-allowed disabled:bg-emerald-300 disabled:text-emerald-100 disabled:shadow-none dark:bg-emerald-500/90 dark:hover:bg-emerald-400 dark:disabled:bg-emerald-700/70 dark:disabled:text-emerald-200/80">
									<svg class="h-4 w-4 text-emerald-100 transition-colors group-hover:text-white dark:text-emerald-200" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 3v2.25M19.5 12H21M3 12h2.25M16.95 7.05l1.59-1.59M5.46 18.54l1.59-1.59M7.05 7.05 5.46 5.46M18.54 18.54l-1.59-1.59M12 8.25a3.75 3.75 0 1 0 0 7.5 3.75 3.75 0 0 0 0-7.5Z" />
									</svg>
									<span x-show="!optimizingContent">AI 全文优化</span>
									<span x-show="optimizingContent">优化中…</span>
								</button>
								<button type="button" @click="generateSummary()" :disabled="generatingSummary" class="group inline-flex w-full items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-medium text-slate-600 shadow-sm transition-all hover:border-blue-300 hover:bg-blue-50 hover:text-blue-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-200 disabled:cursor-not-allowed disabled:border-slate-200 disabled:text-slate-400 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-300 dark:hover:border-blue-400/60 dark:hover:bg-blue-500/10 dark:hover:text-blue-100 dark:disabled:border-slate-700/60 dark:disabled:text-slate-600">
									<svg class="h-4 w-4 text-slate-400 transition-colors group-hover:text-blue-600 dark:text-slate-500 dark:group-hover:text-blue-200" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 4h8m-8 4h8m-4 8h4m-6 0h.01M4 6.75c0-1.406 0-2.11.436-2.612A2 2 0 0 1 5.75 3.702C6.252 3.266 6.956 3.266 8.362 3.266h7.276c1.406 0 2.11 0 2.612.436a2 2 0 0 1 .314.436c.436.502.436 1.206.436 2.612v10.5c0 1.406 0 2.11-.436 2.612a2 2 0 0 1-.314.436c-.502.436-1.206.436-2.612.436H8.362c-1.406 0-2.11 0-2.612-.436a2 2 0 0 1-.314-.436c-.436-.502-.436-1.206-.436-2.612V6.75Z" />
									</svg>
									<span x-show="!generatingSummary">生成 AI 摘要</span>
									<span x-show="generatingSummary">生成中…</span>
								</button>
							</div>
						</div>

						<div class="border-t border-slate-100 pt-4 dark:border-slate-800/80">
                                                        <div class="text-[11px] font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">发布流程</div>
                                                        <p class="mt-1 text-xs text-slate-400 dark:text-slate-500">预览与发布前请确认封面、标签及摘要信息。</p>
                                                        <div class="mt-3 rounded-xl border border-dashed border-slate-200 bg-slate-50/70 p-3 text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-400">
                                                                <div class="flex items-center justify-between text-[11px] font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
                                                                        <span>自动保存</span>
                                                                        <span>每 30 秒</span>
                                                                </div>
                                                                <div class="mt-2 space-y-1 text-xs">
                                                                        <p class="flex items-center gap-2" x-show="autoSaving" x-transition>
                                                                                <span class="flex h-2 w-2 animate-ping rounded-full bg-blue-500/70"></span>
                                                                                <span class="text-blue-600 dark:text-blue-300">自动保存中...</span>
                                                                        </p>
                                                                        <p class="text-slate-500 dark:text-slate-400" x-show="!autoSaving && lastAutoSavedAt" x-transition>
                                                                                最近自动保存：<span x-text="formatDateTime(lastAutoSavedAt)"></span>
                                                                        </p>
                                                                        <p class="text-slate-400 dark:text-slate-500" x-show="!autoSaving && !lastAutoSavedAt" x-transition>
                                                                                草稿内容将自动保存，无需手动提交。
                                                                        </p>
                                                                        <p class="text-rose-500 dark:text-rose-400" x-show="autoSaveError" x-text="autoSaveError" x-transition></p>
                                                                </div>
                                                        </div>
                                                        <div class="mt-3 space-y-2">
								<button type="button" @click="previewPost()" class="group inline-flex w-full items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-medium text-slate-600 shadow-sm transition-all hover:border-indigo-300 hover:bg-indigo-50 hover:text-indigo-700 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-200 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-300 dark:hover:border-indigo-400/60 dark:hover:bg-indigo-500/10 dark:hover:text-indigo-100">
									<svg class="h-4 w-4 text-slate-400 transition-colors group-hover:text-indigo-600 dark:text-slate-500 dark:group-hover:text-indigo-200" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M2.25 12s3.75-6.75 9.75-6.75S21.75 12 21.75 12s-3.75 6.75-9.75 6.75S2.25 12 2.25 12Z" />
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15.375a3.375 3.375 0 1 0 0-6.75 3.375 3.375 0 0 0 0 6.75Z" />
									</svg>
									<span>预览文章</span>
								</button>
								<button type="button" @click="publishPost()" :disabled="publishing || loading" class="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-indigo-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition-all hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-500 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-100 disabled:shadow-none dark:hover:bg-indigo-500/90 dark:disabled:bg-slate-700/70 dark:disabled:text-slate-400">
									<svg class="h-4 w-4 text-indigo-100 transition-colors group-hover:text-white dark:text-indigo-200" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m5.25 14.25 6-9 6 9M4.5 15h15" />
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 5.25V21" />
									</svg>
									<span x-show="!publishing" x-text="post.status === 'published' ? '更新发布' : '发布上线'"></span>
									<span x-show="publishing">发布中...</span>
								</button>
								<button type="submit" :disabled="loading" class="group inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition-all hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-500 disabled:cursor-not-allowed disabled:bg-slate-300 disabled:text-slate-100 disabled:shadow-none dark:hover:bg-blue-500/90 dark:disabled:bg-slate-700/70 dark:disabled:text-slate-400">
									<svg class="h-4 w-4 text-blue-100 transition-colors group-hover:text-white dark:text-blue-200" viewBox="0 0 24 24" fill="none" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16.5 3.75h-9A2.25 2.25 0 0 0 5.25 6v12A2.25 2.25 0 0 0 7.5 20.25h9A2.25 2.25 0 0 0 18.75 18V6A2.25 2.25 0 0 0 16.5 3.75Z" />
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.75 7.5h4.5M9.75 12h4.5m-4.5 4.5h2.25" />
									</svg>
									<span x-show="!loading">{{if .post.ID}}保存修改{{else}}保存草稿{{end}}</span>
									<span x-show="loading">保存中...</span>
								</button>
							</div>
						</div>
					</div>
				</div>
			</section>
		</aside>
	</form>
        <div x-show="coverModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4">
                <div class="relative w-full max-w-3xl rounded-2xl bg-white p-6 shadow-2xl transition-colors dark:bg-slate-950">
                        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">裁剪封面</h3>
			<div class="mt-4 flex flex-col gap-4">
				<div class="flex justify-end gap-2 text-xs text-slate-500 dark:text-slate-400">
					<span class="self-center">裁剪比例：</span>
					<button type="button" @click="setAspect('16:9')"
						:class="cropAspect === '16:9' ? 'bg-blue-600 text-white border-blue-600 dark:bg-blue-500/90' : 'border-slate-200 text-slate-600 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800'"
						class="rounded-lg border px-3 py-1.5 transition-colors">16 : 9</button>
					<button type="button" @click="setAspect('3:4')"
						:class="cropAspect === '3:4' ? 'bg-blue-600 text-white border-blue-600 dark:bg-blue-500/90' : 'border-slate-200 text-slate-600 hover:bg-slate-100 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800'"
						class="rounded-lg border px-3 py-1.5 transition-colors">3 : 4</button>
				</div>
				<div class="max-h-[60vh] overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700">
					<img x-ref="cropperImage" :src="coverSource" alt="裁剪预览" class="max-h-[60vh] w-full object-contain" />
				</div>
			</div>
			<div class="mt-6 flex justify-end gap-3 text-sm">
				<button type="button" class="rounded-lg border border-slate-200 px-4 py-2 text-slate-600 hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100" @click="closeCropper()">取消</button>
				<button type="button" class="rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-500 dark:hover:bg-blue-500/90" @click="confirmCrop()">确认裁剪</button>
                        </div>
                </div>
        </div>
        <div x-show="optimizationModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4">
                <div class="relative w-full max-w-5xl rounded-2xl border border-slate-200 bg-white p-6 shadow-2xl transition-colors dark:border-slate-800 dark:bg-slate-950">
                        <div class="flex items-start justify-between gap-4">
                                <div>
                                        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">AI 全文优化预览</h3>
                                        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">左右对照新旧版本，确认后可一键替换。</p>
                                </div>
                                <button type="button" @click="closeOptimizationModal()" class="text-slate-400 transition-colors hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
                                        <span class="sr-only">关闭</span>
                                        ✕
                                </button>
                        </div>
                        <template x-if="optimizationUsage">
                                <div class="mt-4 flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
                                        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 dark:bg-slate-800/70">
                                                <span class="text-slate-500 dark:text-slate-400">提示词 Token：</span>
                                                <span x-text="optimizationUsage.prompt_tokens"></span>
                                        </span>
                                        <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 dark:bg-slate-800/70">
                                                <span class="text-slate-500 dark:text-slate-400">生成 Token：</span>
                                                <span x-text="optimizationUsage.completion_tokens"></span>
                                        </span>
                                </div>
                        </template>
				<div class="relative mt-4">
					<div x-show="optimizingContent" x-cloak class="absolute inset-0 z-10 flex items-center justify-center rounded-xl border border-dashed border-slate-300 bg-white/80 backdrop-blur-sm dark:border-slate-700 dark:bg-slate-950/80">
						<div class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-300">
							<span class="animate-pulse">正在优化全文…</span>
						</div>
					</div>
					<div class="grid gap-4 lg:grid-cols-2">
						<div class="rounded-xl border border-slate-200 bg-white p-4 dark:border-slate-700 dark:bg-slate-900/70">
							<div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
								<span>当前正文</span>
							</div>
							<div class="mt-3 max-h-[60vh] overflow-y-auto rounded-lg border border-slate-100/80 bg-slate-50/60 px-4 py-3 text-sm leading-6 text-slate-700 dark:border-slate-700/60 dark:bg-slate-900/40 dark:text-slate-200">
								<div class="space-y-4" x-html="optimizationSourceHtml || renderMarkdown(optimizationSource)"></div>
							</div>
						</div>
						<div class="rounded-xl border border-emerald-200 bg-emerald-50/70 p-4 text-sm leading-6 text-slate-700 dark:border-emerald-500/40 dark:bg-emerald-500/10 dark:text-emerald-100">
							<div class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide">
								<span>优化提案</span>
							</div>
							<div class="mt-3 max-h-[60vh] overflow-y-auto rounded-lg border border-emerald-200/60 bg-white/70 px-4 py-3 text-sm leading-6 text-slate-700 dark:border-emerald-500/30 dark:bg-slate-900/60 dark:text-emerald-50">
								<div class="space-y-4" x-html="optimizedContentHtml || renderMarkdown(optimizedContent)"></div>
							</div>
						</div>
					</div>
				</div>
                        <div class="mt-6 flex justify-end gap-3 text-sm">
                                <button type="button" @click="closeOptimizationModal()" class="rounded-lg border border-slate-200 px-4 py-2 text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">关闭</button>
                                <button type="button" @click="optimizeContent()" :disabled="optimizingContent" class="rounded-lg border border-emerald-200 px-4 py-2 font-medium text-emerald-600 transition-colors hover:bg-emerald-50 disabled:cursor-not-allowed disabled:text-slate-400 dark:border-emerald-500/40 dark:text-emerald-300 dark:hover:bg-emerald-500/10">重新生成</button>
                                <button type="button" @click="applyOptimization()" class="rounded-lg bg-emerald-600 px-4 py-2 font-medium text-white transition-colors hover:bg-emerald-500 dark:hover:bg-emerald-500/90">替换正文</button>
                        </div>
                </div>
        </div>

        <div x-show="summaryModal" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 px-4">
                <div class="w-full max-w-xl rounded-2xl border border-slate-200 bg-white p-6 shadow-2xl transition-colors dark:border-slate-800 dark:bg-slate-950">
                        <div class="flex items-start justify-between gap-4">
                                <div>
                                        <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">AI 摘要预览</h3>
                                        <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">请确认是否替换当前摘要。</p>
                                </div>
                                <button type="button" @click="closeSummaryModal()" class="text-slate-400 transition-colors hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300">
                                        <span class="sr-only">关闭</span>
                                        ✕
                                </button>
                        </div>
                        <div class="mt-4 space-y-4">
                                <div class="rounded-xl border border-slate-200 bg-slate-50/70 p-4 text-sm leading-6 text-slate-700 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-200">
                                        <pre class="max-h-72 overflow-y-auto whitespace-pre-wrap break-words font-sans" x-text="summaryPreview"></pre>
                                </div>
                                <template x-if="summaryUsage">
                                        <div class="flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
                                                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 dark:bg-slate-800/70">
                                                        <span class="text-slate-500 dark:text-slate-400">提示词 Token：</span>
                                                        <span x-text="summaryUsage.prompt_tokens"></span>
                                                </span>
                                                <span class="inline-flex items-center gap-1 rounded-full bg-slate-100 px-3 py-1 dark:bg-slate-800/70">
                                                        <span class="text-slate-500 dark:text-slate-400">生成 Token：</span>
                                                        <span x-text="summaryUsage.completion_tokens"></span>
                                                </span>
                                        </div>
                                </template>
                        </div>
                        <div class="mt-6 flex justify-end gap-3 text-sm">
                                <button type="button" @click="closeSummaryModal()" class="rounded-lg border border-slate-200 px-4 py-2 text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">暂不替换</button>
                                <button type="button" @click="applySummary()" class="rounded-lg bg-blue-600 px-4 py-2 font-medium text-white transition-colors hover:bg-blue-500 dark:hover:bg-blue-500/90">确认替换</button>
                        </div>
                </div>
        </div>
</div>

<script>
    function postForm() {
            const initialData = {{toJSON (dict "post" .post "latestPublication" .latestPublication)}} || {};
            const postData = initialData.post || {};
            const latestPublicationData = initialData.latestPublication || {};
            const initialTagIds = Array.isArray(postData.Tags)
                    ? postData.Tags.map(tag => {
                                    if (!tag) {
                                            return '';
                                    }
                                    const identifier = tag.ID ?? tag.id;
                                    return identifier !== undefined && identifier !== null ? String(identifier) : '';
                            })
                            .filter(Boolean)
                    : [];

            return {
                    loading: false,
                    autoSaving: false,
                    autoSavePending: false,
                    autoSaveError: '',
                    autoSaveIntervalId: null,
                    lastAutoSavedAt: null,
                    autoSaveRevision: 0,
                    visibilityHandler: null,
                    unloadHandler: null,
                    editor: null,
                    allTags: [],
                    initialTagIds,
                    postId: postData.ID !== undefined && postData.ID !== null ? String(postData.ID) : 'new',
                    post: {
                            title: postData.Title || '',
                            summary: postData.Summary || '',
                            content: postData.Content || '',
                            status: typeof postData.Status === 'string' && postData.Status ? postData.Status : 'draft',
                            tagIds: [...initialTagIds]
                    },
                    publishing: false,
                    latestPublication: {
                            id: latestPublicationData.ID !== undefined && latestPublicationData.ID !== null
                                    ? String(latestPublicationData.ID)
                                    : '',
                            version:
                                    typeof latestPublicationData.Version === 'number'
                                            ? latestPublicationData.Version
                                            : typeof latestPublicationData.version === 'number'
                                            ? latestPublicationData.version
                                            : 0,
                            publishedAt: '',
                            publishedAtRaw:
                                    latestPublicationData.PublishedAt ||
                                    latestPublicationData.published_at ||
                                    ''
                    },
                    cover: {
                            url: postData.CoverURL || '',
                            width:
                                    typeof postData.CoverWidth === 'number' && postData.CoverWidth > 0
                                            ? postData.CoverWidth
                                            : 0,
                            height:
                                    typeof postData.CoverHeight === 'number' && postData.CoverHeight > 0
                                            ? postData.CoverHeight
                                            : 0
                    },
			coverSource: '',
                        coverModal: false,
                        cropper: null,
                        cropAspect: '16:9',
                        generatingSummary: false,
                        optimizingContent: false,
                        summaryModal: false,
                        summaryPreview: '',
                        summaryUsage: null,
			optimizationModal: false,
			optimizationSource: '',
			optimizationSourceHtml: '',
			optimizedContent: '',
			optimizedContentHtml: '',
			optimizationUsage: null,
			shortcutHandler: null,

                        init() {
                                this.applyInitialTagSelection();
                                this.initializeEditor();
                                this.fetchTags();
                                if (this.postId && this.postId !== 'new') {
                                        this.postId = this.postId.toString();
                                }
                                if (this.latestPublication.publishedAtRaw) {
                                        this.latestPublication.publishedAt = this.formatDateTime(this.latestPublication.publishedAtRaw);
                                }
                                this.bindKeyboardShortcuts();
                                this.initAutoSaveLifecycle();
                        },

			bindKeyboardShortcuts() {
				if (this.shortcutHandler) {
					return;
				}
				this.shortcutHandler = event => {
					if (!(event.ctrlKey || event.metaKey)) {
						return;
					}
					const key = typeof event.key === 'string' ? event.key.toLowerCase() : '';
					if (key !== 's') {
						return;
					}
					event.preventDefault();
					if (this.loading || this.autoSaving || this.publishing) {
						return;
					}
					this.saveDraft();
				};
				window.addEventListener('keydown', this.shortcutHandler);
			},

			unbindKeyboardShortcuts() {
				if (!this.shortcutHandler) {
					return;
				}
				window.removeEventListener('keydown', this.shortcutHandler);
				this.shortcutHandler = null;
			},

                        applyInitialTagSelection() {
                                if (!Array.isArray(this.initialTagIds) || this.initialTagIds.length === 0) {
                                        return;
                                }
                                this.post.tagIds = [...this.initialTagIds];
                        },

			fetchTags() {
				fetch('/admin/api/tags')
					.then(response => response.json())
					.then(data => {
						this.allTags = data.tags || [];
						if (this.post.tagIds.length === 0) {
							return;
						}
						const available = new Set(this.allTags.map(tag => tag.id.toString()));
						this.post.tagIds = this.post.tagIds.filter(id => available.has(id.toString()));
					})
					.catch(() => {
						this.allTags = [];
					});
			},

                        toggleTag(id) {
                                const value = id.toString();
                                if (this.post.tagIds.includes(value)) {
                                        this.post.tagIds = this.post.tagIds.filter(tagId => tagId !== value);
                                } else {
                                        this.post.tagIds.push(value);
                                }
                                this.markDirty();
                        },

                        markDirty() {
                                this.autoSaveRevision += 1;
                                this.autoSavePending = true;
                                this.autoSaveError = '';
                        },

                        initAutoSaveLifecycle() {
                                this.startAutoSaveTimer();
                                if (!this.visibilityHandler) {
                                        this.visibilityHandler = () => {
                                                if (document.visibilityState === 'hidden') {
                                                        this.autoSaveIfNeeded();
                                                }
                                        };
                                        document.addEventListener('visibilitychange', this.visibilityHandler);
                                }
                                if (!this.unloadHandler) {
                                        this.unloadHandler = () => {
                                                this.autoSaveIfNeeded();
                                                this.stopAutoSaveTimer();
						this.unbindKeyboardShortcuts();
                                        };
                                        window.addEventListener('pagehide', this.unloadHandler);
                                        window.addEventListener('beforeunload', this.unloadHandler);
                                }
                        },

                        startAutoSaveTimer() {
                                this.stopAutoSaveTimer();
                                this.autoSaveIntervalId = window.setInterval(() => {
                                        this.autoSaveIfNeeded();
                                }, 30000);
                        },

                        stopAutoSaveTimer() {
                                if (this.autoSaveIntervalId) {
                                        clearInterval(this.autoSaveIntervalId);
                                        this.autoSaveIntervalId = null;
                                }
                        },

                        async autoSaveIfNeeded() {
                                if (this.autoSaving || this.loading || this.publishing) {
                                        return;
                                }
                                if (!this.autoSavePending) {
                                        return;
                                }
                                if (this.editor) {
                                        const editorValue = this.editor.value();
                                        if (editorValue !== this.post.content) {
                                                this.post.content = editorValue;
                                        }
                                }
                                const hasMeaningfulContent =
                                        (this.post.title && this.post.title.trim()) ||
                                        (this.post.summary && this.post.summary.trim()) ||
                                        (this.post.content && this.post.content.trim());
                                if (!hasMeaningfulContent && this.postId === 'new') {
                                        return;
                                }
                                this.autoSaving = true;
                                try {
                                        const saved = await this.saveDraft({
                                                redirectOnCreate: false,
                                                silent: true,
                                                notifyOnSilent: false,
                                                useLoadingState: false
                                        });
                                        if (!saved && !this.autoSaveError) {
                                                this.autoSaveError = '自动保存失败，请稍后重试';
                                        }
                                } finally {
                                        this.autoSaving = false;
                                }
                        },

			handleCoverFile(event) {
				const input = event.target;
				const [file] = input.files || [];
				if (!file) {
					return;
				}
                                if (typeof window.Cropper === 'undefined') {
                                        window.AdminUI.toast({ message: '封面裁剪模块尚未加载，请刷新页面后重试', type: 'error' });
					return;
				}
				this.resetCropper();
				this.coverSource = URL.createObjectURL(file);
				this.coverModal = true;
				this.initCropperWhenReady();
				input.value = '';
			},

			reCropCover() {
				if (!this.cover.url) {
					return;
				}
				try {
					const url = new URL(this.cover.url, window.location.origin);
                                        if (url.origin !== window.location.origin) {
                                                window.AdminUI.toast({ message: '该封面来自外部链接，请重新上传新的封面图片', type: 'warning' });
						return;
					}
				} catch (error) {
					return;
				}
                                if (typeof window.Cropper === 'undefined') {
                                        window.AdminUI.toast({ message: '封面裁剪模块尚未加载，请刷新页面后重试', type: 'error' });
					return;
				}
				if (this.cover.width > 0 && this.cover.height > 0) {
					this.cropAspect = this.cover.width >= this.cover.height ? '16:9' : '3:4';
				}
				this.resetCropper();
				this.coverSource = this.cover.url;
				this.coverModal = true;
				this.initCropperWhenReady();
			},

			confirmCrop() {
				if (!this.cropper) {
					return;
				}
				this.cropper.getCroppedCanvas().toBlob(blob => {
					if (!blob) {
						return;
					}
					const formData = new FormData();
					formData.append('image', blob, `cover-${Date.now()}.png`);
					fetch('/admin/api/upload/image', {
						method: 'POST',
						body: formData
					})
						.then(response => response.json())
						.then(data => {
                                                        if (data.success === 1) {
                                                                this.cover.url = data.data.url;
                                                                this.cover.width = data.data.width || 0;
                                                                this.cover.height = data.data.height || 0;
                                                                this.markDirty();
                                                        } else {
                                                                window.AdminUI.toast({ message: data.error || data.message || '封面上传失败', type: 'error' });
							}
						})
                                                .catch(() => {
                                                        window.AdminUI.toast({ message: '封面上传失败，请稍后重试', type: 'error' });
						})
						.finally(() => {
							this.closeCropper();
						});
				}, 'image/png');
			},

			closeCropper() {
				this.resetCropper();
				if (this.coverSource && this.coverSource.startsWith('blob:')) {
					URL.revokeObjectURL(this.coverSource);
				}
				this.coverModal = false;
				this.coverSource = '';
			},

                        removeCover() {
                                this.cover = { url: '', width: 0, height: 0 };
                                this.markDirty();
                        },

			setAspect(ratio) {
				this.cropAspect = ratio;
				if (this.cropper) {
					this.cropper.setAspectRatio(this.aspectValue());
					this.adjustCropBox();
				}
			},

			aspectValue() {
				return this.cropAspect === '3:4' ? 3 / 4 : 16 / 9;
			},

			resetCropper() {
				if (this.cropper) {
					this.cropper.destroy();
					this.cropper = null;
				}
			},

			initCropperWhenReady() {
				this.$nextTick(() => {
					const image = this.$refs.cropperImage;
					if (!image) {
						return;
					}
					const create = () => {
						this.resetCropper();
						this.cropper = new Cropper(image, {
							viewMode: 1,
							dragMode: 'move',
							autoCropArea: 0.85,
							background: true,
							responsive: true,
							movable: true,
							zoomable: true,
							minCropBoxWidth: 240,
							minCropBoxHeight: 240,
							aspectRatio: this.aspectValue(),
							ready: () => {
								this.adjustCropBox();
							},
						});
					};
					if (image.complete) {
						create();
					} else {
						image.addEventListener('load', create, { once: true });
					}
				});
			},

			adjustCropBox() {
				if (!this.cropper) {
					return;
				}
				const container = this.cropper.getContainerData();
				const ratio = this.aspectValue();
				let width = container.width * 0.8;
				let height = width / ratio;
				if (height > container.height) {
					height = container.height * 0.8;
					width = height * ratio;
				}
				this.cropper.setCropBoxData({
					left: (container.width - width) / 2,
					top: (container.height - height) / 2,
					width,
					height,
				});
			},

			initializeEditor() {
				if (this.editor) {
					return;
				}
				const easyMDE = new EasyMDE({
					element: document.getElementById('content'),
					spellChecker: false,
					status: ['lines', 'words', 'cursor'],
					toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'unordered-list', 'ordered-list', '|', 'link', {
						name: 'image',
						action: EasyMDE.drawImage,
						className: 'fa fa-picture-o',
						title: '插入图片'
					}, 'table', 'code', '|', 'preview', 'side-by-side', 'fullscreen'],
					autosave: { enabled: true, uniqueId: `post-content-${this.postId}`, delay: 1000 },
					uploadImage: true,
					imageUploadEndpoint: '/admin/api/upload/image',
					imagePathAbsolute: true,
					imageAccept: 'image/png, image/jpeg, image/gif, image/webp',
					imageMaxSize: 5 * 1024 * 1024,
					imageUploadFunction(file, onSuccess, onError) {
						const formData = new FormData();
						formData.append('image', file);
						fetch('/admin/api/upload/image', { method: 'POST', body: formData })
							.then(response => response.json())
							.then(data => {
								if (data.success === 1) {
									onSuccess(data.data.url);
								} else {
									onError(data.message || '上传失败');
								}
							})
							.catch(error => {
								onError('上传失败: ' + error.message);
							});
					},
					renderingConfig: { codeSyntaxHighlighting: false },
					initialValue: this.post.content
				});

                                easyMDE.codemirror.on('change', () => {
                                        this.post.content = easyMDE.value();
                                        this.markDirty();
                                });

				this.editor = easyMDE;
			},

                        async saveDraft(options = {}) {
                                const {
                                        redirectOnCreate = true,
                                        silent = false,
                                        notifyOnSilent = false,
                                        useLoadingState = true
                                } = options;
                                if (this.loading) {
                                        return false;
                                }
                                const shouldToggleLoading = useLoadingState;
                                if (shouldToggleLoading) {
                                        this.loading = true;
                                }
                                if (this.editor) {
                                        this.post.content = this.editor.value();
                                }
                                const revisionAtStart = this.autoSaveRevision;
                                const payload = {
                                        title: this.post.title,
                                        summary: this.post.summary,
                                        content: this.post.content,
                                        tag_ids: this.post.tagIds.map(id => Number(id)).filter(id => !Number.isNaN(id)),
                                        cover_url: this.cover.url || '',
                                        cover_width: this.cover.width || 0,
                                        cover_height: this.cover.height || 0
                                };

                                let previousAutosaveId = null;
                                if (this.editor && this.editor.options && this.editor.options.autosave) {
                                        previousAutosaveId = this.editor.options.autosave.uniqueId;
                                }

                                let url = '/admin/api/posts';
                                let method = 'POST';
                                if (this.postId !== 'new') {
                                        url = `/admin/api/posts/${this.postId}`;
                                        method = 'PUT';
                                }

                                try {
                                        const response = await fetch(url, {
                                                method,
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(payload)
                                        });
                                        const data = await response.json();
                                        if (!response.ok) {
                                                const message = data.error || data.message || '保存失败，请稍后重试';
                                                if (silent && !notifyOnSilent) {
                                                        this.autoSaveError = message;
                                                } else {
                                                        window.AdminUI.toast({ message, type: 'error' });
                                                }
                                                return false;
                                        }

                                        if (data.post) {
                                                if (typeof data.post.ID !== 'undefined' && data.post.ID !== null) {
                                                        this.postId = data.post.ID.toString();
                                                }
                                                if (typeof data.post.summary === 'string') {
                                                        this.post.summary = data.post.summary;
                                                }
                                                if (typeof data.post.Status === 'string') {
                                                        this.post.status = data.post.Status;
                                                }
                                                if (typeof data.post.CoverURL === 'string' && data.post.CoverURL !== this.cover.url) {
                                                        this.cover.url = data.post.CoverURL;
                                                }
                                                if (typeof data.post.CoverWidth === 'number' && data.post.CoverWidth !== this.cover.width) {
                                                        this.cover.width = data.post.CoverWidth;
                                                }
                                                if (typeof data.post.CoverHeight === 'number' && data.post.CoverHeight !== this.cover.height) {
                                                        this.cover.height = data.post.CoverHeight;
                                                }
                                        }

                                        if (this.editor && typeof this.editor.clearAutosavedValue === 'function') {
                                                this.editor.clearAutosavedValue();
                                        }
                                        if (this.editor && this.editor.options && this.editor.options.autosave && this.postId !== 'new') {
                                                const autosave = this.editor.options.autosave;
                                                const newId = `post-content-${this.postId}`;
                                                if (previousAutosaveId && previousAutosaveId !== newId) {
                                                        try {
                                                                window.localStorage.removeItem(`smde_${previousAutosaveId}`);
                                                        } catch (_) {}
                                                }
                                                autosave.uniqueId = newId;
                                        }

                                        const shouldNotify = !silent || notifyOnSilent;
                                        if (shouldNotify && Array.isArray(data.notices)) {
                                                data.notices.forEach(message => {
                                                        window.AdminUI.toast({ message, type: 'info' });
                                                });
                                        }
                                        if (shouldNotify && Array.isArray(data.warnings)) {
                                                data.warnings.forEach(message => {
                                                        window.AdminUI.toast({ message, type: 'warning' });
                                                });
                                        }

                                        if (!silent && data.message) {
                                                window.AdminUI.toast({ message: data.message, type: 'success' });
                                        }

                                        if (this.autoSaveRevision === revisionAtStart) {
                                                this.autoSavePending = false;
                                        }
                                        this.lastAutoSavedAt = new Date();
                                        this.autoSaveError = '';

                                        if (this.postId !== 'new' && !window.location.pathname.includes('/edit')) {
                                                if (redirectOnCreate) {
                                                        window.location.href = `/admin/posts/${this.postId}/edit`;
                                                } else {
                                                        window.history.replaceState({}, '', `/admin/posts/${this.postId}/edit`);
                                                }
                                        }

                                        return true;
                                } catch (error) {
                                        const message = error.message || '保存失败，请稍后重试';
                                        if (silent && !notifyOnSilent) {
                                                this.autoSaveError = message;
                                        } else {
                                                window.AdminUI.toast({ message, type: 'error' });
                                        }
                                        return false;
                                } finally {
                                        if (shouldToggleLoading) {
                                                this.loading = false;
                                        }
                                }
                        },

			async publishPost() {
				if (this.publishing) {
					return;
				}
				if (!this.cover.url || this.cover.width <= 0 || this.cover.height <= 0) {
					window.AdminUI.toast({ message: '请上传并裁剪文章封面', type: 'warning' });
					return;
				}

                                const saved = await this.saveDraft({ redirectOnCreate: false, silent: true, notifyOnSilent: true });
				if (!saved) {
					return;
				}

				if (this.postId === 'new') {
					window.AdminUI.toast({ message: '草稿未正确保存，请刷新后重试', type: 'warning' });
					return;
				}

				if (!window.location.pathname.includes('/edit')) {
					window.history.replaceState({}, '', `/admin/posts/${this.postId}/edit`);
				}

				this.publishing = true;
				try {
					const response = await fetch(`/admin/api/posts/${this.postId}/publish`, { method: 'POST' });
					const data = await response.json();
					if (!response.ok) {
						const message = data.error || data.message || '发布失败，请稍后重试';
						window.AdminUI.toast({ message, type: 'error' });
						return;
					}

					if (data.post) {
						if (typeof data.post.Status === 'string') {
							this.post.status = data.post.Status;
						} else {
							this.post.status = 'published';
						}
						if (typeof data.post.Summary === 'string') {
							this.post.summary = data.post.Summary;
						}
					} else {
						this.post.status = 'published';
					}

					if (data.publication) {
						const publishedAtValue = data.publication.PublishedAt || data.publication.published_at || '';
						this.latestPublication = {
							id: data.publication.ID || data.publication.id || this.latestPublication.id || '',
							version: data.publication.Version || data.publication.version || this.latestPublication.version || 1,
							publishedAtRaw: publishedAtValue || this.latestPublication.publishedAtRaw || '',
							publishedAt: publishedAtValue ? this.formatDateTime(publishedAtValue) : (this.latestPublication.publishedAt || ''),
						};
					}

					if (Array.isArray(data.notices)) {
						data.notices.forEach(message => {
							window.AdminUI.toast({ message, type: 'info' });
						});
					}
					if (Array.isArray(data.warnings)) {
						data.warnings.forEach(message => {
							window.AdminUI.toast({ message, type: 'warning' });
						});
					}

					window.AdminUI.toast({ message: data.message || '文章发布成功', type: 'success' });
				} catch (error) {
					window.AdminUI.toast({ message: error.message || '发布失败，请稍后重试', type: 'error' });
				} finally {
					this.publishing = false;
				}
			},

                        previewPost() {
                                const preview = window.open('', '_blank');
                                const parsed = this.editor ? this.editor.markdown(this.post.content) : this.post.content;
                                preview.document.write(`
					<html>
					<head>
						<title>预览: ${this.post.title}</title>
                                                <link rel="stylesheet" href="/static/dist/assets/input.css">
                                                <link rel="stylesheet" href="/static/dist/assets/admin.css">
						<style>
							:root { color-scheme: light dark; }
							body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 780px; margin: 0 auto; padding: 2rem; color: #1f2937; background: #ffffff; transition: color 0.2s ease, background 0.2s ease; }
							h1, h2, h3, h4 { margin-top: 1.5rem; margin-bottom: 0.75rem; }
							p { margin: 1rem 0; line-height: 1.7; }
							code { background: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; }
							pre { background: #0f172a; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
							img { max-width: 100%; border-radius: 0.5rem; }
							@media (prefers-color-scheme: dark) {
								body { color: #e2e8f0; background: #020617; }
								code { background: rgba(148, 163, 184, 0.12); color: #e2e8f0; }
							}
						</style>
                                                <script>window.hljs = window.hljs || (window.opener && window.opener.hljs);</script>
					</head>
					<body>
						<h1>${this.post.title}</h1>
						<div>${parsed}</div>
                                                <script>
                                                        const highlight = window.hljs || (window.opener && window.opener.hljs);
                                                        if (highlight) {
                                                                document.querySelectorAll('pre code').forEach(block => highlight.highlightElement(block));
                                                        }
                                                </script>
					</body>
					</html>
                                `);
                                preview.document.close();
                        },

                        optimizeContent() {
                                if (this.optimizingContent) {
                                        return;
                                }
                                const title = (this.post.title || '').trim();
                                const sourceContent = this.editor ? this.editor.value() : this.post.content;
                                const trimmedContent = (sourceContent || '').trim();
                                if (!trimmedContent) {
                                        window.AdminUI.toast({ message: '请先填写文章正文再尝试全文优化', type: 'warning' });
                                        return;
                                }
				this.post.content = sourceContent;
				this.optimizationSource = sourceContent;
				this.optimizationSourceHtml = this.renderMarkdown(sourceContent);
				this.optimizedContent = '';
				this.optimizedContentHtml = '';
				this.optimizationUsage = null;
				this.optimizingContent = true;
				fetch('/admin/api/posts/optimize', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, content: trimmedContent })
                                })
                                        .then(async response => {
                                                const data = await response.json();
                                                if (!response.ok) {
                                                        const message = data.error || data.message || '全文优化失败，请稍后重试';
                                                        throw new Error(message);
						}
						const optimized = (data.optimized_content || '').trim();
						if (!optimized) {
							throw new Error('AI 全文优化未返回内容，请稍后重试');
						}
						this.optimizedContent = optimized;
						this.optimizedContentHtml = this.renderMarkdown(optimized);
						this.optimizationUsage = data.usage || null;
						this.optimizationModal = true;
					})
                                        .catch(error => {
                                                window.AdminUI.toast({ message: error.message || '全文优化失败，请稍后重试', type: 'error' });
                                        })
                                        .finally(() => {
                                                this.optimizingContent = false;
                                        });
                        },

                        closeOptimizationModal() {
                                this.optimizationModal = false;
                        },

			applyOptimization() {
				if (!this.optimizedContent) {
					this.closeOptimizationModal();
					return;
				}
                                this.post.content = this.optimizedContent;
                                if (this.editor) {
                                        this.editor.value(this.optimizedContent);
                                }
                                this.markDirty();
                                window.AdminUI.toast({ message: '已替换为优化后的正文', type: 'success' });
                                this.closeOptimizationModal();
                        },

			formatDateTime(value) {
				if (!value) {
					return '';
				}
				const date = value instanceof Date ? value : new Date(value);
				if (Number.isNaN(date.getTime())) {
					return '';
				}
				const pad = (num) => String(num).padStart(2, '0');
				return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
			},

			renderMarkdown(content) {
				const value = (content || '').trim();
				if (!value) {
					return '<p class="text-xs text-slate-400 dark:text-slate-500">暂无内容</p>';
				}
				if (this.editor && typeof this.editor.markdown === 'function') {
					return this.editor.markdown(value);
				}
				if (window.EasyMDE && typeof window.EasyMDE.prototype.markdown === 'function') {
					return window.EasyMDE.prototype.markdown(value);
				}
				return value
					.replace(/&/g, '&amp;')
					.replace(/</g, '&lt;')
					.replace(/>/g, '&gt;')
					.replace(/\n/g, '<br>');
			},

			generateSummary() {
				if (this.generatingSummary) {
					return;
				}
                                const title = (this.post.title || '').trim();
                                const content = this.editor ? this.editor.value() : this.post.content;
                                const trimmedContent = (content || '').trim();
                                if (!title && !trimmedContent) {
                                        window.AdminUI.toast({ message: '请先填写文章标题或正文内容再尝试生成摘要', type: 'warning' });
                                        return;
                                }
                                this.post.content = content;
                                this.summaryModal = false;
                                this.summaryPreview = '';
                                this.summaryUsage = null;
                                this.generatingSummary = true;
                                fetch('/admin/api/posts/summary', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ title, content: trimmedContent })
                                })
                                        .then(async response => {
                                                const data = await response.json();
                                                if (!response.ok) {
                                                        const message = data.error || data.message || '生成摘要失败，请稍后重试';
                                                        throw new Error(message);
                                                }
                                                const summary = (data.summary || '').trim();
                                                if (!summary) {
                                                        throw new Error('AI 摘要服务未返回内容，请稍后重试');
                                                }
                                                this.summaryPreview = summary;
                                                this.summaryUsage = data.usage || null;
                                                this.summaryModal = true;
                                        })
                                        .catch(error => {
                                                window.AdminUI.toast({ message: error.message || '生成摘要失败，请稍后重试', type: 'error' });
                                        })
                                        .finally(() => {
                                                this.generatingSummary = false;
                                        });
                        },

                        closeSummaryModal() {
                                this.summaryModal = false;
                        },

                        applySummary() {
                                if (!this.summaryPreview) {
                                        this.closeSummaryModal();
                                        return;
                                }
                                this.post.summary = this.summaryPreview;
                                this.closeSummaryModal();
                                this.markDirty();
                                window.AdminUI.toast({ message: '已使用最新生成的摘要', type: 'success' });
                        }
                };
        }
</script>
{{end}}
