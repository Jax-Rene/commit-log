{{template "base" .}}

{{define "content"}}
<div class="space-y-10" x-data="tagData()">
	<header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm sm:flex-row sm:items-center sm:justify-between">
		<div>
			<h1 class="text-3xl font-semibold text-slate-900">标签管理</h1>
			<p class="mt-2 text-sm text-slate-500">维护清晰的标签体系，帮助读者快速定位主题。</p>
		</div>
		<button type="button" @click="showCreateForm = !showCreateForm" class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500">
			<span x-text="showCreateForm ? '收起表单' : '新建标签'"></span>
		</button>
	</header>

	<section x-show="showCreateForm" x-transition class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
		<h2 class="text-sm font-semibold text-slate-900">添加标签</h2>
		<form @submit.prevent="createTag" class="mt-4 flex flex-col gap-3 sm:flex-row sm:items-center">
			<input type="text" x-model="newTagName" placeholder="例如：Go、架构、产品思考" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100" required>
			<div class="flex gap-3">
				<button type="submit" class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500">保存</button>
				<button type="button" @click="newTagName = ''; showCreateForm = false" class="inline-flex items-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100">取消</button>
			</div>
		</form>
	</section>

	<section class="space-y-4">
		{{if .error}}
		<div class="rounded-2xl border border-rose-200 bg-rose-50 p-6 text-sm text-rose-600">{{.error}}</div>
		{{else if gt (len .tags) 0}}
			{{range .tags}}
			<article class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm" x-data="{ editing: false, name: '{{.Name}}' }">
				<div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
					<div class="space-y-2">
						<div class="flex items-center gap-3">
							<h3 class="text-lg font-medium text-slate-900" x-show="!editing">{{.Name}}</h3>
							<input type="text" x-model="name" x-show="editing" class="w-48 rounded-lg border border-slate-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100">
							<span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-medium text-slate-600">关联 {{len .Posts}} 篇</span>
						</div>
						{{if gt (len .Posts) 0}}
						<p class="text-xs text-slate-500">标签被以下文章使用：</p>
						<ul class="flex flex-wrap gap-2 text-xs text-slate-500">
							{{range .Posts}}
							<li class="rounded-full bg-slate-100 px-2.5 py-0.5">{{.Title}}</li>
							{{end}}
						</ul>
						{{end}}
					</div>
					<div class="flex items-center gap-2 text-xs">
						<button type="button" x-show="!editing" @click="editing = true" class="inline-flex items-center rounded-lg border border-slate-200 px-3 py-1.5 font-medium text-slate-600 transition-colors hover:bg-slate-100">重命名</button>
						<button type="button" x-show="editing" @click="updateTag({{.ID}}, name); editing = false" class="inline-flex items-center rounded-lg border border-blue-200 px-3 py-1.5 font-medium text-blue-600 transition-colors hover:bg-blue-50">保存</button>
						<button type="button" x-show="editing" @click="editing = false; name='{{.Name}}'" class="inline-flex items-center rounded-lg border border-slate-200 px-3 py-1.5 font-medium text-slate-600 transition-colors hover:bg-slate-100">取消</button>
						<button type="button" @click="deleteTag({{.ID}})" class="inline-flex items-center rounded-lg border border-rose-200 px-3 py-1.5 font-medium text-rose-600 transition-colors hover:bg-rose-50">删除</button>
					</div>
				</div>
			</article>
			{{end}}
		{{else}}
		<div class="rounded-2xl border border-dashed border-slate-300 bg-white p-12 text-center text-sm text-slate-500">
			<p>目前还没有标签，点击右上角的“新建标签”开始吧。</p>
			<button type="button" class="mt-4 inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500" @click="showCreateForm = true">创建第一个标签</button>
		</div>
		{{end}}
	</section>
</div>

<script>
	function tagData() {
		return {
			showCreateForm: false,
			newTagName: '',
			createTag() {
				const name = this.newTagName.trim();
				if (!name) {
					alert('请输入标签名称');
					return;
				}
				fetch('/admin/api/tags', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ name })
				})
					.then(response => response.json())
					.then(data => {
						if (data.error) {
							alert('创建失败: ' + data.error);
						} else {
							alert('标签创建成功');
							window.location.reload();
						}
					})
					.catch(() => alert('创建失败，请稍后重试'));
			},
			updateTag(id, newName) {
				const name = (newName || '').trim();
				if (!name) {
					alert('请输入标签名称');
					return;
				}
				fetch(`/admin/api/tags/${id}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ name })
				})
					.then(response => response.json())
					.then(data => {
						if (data.error) {
							alert('更新失败: ' + data.error);
						} else {
							alert('标签更新成功');
							window.location.reload();
						}
					})
					.catch(() => alert('更新失败，请稍后重试'));
			},
			deleteTag(id) {
				if (!confirm('确定要删除这个标签吗？')) {
					return;
				}
				fetch(`/admin/api/tags/${id}`, { method: 'DELETE' })
					.then(response => response.json())
					.then(data => {
						if (data.error) {
							alert('删除失败: ' + data.error);
						} else {
							alert('标签删除成功');
							window.location.reload();
						}
					})
					.catch(() => alert('删除失败，请稍后重试'));
			}
		};
	}
</script>
{{end}}
