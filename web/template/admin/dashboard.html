{{template "base" .}} {{define "content"}}
<div class="space-y-8">
    <section
        class="overflow-hidden rounded-3xl border border-slate-200 bg-gradient-to-br from-slate-900 via-slate-900 to-slate-800 shadow-xl transition-colors dark:border-slate-800 dark:from-slate-900 dark:via-slate-900 dark:to-slate-900"
    >
        <div class="space-y-6 p-8">
            <div
                class="flex flex-col gap-8 lg:flex-row lg:items-center lg:justify-between"
            >
                <div class="space-y-4 text-white">
                    <div
                        class="inline-flex items-center gap-2 rounded-full bg-white/10 px-3 py-1 text-xs font-medium text-slate-100"
                    >
                        <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
                        <span>仪表盘 · 最新概览</span>
                    </div>
                    <div class="space-y-2">
                        <p class="text-sm text-slate-200">
                            欢迎回来，{{if
                            .username}}{{.username}}{{else}}管理员{{end}}
                        </p>
                        <h1 class="text-3xl font-semibold leading-tight">
                            用更现代的后台掌控创作与数据
                        </h1>
                        <p class="max-w-2xl text-sm text-slate-200/80">
                            在这里快速查看站点表现、热门内容与核心入口，让每一次发布都更有把握。
                        </p>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <a
                            href="/admin/posts/new"
                            class="inline-flex items-center gap-2 rounded-xl bg-white px-4 py-2.5 text-sm font-semibold text-slate-900 shadow-lg shadow-slate-900/20 transition-transform duration-150 hover:-translate-y-0.5 hover:shadow-xl"
                        >
                            <span
                                class="inline-flex h-6 w-6 items-center justify-center rounded-lg bg-slate-900 text-xs text-white"
                                >＋</span
                            >
                            <span>开始新文章</span>
                        </a>
                        <a
                            href="/admin/posts"
                            class="inline-flex items-center gap-2 rounded-xl border border-white/20 bg-white/5 px-4 py-2.5 text-sm font-semibold text-white transition-transform duration-150 hover:-translate-y-0.5 hover:border-white/30 hover:bg-white/10"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                class="h-4 w-4 opacity-80"
                            >
                                <path
                                    d="M8 12h8"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                ></path>
                                <path
                                    d="M8 8h8"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                ></path>
                                <path
                                    d="M8 16h5"
                                    stroke-width="1.5"
                                    stroke-linecap="round"
                                ></path>
                                <rect
                                    x="4.75"
                                    y="5.75"
                                    width="14.5"
                                    height="12.5"
                                    rx="2"
                                    stroke-width="1.5"
                                ></rect>
                            </svg>
                            <span>管理内容</span>
                        </a>
                    </div>
                </div>

                <div class="grid w-full max-w-2xl grid-cols-2 gap-4 md:grid-cols-3">
                    <div
                        class="flex flex-col gap-3 rounded-2xl border border-white/10 bg-white/10 p-4 text-white shadow-lg shadow-slate-900/10"
                    >
                        <div
                            class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-200/80"
                        >
                            <span>文章</span>
                            <span
                                class="rounded-full bg-white/15 px-2 py-0.5 text-[11px]"
                                >总计</span
                            >
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-semibold">{{.postCount}}</p>
                            <span class="text-xs text-emerald-200">持续创作</span>
                        </div>
                    </div>
                    <div
                        class="flex flex-col gap-3 rounded-2xl border border-white/10 bg-white/5 p-4 text-white shadow-lg shadow-slate-900/10"
                    >
                        <div
                            class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-200/80"
                        >
                            <span>标签</span>
                            <span
                                class="rounded-full bg-white/15 px-2 py-0.5 text-[11px]"
                                >结构</span
                            >
                        </div>
                        <div class="flex items-end justify-between">
                            <p class="text-3xl font-semibold">{{.tagCount}}</p>
                            <span class="text-xs text-slate-200/80">主题脉络</span>
                        </div>
                    </div>
                    <div
                        class="flex flex-col gap-3 rounded-2xl border border-white/10 bg-slate-900/60 p-4 text-white shadow-lg shadow-slate-900/10 md:col-span-1"
                    >
                        <div
                            class="flex items-center justify-between text-xs font-semibold uppercase tracking-wide text-slate-200/80"
                        >
                            <span>流量</span>
                            <span
                                class="rounded-full bg-emerald-400/20 px-2 py-0.5 text-[11px] text-emerald-100"
                                >实时</span
                            >
                        </div>
                        <div class="space-y-1 text-sm">
                            <div
                                class="flex items-center justify-between text-slate-200"
                            >
                                <span>PV</span>
                                <span class="font-semibold"
                                    >{{.overview.TotalPageViews}}</span
                                >
                            </div>
                            <div
                                class="flex items-center justify-between text-slate-200"
                            >
                                <span>UV</span>
                                <span class="font-semibold"
                                    >{{.overview.TotalUniqueVisitors}}</span
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {{if .latestDraft}}
            <div
                class="rounded-2xl border-white/10 bg-white/5 px-4 py-3 text-xs text-slate-200/80"
            >
                <div class="flex flex-nowrap items-center gap-2">
                    <span
                        class="shrink-0 rounded-full bg-white/10 px-2 py-0.5 text-[11px] font-semibold text-slate-100"
                        >最近草稿</span
                    >
                    <span class="min-w-0 flex-1 truncate text-sm font-semibold text-white">
                        {{if .latestDraft.Title}}{{.latestDraft.Title}}{{else}}未命名草稿{{end}}
                    </span>
                    <span class="shrink-0 text-[11px] text-slate-200/70"
                        title='{{.latestDraft.UpdatedAt.Format "2006-01-02 15:04"}}'
                        >更新于 {{relativeTime .latestDraft.UpdatedAt}}</span
                    >
                    <a
                        href="/admin/posts/continue"
                        class="shrink-0 text-[11px] font-semibold text-white/90 underline decoration-white/40 underline-offset-4 transition hover:decoration-white"
                        >继续编辑</a
                    >
                </div>
            </div>
            {{end}}
        </div>
    </section>

    <section
        class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80"
        x-data="trafficTrend({{toJSON .trend}})"
        x-init="init()"
        x-cloak
    >
        <div
            class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between"
        >
            <div class="space-y-1">
                <div
                    class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600 dark:bg-slate-800 dark:text-slate-200"
                >
                    <span class="h-2 w-2 rounded-full bg-blue-500"></span>
                    <span>流量趋势 · 过去 7 天</span>
                </div>
            </div>
            <div
                class="flex flex-wrap items-center gap-4 text-sm text-slate-600 dark:text-slate-300"
            >
                <div
                    class="flex items-center gap-3 rounded-xl border border-slate-100 bg-slate-50 px-3 py-2 dark:border-slate-800 dark:bg-slate-950/40"
                >
                    <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-blue-500"></span>
                        <span
                            class="font-medium text-slate-700 dark:text-slate-200"
                            >PV</span
                        >
                    </div>
                    <div
                        class="flex items-center gap-3 text-[11px] text-slate-500 dark:text-slate-400"
                    >
                        <span class="inline-flex items-baseline gap-1">
                            <span class="uppercase tracking-wide">Last</span>
                            <span
                                class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                                x-text="formatCount(pvStats.last)"
                                >0</span
                            >
                        </span>
                        <span class="inline-flex items-baseline gap-1">
                            <span class="uppercase tracking-wide">Avg</span>
                            <span
                                class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                                x-text="formatCount(pvStats.avg)"
                                >0</span
                            >
                        </span>
                        <span class="inline-flex items-baseline gap-1">
                            <span class="uppercase tracking-wide">Max</span>
                            <span
                                class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                                x-text="formatCount(pvStats.max)"
                                >0</span
                            >
                        </span>
                    </div>
                </div>
                <div
                    class="flex items-center gap-3 rounded-xl border border-slate-100 bg-slate-50 px-3 py-2 dark:border-slate-800 dark:bg-slate-950/40"
                >
                    <div class="flex items-center gap-2">
                        <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                        <span
                            class="font-medium text-slate-700 dark:text-slate-200"
                            >UV</span
                        >
                    </div>
                    <div
                        class="flex items-center gap-3 text-[11px] text-slate-500 dark:text-slate-400"
                    >
                        <span class="inline-flex items-baseline gap-1">
                            <span class="uppercase tracking-wide">Last</span>
                            <span
                                class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                                x-text="formatCount(uvStats.last)"
                                >0</span
                            >
                        </span>
                        <span class="inline-flex items-baseline gap-1">
                            <span class="uppercase tracking-wide">Avg</span>
                            <span
                                class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                                x-text="formatCount(uvStats.avg)"
                                >0</span
                            >
                        </span>
                        <span class="inline-flex items-baseline gap-1">
                            <span class="uppercase tracking-wide">Max</span>
                            <span
                                class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                                x-text="formatCount(uvStats.max)"
                                >0</span
                            >
                        </span>
                    </div>
                </div>
                <div
                    class="text-xs text-slate-400 dark:text-slate-500"
                    x-text="latestLabel"
                ></div>
            </div>
        </div>

        <div
            class="mt-6 rounded-2xl border border-slate-100 bg-slate-50 p-4 dark:border-slate-800 dark:bg-slate-950/40"
        >
            <template x-if="hasData">
                <div class="space-y-4">
                    <div
                        class="relative h-48 w-full"
                        x-ref="chart"
                        @mousemove="handleMouseMove($event)"
                        @mouseleave="hideTooltip()"
                    >
                        <svg
                            viewBox="0 0 640 200"
                            preserveAspectRatio="none"
                            class="h-full w-full"
                        >
                            <defs>
                                <linearGradient
                                    id="pvGradient"
                                    x1="0"
                                    y1="0"
                                    x2="0"
                                    y2="1"
                                >
                                    <stop
                                        offset="0%"
                                        stop-color="#3b82f6"
                                        stop-opacity="0.25"
                                    ></stop>
                                    <stop
                                        offset="100%"
                                        stop-color="#3b82f6"
                                        stop-opacity="0"
                                    ></stop>
                                </linearGradient>
                                <linearGradient
                                    id="uvGradient"
                                    x1="0"
                                    y1="0"
                                    x2="0"
                                    y2="1"
                                >
                                    <stop
                                        offset="0%"
                                        stop-color="#10b981"
                                        stop-opacity="0.2"
                                    ></stop>
                                    <stop
                                        offset="100%"
                                        stop-color="#10b981"
                                        stop-opacity="0"
                                    ></stop>
                                </linearGradient>
                            </defs>
                            <path
                                :d="areaPath(pv)"
                                fill="url(#pvGradient)"
                            ></path>
                            <path
                                :d="areaPath(uv)"
                                fill="url(#uvGradient)"
                            ></path>
                            <g
                                class="text-slate-200/60 dark:text-slate-700/70"
                                stroke="currentColor"
                                stroke-width="1"
                            >
                                <line
                                    :x1="chart.padding"
                                    :x2="chart.padding"
                                    :y1="chart.padding"
                                    :y2="chart.height - chart.padding"
                                ></line>
                                <line
                                    :x1="chart.padding"
                                    :x2="chart.width - chart.padding"
                                    :y1="chart.height - chart.padding"
                                    :y2="chart.height - chart.padding"
                                ></line>
                            </g>
                            <polyline
                                :points="linePoints(pv)"
                                fill="none"
                                stroke="#3b82f6"
                                stroke-width="3"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            ></polyline>
                            <polyline
                                :points="linePoints(uv)"
                                fill="none"
                                stroke="#10b981"
                                stroke-width="3"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            ></polyline>
                            <template x-if="hoverPoint">
                                <line
                                    :x1="hoverPoint.x"
                                    :x2="hoverPoint.x"
                                    :y1="chart.padding"
                                    :y2="chart.height - chart.padding"
                                    stroke="#94a3b8"
                                    stroke-width="1"
                                    stroke-dasharray="4 4"
                                ></line>
                            </template>
                        </svg>
                        <div class="pointer-events-none absolute inset-0">
                            <template
                                x-for="(point, index) in dotPoints"
                                :key="`dot-${index}`"
                            >
                                <div>
                                    <span
                                        class="absolute -translate-x-1/2 -translate-y-1/2 rounded-full border-2 transition-opacity duration-150"
                                        :class="[
                                            hoverIndex === index
                                                ? 'h-2.5 w-2.5'
                                                : 'h-2 w-2',
                                            hoverIndex === index
                                                ? 'opacity-100'
                                                : 'opacity-0',
                                            point.pv === 0
                                                ? 'bg-blue-500/40 border-blue-200/80'
                                                : 'bg-blue-500 border-white',
                                        ]"
                                        :style="dotStyle(point, 'pv')"
                                    ></span>
                                    <span
                                        class="absolute -translate-x-1/2 -translate-y-1/2 rounded-full border-2 transition-opacity duration-150"
                                        :class="[
                                            hoverIndex === index
                                                ? 'h-2.5 w-2.5'
                                                : 'h-2 w-2',
                                            hoverIndex === index
                                                ? 'opacity-100'
                                                : 'opacity-0',
                                            point.uv === 0
                                                ? 'bg-emerald-500/40 border-emerald-200/80'
                                                : 'bg-emerald-500 border-white',
                                        ]"
                                        :style="dotStyle(point, 'uv')"
                                    ></span>
                                </div>
                            </template>
                        </div>
                        <div class="pointer-events-none absolute inset-0">
                            <template
                                x-for="tick in yAxisTicks"
                                :key="`y-tick-${tick.value}`"
                            >
                                <span
                                    class="absolute -translate-y-1/2 -translate-x-3 whitespace-nowrap text-[10px] text-slate-400 dark:text-slate-500"
                                    :style="yAxisLabelStyle(tick)"
                                    x-text="formatCount(tick.value)"
                                ></span>
                            </template>
                            <template
                                x-for="tick in xAxisTicks"
                                :key="`x-tick-${tick.index}`"
                            >
                                <span
                                    class="absolute -translate-x-1/2 translate-y-2 whitespace-nowrap text-[10px] text-slate-400 dark:text-slate-500"
                                    :style="xAxisLabelStyle(tick)"
                                    x-text="tick.label"
                                ></span>
                            </template>
                        </div>
                        <div
                            x-show="tooltip.visible"
                            x-transition.opacity
                            x-cloak
                            class="pointer-events-none absolute z-10 rounded-xl border border-slate-200 bg-white/95 px-3 py-2 text-xs text-slate-600 shadow-lg backdrop-blur dark:border-slate-700 dark:bg-slate-900/90 dark:text-slate-300"
                            :style="`left: ${tooltip.left}px; top: ${tooltip.top}px; transform: translate(-50%, -110%);`"
                        >
                            <div
                                class="text-[11px] text-slate-400 dark:text-slate-500"
                                x-text="tooltip.date"
                            ></div>
                            <div
                                class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                                x-text="tooltip.time"
                            ></div>
                            <div class="mt-2 flex items-center gap-3 text-xs">
                                <span
                                    class="inline-flex items-center gap-1 text-slate-500 dark:text-slate-300"
                                >
                                    <span
                                        class="h-2 w-2 rounded-full bg-blue-500"
                                    ></span>
                                    <span>PV</span>
                                    <span
                                        class="font-semibold text-slate-900 dark:text-slate-100"
                                        x-text="tooltip.pv"
                                    ></span>
                                </span>
                                <span
                                    class="inline-flex items-center gap-1 text-slate-500 dark:text-slate-300"
                                >
                                    <span
                                        class="h-2 w-2 rounded-full bg-emerald-500"
                                    ></span>
                                    <span>UV</span>
                                    <span
                                        class="font-semibold text-slate-900 dark:text-slate-100"
                                        x-text="tooltip.uv"
                                    ></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
            <template x-if="!hasData">
                <div
                    class="flex flex-col items-center justify-center gap-3 py-10 text-center"
                >
                    <div
                        class="flex h-12 w-12 items-center justify-center rounded-full bg-white text-slate-400 shadow-sm dark:bg-slate-900"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            class="h-5 w-5"
                        >
                            <path
                                d="M5 13.5C6.667 11 8.333 9.75 10 9.5c2.5-.5 3 2 5.5 1.5 1.167-.233 2.333-1.066 3.5-2.5"
                                stroke-width="1.5"
                                stroke-linecap="round"
                            ></path>
                            <path
                                d="M4 4h16v16H4z"
                                stroke-width="1.5"
                                stroke-linejoin="round"
                            ></path>
                        </svg>
                    </div>
                    <div class="space-y-1">
                        <p
                            class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                        >
                            暂无趋势数据
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            开始有访问后，将自动生成小时级趋势图。
                        </p>
                    </div>
                </div>
            </template>
        </div>
    </section>

    <section class="grid gap-6 lg:grid-cols-3">
        <div
            class="space-y-5 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 lg:col-span-2"
        >
            <div class="flex items-center justify-between">
                <div class="space-y-1">
                    <h2
                        class="text-lg font-semibold text-slate-900 dark:text-slate-100"
                    >
                        热门文章
                    </h2>
                </div>
                <a
                    href="/admin/posts"
                    class="text-sm font-medium text-blue-600 transition-colors hover:text-blue-500 dark:text-blue-300 dark:hover:text-blue-200"
                    >查看全部</a
                >
            </div>
            <div class="divide-y divide-slate-100 dark:divide-slate-800">
                {{if gt (len .overview.TopPosts) 0}} {{range
                .overview.TopPosts}}
                <div
                    class="flex flex-col gap-2 py-4 sm:flex-row sm:items-center sm:justify-between"
                >
                    <div class="space-y-1">
                        <p
                            class="text-sm font-medium text-slate-900 dark:text-slate-100"
                        >
                            {{.Title}}
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            PV {{.PageViews}} · UV {{.UniqueVisitors}}
                        </p>
                    </div>
                    <a
                        href="/admin/posts/{{.PostID}}/edit"
                        class="inline-flex items-center gap-2 text-sm font-semibold text-blue-600 transition-colors hover:text-blue-500 dark:text-blue-300 dark:hover:text-blue-200"
                    >
                        编辑
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            class="h-4 w-4"
                        >
                            <path
                                d="M9 6h9"
                                stroke-width="1.5"
                                stroke-linecap="round"
                            ></path>
                            <path
                                d="M6 12h12"
                                stroke-width="1.5"
                                stroke-linecap="round"
                            ></path>
                            <path
                                d="M11 18h7"
                                stroke-width="1.5"
                                stroke-linecap="round"
                            ></path>
                        </svg>
                    </a>
                </div>
                {{end}} {{else}}
                <div
                    class="flex flex-col items-center justify-center gap-3 py-10 text-center"
                >
                    <div
                        class="flex h-12 w-12 items-center justify-center rounded-full bg-slate-100 text-slate-400 dark:bg-slate-800"
                    >
                        <svg
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            class="h-5 w-5"
                        >
                            <path
                                d="M5 12.5C6.667 10 8.333 8.75 10 8.5c2.5-.5 3 2 5.5 1.5 1.167-.233 2.333-1.066 3.5-2.5"
                                stroke-width="1.5"
                                stroke-linecap="round"
                            ></path>
                            <path
                                d="M4 4h16v16H4z"
                                stroke-width="1.5"
                                stroke-linejoin="round"
                            ></path>
                        </svg>
                    </div>
                    <div class="space-y-1">
                        <p
                            class="text-sm font-semibold text-slate-900 dark:text-slate-100"
                        >
                            暂无热门文章数据
                        </p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            发布并积累访问后，会自动出现在这里。
                        </p>
                    </div>
                    <a
                        href="/admin/posts/new"
                        class="inline-flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-xs font-semibold text-white transition-colors hover:bg-blue-500 dark:hover:bg-blue-500/90"
                    >
                        立即创作
                        <span aria-hidden="true">→</span>
                    </a>
                </div>
                {{end}}
            </div>
        </div>

        <div
            class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80"
        >
            <div class="space-y-1">
                <h2
                    class="text-lg font-semibold text-slate-900 dark:text-slate-100"
                >
                    快捷入口
                </h2>
            </div>
            <div class="space-y-3">
                <a
                    href="/admin/system/settings"
                    class="flex items-center justify-between rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-900 transition-colors hover:border-blue-200 hover:bg-blue-50 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100 dark:hover:border-blue-400/40 dark:hover:bg-blue-500/10"
                >
                    <span>站点设置</span>
                    <span class="text-blue-500">→</span>
                </a>
                <a
                    href="/admin/tags"
                    class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3 text-sm font-medium text-slate-900 transition-colors hover:border-blue-200 hover:bg-blue-50 dark:border-slate-700 dark:text-slate-100 dark:hover:border-blue-400/40 dark:hover:bg-blue-500/10"
                >
                    <span>标签管理</span>
                    <span class="text-blue-500">→</span>
                </a>
                <a
                    href="/admin/gallery"
                    class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3 text-sm font-medium text-slate-900 transition-colors hover:border-blue-200 hover:bg-blue-50 dark:border-slate-700 dark:text-slate-100 dark:hover:border-blue-400/40 dark:hover:bg-blue-500/10"
                >
                    <span>摄影作品</span>
                    <span class="text-blue-500">→</span>
                </a>
                <a
                    href="/admin/about"
                    class="flex items-center justify-between rounded-xl border border-slate-200 px-4 py-3 text-sm font-medium text-slate-900 transition-colors hover:border-blue-200 hover:bg-blue-50 dark:border-slate-700 dark:text-slate-100 dark:hover:border-blue-400/40 dark:hover:bg-blue-500/10"
                >
                    <span>About Me</span>
                    <span class="text-blue-500">→</span>
                </a>
            </div>
        </div>
    </section>
</div>
<script src="/static/js/traffic_trend.js"></script>
<script>
    function trafficTrend(points) {
        const entries = Array.isArray(points) ? points : [];
        return {
            points: entries,
            entries: [],
            pv: [],
            uv: [],
            dotPoints: [],
            xAxisTicks: [],
            yAxisTicks: [],
            maxValue: 1,
            dataMax: 0,
            hasData: false,
            latest: { pageViews: 0, uniqueVisitors: 0, hour: null },
            hoverIndex: null,
            helper: null,
            formatters: null,
            tooltip: {
                visible: false,
                left: 0,
                top: 0,
                time: "",
                date: "",
                pv: 0,
                uv: 0,
            },
            chart: { width: 640, height: 200, padding: 20 },
            tooltipSize: { width: 180, height: 72 },
            init() {
                this.helper = window.TrafficTrend || null;
                this.ensureFormatters();

                const normalized = this.points.map((point) => ({
                    hour: point.Hour ? new Date(point.Hour) : null,
                    pageViews: Number(point.PageViews || 0),
                    uniqueVisitors: Number(point.UniqueVisitors || 0),
                }));
                this.entries = normalized;
                this.pv = normalized.map((point) => point.pageViews);
                this.uv = normalized.map((point) => point.uniqueVisitors);
                this.refreshDots();
                this.refreshAxis();
                this.hasData = this.dotPoints.length > 0;
                this.latest = normalized[normalized.length - 1] || this.latest;

                window.addEventListener("resize", () => {
                    if (
                        this.tooltip.visible &&
                        this.hoverIndex !== null &&
                        this.dotPoints[this.hoverIndex]
                    ) {
                        this.updateTooltip(this.dotPoints[this.hoverIndex]);
                    }
                });
            },
            get latestLabel() {
                if (!this.latest.hour) {
                    return "";
                }
                return `${this.formatDate(this.latest.hour)} ${this.formatHour(
                    this.latest.hour,
                )}`;
            },
            get pvStats() {
                return this.computeSeriesStats(this.pv, this.latest.pageViews);
            },
            get uvStats() {
                return this.computeSeriesStats(
                    this.uv,
                    this.latest.uniqueVisitors,
                );
            },
            get hoverPoint() {
                if (this.hoverIndex === null) {
                    return null;
                }
                return this.dotPoints[this.hoverIndex] || null;
            },
            resolveDailyBucketSize() {
                if (!Array.isArray(this.entries) || this.entries.length < 2) {
                    return 24;
                }
                const first = this.entries[0]?.hour;
                const second = this.entries[1]?.hour;
                if (!(first instanceof Date) || !(second instanceof Date)) {
                    return 24;
                }
                const diffMs = Math.abs(second - first);
                const stepHours = Math.round(diffMs / (60 * 60 * 1000)) || 1;
                const bucketSize = Math.round(24 / stepHours);
                return bucketSize > 0 ? bucketSize : 24;
            },
            computeSeriesStats(series, fallback) {
                const values = Array.isArray(series)
                    ? series.map((value) => Number(value) || 0)
                    : [];
                if (!values.length) {
                    const lastValue = Number(fallback) || 0;
                    return { last: lastValue, avg: lastValue, max: lastValue };
                }
                const last = values[values.length - 1] || 0;
                const helper = this.helper;
                if (
                    helper &&
                    typeof helper.computeWindowStats === "function"
                ) {
                    const bucketSize = this.resolveDailyBucketSize();
                    const windowStats = helper.computeWindowStats(
                        values,
                        bucketSize,
                    );
                    return {
                        last,
                        avg: windowStats.avg,
                        max: windowStats.max,
                    };
                }
                const sum = values.reduce((acc, value) => acc + value, 0);
                const avg = sum / values.length;
                const max = Math.max(...values);
                return { last, avg, max };
            },
            formatHour(date) {
                this.ensureFormatters();
                return this.formatters.time.format(date);
            },
            formatDate(date) {
                this.ensureFormatters();
                return this.formatters.date.format(date);
            },
            formatDateTime(date) {
                return `${this.formatDate(date)} ${this.formatHour(date)}`;
            },
            ensureFormatters() {
                if (this.formatters) {
                    return;
                }
                this.formatters = {
                    time: new Intl.DateTimeFormat("zh-CN", {
                        hour: "2-digit",
                        minute: "2-digit",
                    }),
                    date: new Intl.DateTimeFormat("zh-CN", {
                        month: "2-digit",
                        day: "2-digit",
                    }),
                };
            },
            formatCount(value) {
                const num = Number(value) || 0;
                if (num >= 1000) {
                    const scaled = (num / 1000).toFixed(1);
                    return `${scaled.replace(/\.0$/, "")}k`;
                }
                return `${Math.round(num)}`;
            },
            refreshDots() {
                const helper = this.helper;
                if (!helper || typeof helper.computeDotPoints !== "function") {
                    this.dotPoints = [];
                    this.maxValue = 1;
                    return;
                }
                const result = helper.computeDotPoints(
                    this.pv,
                    this.uv,
                    this.chart,
                );
                this.maxValue = result.maxValue;
                this.dotPoints = result.dots;
            },
            refreshAxis() {
                const helper = this.helper;
                this.dataMax = Math.max(0, ...this.pv, ...this.uv);

                if (
                    !helper ||
                    typeof helper.computeYAxisTicks !== "function" ||
                    typeof helper.computeXAxisTicks !== "function"
                ) {
                    this.yAxisTicks = [];
                    this.xAxisTicks = [];
                    return;
                }

                this.yAxisTicks = helper.computeYAxisTicks(
                    this.dataMax,
                    this.chart,
                    this.maxValue,
                );

                const ticks = helper.computeXAxisTicks(
                    this.entries.length,
                    this.chart,
                );
                this.xAxisTicks = ticks.map((tick) => {
                    const entry = this.entries[tick.index] || {};
                    const hour = entry.hour;
                    return {
                        ...tick,
                        label: hour ? this.formatDateTime(hour) : "",
                    };
                });
            },
            positionStyle(x, y) {
                const width = this.chart.width || 1;
                const height = this.chart.height || 1;
                const left = (x / width) * 100;
                const top = (y / height) * 100;
                return `left: ${left}%; top: ${top}%;`;
            },
            dotStyle(point, series) {
                if (!point) {
                    return "";
                }
                const y = series === "uv" ? point.uvY : point.pvY;
                return this.positionStyle(point.x, y);
            },
            xAxisLabelStyle(tick) {
                if (!tick) {
                    return "";
                }
                const y = this.chart.height - this.chart.padding;
                return this.positionStyle(tick.x, y);
            },
            yAxisLabelStyle(tick) {
                if (!tick) {
                    return "";
                }
                return this.positionStyle(this.chart.padding, tick.y);
            },
            handleMouseMove(event) {
                if (!this.dotPoints.length) {
                    return;
                }
                const rect = this.$refs.chart
                    ? this.$refs.chart.getBoundingClientRect()
                    : null;
                if (!rect || rect.width <= 0) {
                    return;
                }
                const helper = this.helper;
                if (!helper || typeof helper.computeHoverIndex !== "function") {
                    return;
                }
                const index = helper.computeHoverIndex(
                    event.clientX - rect.left,
                    this.dotPoints.length,
                    this.chart,
                    { width: rect.width },
                );
                if (index === null) {
                    this.hideTooltip();
                    return;
                }
                if (index === this.hoverIndex && this.tooltip.visible) {
                    return;
                }
                this.showTooltip(index);
            },
            linePoints(series) {
                return this.buildPoints(series, false);
            },
            areaPath(series) {
                return this.buildPoints(series, true);
            },
            buildPoints(series, closed) {
                if (!series.length) {
                    return "";
                }
                const helper = this.helper;
                if (
                    !helper ||
                    typeof helper.computePointX !== "function" ||
                    typeof helper.computeValueY !== "function"
                ) {
                    return "";
                }
                const points = series.map((value, index) => [
                    helper.computePointX(index, series.length, this.chart),
                    helper.computeValueY(value, this.maxValue, this.chart),
                ]);
                if (!closed) {
                    return points.map((point) => point.join(",")).join(" ");
                }
                const first = points[0];
                const last = points[points.length - 1];
                const path = [
                    `M ${first[0]} ${this.chart.height - this.chart.padding}`,
                ];
                points.forEach((point) => {
                    path.push(`L ${point[0]} ${point[1]}`);
                });
                path.push(
                    `L ${last[0]} ${this.chart.height - this.chart.padding}`,
                    "Z",
                );
                return path.join(" ");
            },
            showTooltip(index) {
                const point = this.dotPoints[index];
                if (!point) {
                    return;
                }
                this.hoverIndex = index;
                this.updateTooltip(point);
            },
            updateTooltip(point) {
                const entry = this.entries[point.index] || {};
                const hour = entry.hour;
                this.tooltip.visible = true;
                this.tooltip.pv = point.pv || 0;
                this.tooltip.uv = point.uv || 0;
                this.tooltip.time = hour ? this.formatHour(hour) : "";
                this.tooltip.date = hour ? this.formatDate(hour) : "";

                const rect = this.$refs.chart
                    ? this.$refs.chart.getBoundingClientRect()
                    : null;
                if (!rect) {
                    return;
                }

                const helper = this.helper;
                if (
                    !helper ||
                    typeof helper.computeTooltipPosition !== "function"
                ) {
                    return;
                }
                const position = helper.computeTooltipPosition(
                    point,
                    this.chart,
                    { width: rect.width, height: rect.height },
                    this.tooltipSize,
                );
                this.tooltip.left = position.left;
                this.tooltip.top = position.top;
            },
            hideTooltip() {
                this.hoverIndex = null;
                this.tooltip.visible = false;
            },
        };
    }
</script>
{{end}}
