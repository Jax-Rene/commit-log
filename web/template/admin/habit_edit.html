{{template "base" .}}

{{define "content"}}
<div class="space-y-10" id="habit-form-root" data-habit-id="{{if .habit.ID}}{{.habit.ID}}{{else}}0{{end}}">
	<header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
		<div>
			<h1 class="text-3xl font-semibold text-slate-900 dark:text-slate-100">{{if .habit.ID}}编辑习惯{{else}}创建习惯{{end}}</h1>
			<p class="mt-2 text-sm text-slate-500 dark:text-slate-400">设置目标频率与类型标签，支持自定义起止日期与状态。</p>
		</div>
		<a href="/admin/habits" class="inline-flex items-center rounded-lg border border-slate-200 px-4 py-2 text-sm font-medium text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100">返回列表</a>
	</header>

	<form id="habit-form" class="grid gap-6 lg:grid-cols-[2fr,1fr]">
		<section class="space-y-6">
			<label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<span class="text-sm font-medium text-slate-700 dark:text-slate-200">习惯名称<span class="ml-1 text-rose-500">*</span></span>
				<input type="text" name="name" value="{{.habit.Name}}" placeholder="例如：每天阅读 30 分钟" required class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:placeholder-slate-500 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30" />
			</label>

			<label class="flex flex-col gap-2 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<span class="text-sm font-medium text-slate-700 dark:text-slate-200">习惯描述</span>
				<textarea name="description" rows="4" placeholder="补充习惯背景、期望收益等信息" class="w-full resize-none rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:placeholder-slate-500 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30">{{.habit.Description}}</textarea>
			</label>

			<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
					<div>
						<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">目标频率<span class="ml-1 text-rose-500">*</span></h2>
						<p class="text-xs text-slate-500 dark:text-slate-400">支持每天 / 每周 / 每月自定义次数。</p>
					</div>
					<div class="flex items-center gap-3">
						<label class="inline-flex items-center gap-1 text-xs text-slate-600 dark:text-slate-300">
							<input type="radio" name="frequency_unit" value="daily" {{if eq .habit.FrequencyUnit "daily"}}checked{{end}} {{if not .habit.ID}}checked{{end}} class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-500" />
							<span>每天</span>
						</label>
						<label class="inline-flex items-center gap-1 text-xs text-slate-600 dark:text-slate-300">
							<input type="radio" name="frequency_unit" value="weekly" {{if eq .habit.FrequencyUnit "weekly"}}checked{{end}} class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-500" />
							<span>每周</span>
						</label>
						<label class="inline-flex items-center gap-1 text-xs text-slate-600 dark:text-slate-300">
							<input type="radio" name="frequency_unit" value="monthly" {{if eq .habit.FrequencyUnit "monthly"}}checked{{end}} class="h-3 w-3 border-slate-300 text-blue-600 focus:ring-blue-500" />
							<span>每月</span>
						</label>
					</div>
				</div>

				<label class="flex flex-col gap-2 text-xs text-slate-600 dark:text-slate-300">
					<span>目标次数</span>
					<input type="number" name="frequency_count" min="1" value="{{if gt .habit.FrequencyCount 0}}{{.habit.FrequencyCount}}{{else}}1{{end}}" required class="w-32 rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30" />
				</label>
			</section>

			<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">起止日期（可选）</h2>
				<div class="grid gap-4 sm:grid-cols-2">
                                        <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
                                                <span>开始日期</span>
                                                <input type="text" name="start_date" value="{{with .habit.StartDate}}{{.Format "2006-01-02"}}{{end}}" placeholder="选择开始日期" class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30" data-behavior="date-picker" />
                                        </label>
                                        <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
                                                <span>结束日期</span>
                                                <input type="text" name="end_date" value="{{with .habit.EndDate}}{{.Format "2006-01-02"}}{{end}}" placeholder="选择结束日期" class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30" data-behavior="date-picker" />
                                        </label>
				</div>
			</section>
		</section>

		<aside class="space-y-6">
			<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">类型与状态</h2>
				<label class="flex flex-col gap-2 text-xs text-slate-600 dark:text-slate-300">
					<span>类型标签</span>
					<input type="text" name="type_tag" value="{{.habit.TypeTag}}" placeholder="例如：健康 / 学习" class="rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 placeholder-slate-400 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:placeholder-slate-500 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/30" />
				</label>
				<label class="flex flex-col gap-2 text-xs text-slate-600 dark:text-slate-300">
					<span>当前状态</span>
                                    <select name="status" class="form-select">
						<option value="active" {{if ne .habit.Status "inactive"}}selected{{end}}>启用</option>
						<option value="inactive" {{if eq .habit.Status "inactive"}}selected{{end}}>停用</option>
					</select>
				</label>
			</section>

			<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
				<div id="form-alert" class="hidden rounded-lg border border-rose-200 bg-rose-50/80 p-3 text-xs text-rose-600 dark:border-rose-500/40 dark:bg-rose-500/20 dark:text-rose-200"></div>
				<div class="flex flex-col gap-3">
					<button type="submit" class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 dark:hover:bg-blue-500/90">保存</button>
					{{if .habit.ID}}
					<button type="button" id="delete-habit" class="inline-flex items-center justify-center rounded-lg border border-rose-200 px-4 py-2 text-sm font-medium text-rose-600 transition-colors hover:bg-rose-50 dark:border-rose-500/40 dark:text-rose-300 dark:hover:bg-rose-500/10">删除习惯</button>
					{{end}}
				</div>
			</section>
		</aside>
	</form>
</div>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const root = document.getElementById('habit-form-root');
		if (!root) {
			return;
		}

		const habitId = parseInt(root.dataset.habitId || '0', 10) || null;
                const form = document.getElementById('habit-form');
                const alertBox = document.getElementById('form-alert');
                const deleteButton = document.getElementById('delete-habit');

                initializeDatePickers();

                form.addEventListener('submit', event => {
                        event.preventDefault();
                        const formData = new FormData(form);
			const payload = {
				name: formData.get('name'),
				description: formData.get('description'),
				frequency_unit: formData.get('frequency_unit'),
				frequency_count: Number(formData.get('frequency_count')),
				type_tag: formData.get('type_tag'),
				status: formData.get('status'),
				start_date: formData.get('start_date'),
				end_date: formData.get('end_date'),
			};

			submitHabit(payload)
				.then(() => {
					window.location.href = '/admin/habits';
				})
				.catch(error => {
					displayError(error.message || '保存失败，请稍后重试');
				});
		});

                if (deleteButton && habitId) {
                        deleteButton.addEventListener('click', async () => {
                                const confirmed = await window.AdminUI.confirm({
                                        title: '删除习惯',
                                        message: '确认删除该习惯？操作不可撤销。',
                                        confirmText: '删除',
                                        cancelText: '保留',
                                        tone: 'danger',
                                });
                                if (!confirmed) {
                                        return;
                                }
                                fetch(`/admin/api/habits/${habitId}`, { method: 'DELETE' })
                                        .then(response => response.json())
                                        .then(data => {
                                                if (data.error) {
                                                        throw new Error(data.error);
                                                }
                                                window.location.href = '/admin/habits';
                                        })
                                        .catch(() => {
                                                displayError('删除失败，请稍后重试');
                                        });
                        });
                }

		function submitHabit(payload) {
			const url = habitId ? `/admin/api/habits/${habitId}` : '/admin/api/habits';
			const method = habitId ? 'PUT' : 'POST';

			return fetch(url, {
				method,
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload),
			})
				.then(response => response.json())
				.then(data => {
					if (data.error) {
						throw new Error(data.error);
					}
					return data;
				});
		}

                function displayError(message) {
                        alertBox.textContent = message;
                        alertBox.classList.remove('hidden');
                }

                function initializeDatePickers() {
                        if (!window.flatpickr) {
                                return;
                        }

                        if (window.flatpickr.l10ns && window.flatpickr.l10ns.zh) {
                                window.flatpickr.localize(window.flatpickr.l10ns.zh);
                        }

                        const dateInputs = form.querySelectorAll('input[data-behavior="date-picker"]');
                        dateInputs.forEach(input => {
                                const defaultValue = input.value || null;
                                const instance = window.flatpickr(input, {
                                        allowInput: false,
                                        clickOpens: true,
                                        dateFormat: 'Y-m-d',
                                        defaultDate: defaultValue || undefined,
                                });
                                input.addEventListener('focus', () => instance.open());
                                input.addEventListener('click', () => instance.open());
                        });
                }
        });
</script>
{{end}}
