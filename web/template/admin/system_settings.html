{{template "base" .}}

{{define "content"}}
<div class="space-y-8" x-data="systemSettingsForm()" x-init="init()" x-cloak>
        <section id="basic" class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
                <header class="space-y-1">
                        <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100">基础信息</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">站点名称与 Logo 将出现在前台和后台导航。</p>
                </header>
                <div class="grid grid-cols-1 gap-6">
                        <label class="flex flex-col gap-2">
                                <span class="text-sm font-medium text-slate-700 dark:text-slate-200">站点名称<span class="ml-1 text-rose-500">*</span></span>
                                <input type="text" x-model="form.siteName" class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-500/20" placeholder="例如：CommitLog" />
                                <span class="text-xs text-slate-500 dark:text-slate-400">用于浏览器标题、后台导航等位置。</span>
                        </label>
                        <div class="flex flex-col gap-3">
                                <span class="inline-flex items-center gap-1 text-sm font-medium text-slate-700 dark:text-slate-200">站点 Logo<span class="text-rose-500">*</span></span>
                                <div class="rounded-2xl border border-dashed border-slate-200 p-4 transition-colors dark:border-slate-700/80">
                                        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                                                <div class="flex items-center gap-4">
                                                        <div class="relative flex h-20 w-20 items-center justify-center overflow-hidden rounded-2xl border border-slate-200 bg-slate-50 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
                                                                <template x-if="form.siteLogoUrl">
                                                                        <img :src="form.siteLogoUrl" alt="站点 Logo 预览" class="h-full w-full object-cover" @error="form.siteLogoUrl = ''" />
                                                                </template>
                                                                <template x-if="!form.siteLogoUrl">
                                                                        <span class="text-xs font-medium text-slate-400 dark:text-slate-500">暂无 Logo</span>
                                                                </template>
                                                        </div>
                                                        <div class="max-w-xs space-y-1 text-xs leading-relaxed text-slate-500 dark:text-slate-400">
                                                                <p>上传图片后会同步到后台导航和前台品牌位，推荐使用 1:1 的透明 PNG / SVG。</p>
                                                                <p x-show="form.siteLogoUrl" x-text="form.siteLogoUrl" class="truncate text-[11px] text-slate-400 dark:text-slate-500" x-cloak></p>
                                                        </div>
                                                </div>
                                                <div class="flex flex-wrap items-center gap-2">
                                                        <input type="file" accept="image/*" class="hidden" x-ref="logoInput" @change="handleLogoSelected($event)" />
                                                        <button type="button" class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 transition-colors hover:border-blue-200 hover:text-blue-600 dark:border-slate-700 dark:text-slate-300 dark:hover:border-blue-400/50 dark:hover:text-blue-200" @click="triggerLogoUpload()" :disabled="logoUploading">
                                                                <span x-show="!logoUploading">上传图片</span>
                                                                <span x-show="logoUploading">上传中...</span>
                                                        </button>
                                                        <button type="button" class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-500 transition-colors hover:border-rose-200 hover:text-rose-600 dark:border-slate-700 dark:text-slate-400 dark:hover:border-rose-500/40 dark:hover:text-rose-300" @click="clearLogo()" x-show="form.siteLogoUrl" x-cloak>移除 Logo</button>
                                                </div>
                                        </div>
                                </div>
                        </div>
                </div>
        </section>

        <section id="contacts" class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
                {{template "admin_contact_manager" .}}
        </section>

        <section id="openai" class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
                <header class="space-y-1">
                        <h2 class="text-lg font-semibold text-slate-900 dark:text-slate-100">OpenAI 集成</h2>
                        <p class="text-sm text-slate-500 dark:text-slate-400">保存有效的 OpenAI API Key，以便后续功能调用。可先测试连通性。</p>
                </header>
                <div class="flex flex-col gap-3 lg:flex-row lg:items-center">
                        <div class="flex-1">
                                <label class="flex flex-col gap-2">
                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">OpenAI API Key</span>
                                        <div class="flex items-center gap-2">
                                                <input :type="showApiKey ? 'text' : 'password'" x-model="form.openaiApiKey" class="w-full rounded-xl border border-slate-200 px-4 py-2.5 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-500/20" placeholder="sk-..." autocomplete="off" />
                                                <button type="button" @click="showApiKey = !showApiKey" class="whitespace-nowrap rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 transition-colors hover:border-blue-200 hover:text-blue-600 dark:border-slate-700 dark:text-slate-300 dark:hover:border-blue-400/50 dark:hover:text-blue-200"><span x-text="showApiKey ? '隐藏' : '显示'"></span></button>
                                        </div>
                                        <span class="text-xs text-slate-500 dark:text-slate-400">系统将以密文方式保存，可随时替换或清空。</span>
                                </label>
                        </div>
                        <div class="flex gap-2">
                                <button type="button" class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 transition-colors hover:border-blue-200 hover:text-blue-600 dark:border-slate-700 dark:text-slate-300 dark:hover:border-blue-400/50 dark:hover:text-blue-200" @click="testOpenAI()" :disabled="openaiTesting">
                                        <span x-show="!openaiTesting">测试连通性</span>
                                        <span x-show="openaiTesting">测试中...</span>
                                </button>
                                <button type="button" class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-500 transition-colors hover:border-rose-200 hover:text-rose-600 dark:border-slate-700 dark:text-slate-400 dark:hover:border-rose-500/40 dark:hover:text-rose-300" @click="form.openaiApiKey = ''" x-show="form.openaiApiKey" x-cloak>清空</button>
                        </div>
                </div>
        </section>

        <section class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
                <div class="space-y-1">
                        <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">保存设置</h2>
                        <p class="text-xs text-slate-500 dark:text-slate-400">点击按钮将当前表单内容写入数据库。</p>
                </div>
                <button type="button" @click="submit()" :disabled="loading" class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 disabled:cursor-not-allowed disabled:bg-slate-300 dark:hover:bg-blue-500/90 dark:disabled:bg-slate-700/80">
                        <span x-show="!loading">保存设置</span>
                        <span x-show="loading">保存中...</span>
                </button>
        </section>
</div>

<script>
        function systemSettingsForm() {
                return {
                        loading: false,
                        showApiKey: false,
                        logoUploading: false,
                        openaiTesting: false,
                        form: {
                                siteName: '',
                                siteLogoUrl: '',
                                openaiApiKey: '',
                        },
                        init() {
                                this.fetchSettings();
                                this.scrollToHash();
                        },
                        scrollToHash() {
                                const hash = window.location.hash.replace('#', '');
                                if (!hash) {
                                        return;
                                }
                                this.$nextTick(() => {
                                        const target = document.getElementById(hash);
                                        if (target) {
                                                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                        }
                                });
                        },
                        fetchSettings() {
                                fetch('/admin/api/system/settings')
                                        .then(response => response.json())
                                        .then(data => {
                                                if (data.error) {
                                                        window.AdminUI.toast({ message: data.error, type: 'error' });
                                                        return;
                                                }
                                                if (data.settings) {
                                                        this.form = Object.assign(this.form, data.settings);
                                                }
                                        })
                                        .catch(() => {
                                                window.AdminUI.toast({ message: '加载系统设置失败', type: 'error' });
                                        });
                        },
                        triggerLogoUpload() {
                                if (this.logoUploading) {
                                        return;
                                }
                                if (this.$refs.logoInput) {
                                        this.$refs.logoInput.click();
                                }
                        },
                        handleLogoSelected(event) {
                                const files = event.target?.files;
                                if (!files || files.length === 0) {
                                        return;
                                }
                                const [file] = files;
                                event.target.value = '';
                                if (!file || !file.type.startsWith('image/')) {
                                        window.AdminUI.toast({ message: '请选择图片文件', type: 'warning' });
                                        return;
                                }
                                this.uploadLogo(file);
                        },
                        async uploadLogo(file) {
                                this.logoUploading = true;
                                const formData = new FormData();
                                formData.append('image', file);
                                try {
                                        const response = await fetch('/admin/api/upload/image', {
                                                method: 'POST',
                                                body: formData,
                                        });
                                        const data = await response.json().catch(() => ({}));
                                        if (!response.ok || data.error || !data.data || !data.data.url) {
                                                const message = data && (data.error || data.message) ? (data.error || data.message) : 'Logo 上传失败，请稍后重试';
                                                window.AdminUI.toast({ message, type: 'error' });
                                                return;
                                        }
                                        this.form.siteLogoUrl = data.data.url;
                                        window.AdminUI.toast({ message: 'Logo 上传成功', type: 'success' });
                                } catch (error) {
                                        const message = error && error.message ? error.message : 'Logo 上传失败，请稍后重试';
                                        window.AdminUI.toast({ message, type: 'error' });
                                } finally {
                                        this.logoUploading = false;
                                }
                        },
                        clearLogo() {
                                this.form.siteLogoUrl = '';
                        },
                        async testOpenAI() {
                                const apiKey = (this.form.openaiApiKey || '').trim();
                                if (!apiKey) {
                                        window.AdminUI.toast({ message: '请先填写 OpenAI API Key', type: 'warning' });
                                        return;
                                }
                                this.openaiTesting = true;
                                try {
                                        const response = await fetch('/admin/api/system/settings/openai/test', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ apiKey }),
                                        });
                                        const data = await response.json().catch(() => ({}));
                                        if (!response.ok || data.error) {
                                                const message = data && data.error ? data.error : '测试失败，请稍后重试';
                                                window.AdminUI.toast({ message, type: 'error' });
                                                return;
                                        }
                                        window.AdminUI.toast({ message: data.message || 'OpenAI 接口连接正常', type: 'success' });
                                } catch (error) {
                                        const message = error && error.message ? error.message : '测试失败，请稍后重试';
                                        window.AdminUI.toast({ message, type: 'error' });
                                } finally {
                                        this.openaiTesting = false;
                                }
                        },
                        submit() {
                                if (!this.form.siteName.trim()) {
                                        window.AdminUI.toast({ message: '请填写站点名称', type: 'warning' });
                                        return;
                                }
                                this.loading = true;
                                fetch('/admin/api/system/settings', {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                                siteName: this.form.siteName,
                                                siteLogoUrl: this.form.siteLogoUrl,
                                                openaiApiKey: this.form.openaiApiKey,
                                        }),
                                })
                                        .then(response => response.json())
                                        .then(data => {
                                                if (data.error) {
                                                        window.AdminUI.toast({ message: data.error, type: 'error' });
                                                        return;
                                                }
                                                if (data.settings) {
                                                        this.form = Object.assign(this.form, data.settings);
                                                }
                                                window.AdminUI.toast({ message: data.message || '系统设置已保存', type: 'success' });
                                        })
                                        .catch(() => {
                                                window.AdminUI.toast({ message: '保存失败，请稍后重试', type: 'error' });
                                        })
                                        .finally(() => {
                                                this.loading = false;
                                        });
                        },
                };
        }
</script>
{{end}}
