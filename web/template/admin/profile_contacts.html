{{template "base" .}}

{{define "content"}}
<div class="space-y-10" x-data="contactManager()" x-init="init()">
	<header class="flex flex-col gap-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80 sm:flex-row sm:items-center sm:justify-between">
		<div>
			<h1 class="text-3xl font-semibold text-slate-900 dark:text-slate-100">社交联系方式</h1>
			<p class="mt-2 text-sm text-slate-500 dark:text-slate-400">集中维护微信、GitHub、邮箱等联系方式，前台所有页面将统一展示。</p>
		</div>
		<button type="button" @click="startCreate()" class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 dark:hover:bg-blue-500/90">新增信息</button>
	</header>

	<section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm transition-colors dark:border-slate-800 dark:bg-slate-900/80">
		<div x-show="loading" class="rounded-lg border border-dashed border-slate-200 bg-slate-50/60 p-4 text-center text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-400" x-cloak>加载中...</div>
		<div x-show="!loading && items.length === 0" class="rounded-lg border border-dashed border-slate-200 bg-slate-50/60 p-4 text-center text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-400" x-cloak>暂未配置联系方式，点击右上角新增。</div>

		<div x-show="items.length > 0" class="space-y-3" x-cloak>
			<template x-for="(item, index) in items" :key="item.id">
				<div class="flex flex-col gap-3 rounded-xl border border-slate-200 bg-slate-50/70 p-4 dark:border-slate-700 dark:bg-slate-900/70 sm:flex-row sm:items-center sm:justify-between">
					<div class="flex flex-1 items-start gap-3">
						<div class="flex h-9 w-9 items-center justify-center rounded-lg bg-white text-slate-500 shadow-sm dark:bg-slate-800" x-html="iconSvg(item.icon)"></div>
						<div class="space-y-1">
							<div class="flex flex-wrap items-center gap-2">
								<p class="text-sm font-semibold text-slate-900 dark:text-slate-100" x-text="item.label"></p>
								<span class="rounded-full bg-blue-50 px-2 py-0.5 text-[11px] font-medium text-blue-600 dark:bg-blue-500/10 dark:text-blue-200" x-text="item.platform"></span>
								<span class="rounded-full bg-slate-200 px-2 py-0.5 text-[11px] font-medium text-slate-600 dark:bg-slate-700/60 dark:text-slate-300" x-text="item.visible ? '显示中' : '已隐藏'"></span>
							</div>
							<p class="text-xs text-slate-500 dark:text-slate-400" x-text="item.value"></p>
							<p class="text-xs text-blue-600 dark:text-blue-300" x-show="item.link" x-text="item.link" x-cloak></p>
						</div>
					</div>
					<div class="flex items-center gap-2">
						<button type="button" class="rounded-lg border border-slate-200 px-2 py-1 text-xs text-slate-600 transition-colors hover:border-blue-300 hover:text-blue-600 dark:border-slate-700 dark:text-slate-400 dark:hover:border-blue-500/40 dark:hover:text-blue-200" @click="move(index, -1)" :disabled="index === 0">上移</button>
						<button type="button" class="rounded-lg border border-slate-200 px-2 py-1 text-xs text-slate-600 transition-colors hover:border-blue-300 hover:text-blue-600 dark:border-slate-700 dark:text-slate-400 dark:hover:border-blue-500/40 dark:hover:text-blue-200" @click="move(index, 1)" :disabled="index === items.length - 1">下移</button>
						<button type="button" class="rounded-lg border border-slate-200 px-2 py-1 text-xs text-slate-600 transition-colors hover:border-blue-300 hover:text-blue-600 dark:border-slate-700 dark:text-slate-400 dark:hover:border-blue-500/40 dark:hover:text-blue-200" @click="toggle(item)">切换显示</button>
						<button type="button" class="rounded-lg border border-blue-200 px-2 py-1 text-xs font-medium text-blue-600 transition-colors hover:bg-blue-500/10 dark:border-blue-500/40 dark:text-blue-200" @click="startEdit(item)">编辑</button>
						<button type="button" class="rounded-lg border border-rose-200 px-2 py-1 text-xs font-medium text-rose-600 transition-colors hover:bg-rose-50 dark:border-rose-500/40 dark:text-rose-300 dark:hover:bg-rose-500/10" @click="remove(item)">删除</button>
					</div>
				</div>
			</template>
		</div>

		<div x-show="showForm" class="rounded-xl border border-dashed border-slate-300 bg-white p-4 dark:border-slate-600 dark:bg-slate-900/70" x-cloak>
			<h3 class="text-sm font-semibold text-slate-900 dark:text-slate-100" x-text="editingId ? '编辑联系方式' : '新增联系方式'"></h3>
			<div class="mt-3 grid gap-3 md:grid-cols-2">
				<label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
					<span>平台<span class="ml-1 text-rose-500">*</span></span>
					<input type="text" x-model="form.platform" placeholder="如：微信" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/20" />
				</label>
				<label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
					<span>展示文案<span class="ml-1 text-rose-500">*</span></span>
					<input type="text" x-model="form.label" placeholder="如：个人微信" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/20" />
				</label>
				<label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
					<span>展示内容<span class="ml-1 text-rose-500">*</span></span>
					<input type="text" x-model="form.value" placeholder="如：weixin-id" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/20" />
				</label>
				<label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
					<span>跳转链接</span>
					<input type="text" x-model="form.link" placeholder="https://..." class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/20" />
				</label>
				<label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
					<span>图标</span>
					<select x-model="form.icon" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-500/60 dark:focus:ring-blue-500/20">
						<option value="">自动选择</option>
						<template x-for="option in iconOptions" :key="option.key">
							<option :value="option.key" x-text="option.label"></option>
						</template>
					</select>
				</label>
				<label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
					<span>是否展示</span>
					<label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
						<input type="checkbox" x-model="form.visible" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 dark:border-slate-600" />显示
					</label>
				</label>
			</div>
			<div class="mt-4 flex justify-end gap-3">
				<button type="button" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100" @click="cancel()">取消</button>
				<button type="button" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 dark:hover:bg-blue-500/90" @click="submit()">保存信息</button>
			</div>
		</div>
	</section>
</div>

<script>
        const PROFILE_ICON_OPTIONS = {{toJSON .profileIconOptions}} || [];
        const PROFILE_ICON_SVGS = {{toJSON .profileIconSVGs}} || {};

        function contactManager() {
                return {
			items: [],
			loading: false,
			showForm: false,
			editingId: null,
			form: {
				platform: '',
				label: '',
				value: '',
				link: '',
				icon: '',
				visible: true,
				sort: null
			},
			iconOptions: PROFILE_ICON_OPTIONS,

			init() {
				this.fetch();
			},

                        iconSvg(key) {
                                return PROFILE_ICON_SVGS[key] || PROFILE_ICON_SVGS.default || '';
                        },

			resetForm() {
				this.form = {
					platform: '',
					label: '',
					value: '',
					link: '',
					icon: '',
					visible: true,
					sort: null
				};
			},

			startCreate() {
				this.editingId = null;
				this.resetForm();
				this.showForm = true;
			},

			startEdit(item) {
				this.editingId = item.id;
				this.form = {
					platform: item.platform,
					label: item.label,
					value: item.value,
					link: item.link || '',
					icon: item.icon || '',
					visible: !!item.visible,
					sort: typeof item.sort === 'number' ? item.sort : null
				};
				this.showForm = true;
			},

			cancel() {
				this.showForm = false;
				this.resetForm();
			},

			async fetch() {
				this.loading = true;
				try {
					const response = await fetch('/admin/api/profile/contacts');
					const data = await response.json().catch(() => ({}));
					if (!response.ok || data.error) {
						throw new Error(data && data.error ? data.error : '加载展示信息失败');
					}
					const items = Array.isArray(data.contacts) ? data.contacts.slice() : [];
					items.sort((a, b) => {
						if (a.sort === b.sort) {
							return a.id - b.id;
						}
						return a.sort - b.sort;
					});
					this.items = items;
				} catch (error) {
					const message = error && error.message ? error.message : '加载展示信息失败';
					window.AdminUI.toast({ message, type: 'error' });
				} finally {
					this.loading = false;
				}
			},

			validate() {
				if (!this.form.platform.trim() || !this.form.label.trim() || !this.form.value.trim()) {
					window.AdminUI.toast({ message: '请填写必填字段', type: 'warning' });
					return false;
				}
				return true;
			},

			async submit() {
				if (!this.validate()) {
					return;
				}

				const payload = {
					platform: this.form.platform.trim(),
					label: this.form.label.trim(),
					value: this.form.value.trim(),
					link: this.form.link.trim(),
					icon: this.form.icon.trim(),
					visible: !!this.form.visible
				};
				if (typeof this.form.sort === 'number') {
					payload.sort = this.form.sort;
				}

				const url = this.editingId ? `/admin/api/profile/contacts/${this.editingId}` : '/admin/api/profile/contacts';
				const method = this.editingId ? 'PUT' : 'POST';

				try {
					const response = await fetch(url, {
						method,
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});
					const data = await response.json().catch(() => ({}));
					if (!response.ok || data.error) {
						const message = data && data.error ? data.error : '保存失败，请稍后重试';
						window.AdminUI.toast({ message, type: 'error' });
						return;
					}
					window.AdminUI.toast({ message: data.message || '保存成功', type: 'success' });
					this.showForm = false;
					this.resetForm();
					this.fetch();
				} catch (error) {
					const message = error && error.message ? error.message : '保存失败，请稍后重试';
					window.AdminUI.toast({ message, type: 'error' });
				}
			},

			async toggle(item) {
				const payload = {
					platform: item.platform,
					label: item.label,
					value: item.value,
					link: item.link || '',
					icon: item.icon || '',
					sort: item.sort,
					visible: !item.visible
				};

				try {
					const response = await fetch(`/admin/api/profile/contacts/${item.id}`, {
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});
					const data = await response.json().catch(() => ({}));
					if (!response.ok || data.error) {
						const message = data && data.error ? data.error : '更新失败，请稍后重试';
						window.AdminUI.toast({ message, type: 'error' });
						return;
					}
					item.visible = !item.visible;
					window.AdminUI.toast({ message: item.visible ? '已显示' : '已隐藏', type: 'success' });
				} catch (error) {
					const message = error && error.message ? error.message : '更新失败，请稍后重试';
					window.AdminUI.toast({ message, type: 'error' });
				}
			},

			move(index, delta) {
				const target = index + delta;
				if (target < 0 || target >= this.items.length) {
					return;
				}
				const swapped = this.items.slice();
				const temp = swapped[index];
				swapped[index] = swapped[target];
				swapped[target] = temp;
				this.items = swapped.map((item, i) => ({ ...item, sort: i }));
				this.persistOrder();
			},

			async persistOrder() {
				const ids = this.items.map(item => item.id);
				try {
					const response = await fetch('/admin/api/profile/contacts/order', {
						method: 'PUT',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ ids })
					});
					if (!response.ok) {
						throw new Error('排序同步失败，请刷新重试');
					}
				} catch (error) {
					const message = error && error.message ? error.message : '排序同步失败，请刷新重试';
					window.AdminUI.toast({ message, type: 'error' });
				}
			},

			async remove(item) {
				if (!window.AdminUI || !window.AdminUI.confirm) {
					return;
				}
				const confirmed = await window.AdminUI.confirm({
					title: '删除联系方式',
					message: `确定删除「${item.label}」吗？`,
					confirmText: '删除',
					cancelText: '取消',
					tone: 'danger'
				});
				if (!confirmed) {
					return;
				}

				try {
					const response = await fetch(`/admin/api/profile/contacts/${item.id}`, {
						method: 'DELETE'
					});
					const data = await response.json().catch(() => ({}));
					if (!response.ok || data.error) {
						const message = data && data.error ? data.error : '删除失败，请稍后重试';
						window.AdminUI.toast({ message, type: 'error' });
						return;
					}
					window.AdminUI.toast({ message: data.message || '已删除', type: 'success' });
					this.fetch();
				} catch (error) {
					const message = error && error.message ? error.message : '删除失败，请稍后重试';
					window.AdminUI.toast({ message, type: 'error' });
				}
			}
		};
	}
</script>
{{end}}
