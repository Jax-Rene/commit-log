{{define "admin_contact_manager"}}
<div class="space-y-4" x-data="contactManager()" x-init="init()" x-cloak>
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                <div>
                        <h3 class="text-base font-semibold text-slate-900 dark:text-slate-100">社交联系方式</h3>
                        <p class="text-xs text-slate-500 dark:text-slate-400">统一维护微信、邮箱、GitHub 等信息，前台展示会自动同步。</p>
                </div>
                <div class="flex items-center gap-2">
                        <button type="button" class="inline-flex items-center rounded-lg border border-slate-200 px-3 py-1.5 text-xs font-medium text-slate-600 transition-colors hover:border-blue-300 hover:text-blue-600 dark:border-slate-700 dark:text-slate-300 dark:hover:border-blue-400/50 dark:hover:text-blue-200" @click="fetch()" x-show="!loading">刷新列表</button>
                        <button type="button" class="inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 dark:hover:bg-blue-500/90" @click="startCreate()">新增信息</button>
                </div>
        </div>

        <div x-show="loading" class="rounded-xl border border-dashed border-slate-200 bg-slate-50/60 p-4 text-center text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-400" x-cloak>加载中...</div>
        <div x-show="!loading && items.length === 0" class="rounded-xl border border-dashed border-slate-200 bg-slate-50/60 p-4 text-center text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-900/60 dark:text-slate-400" x-cloak>暂未配置联系方式，点击「新增信息」补充。</div>

        <div x-show="items.length > 0" class="space-y-3" x-cloak>
                <template x-for="(item, index) in items" :key="item.id">
                        <div class="flex flex-col gap-3 rounded-xl border border-slate-200 bg-slate-50/70 p-4 dark:border-slate-700 dark:bg-slate-900/70 sm:flex-row sm:items-center sm:justify-between">
                                <div class="flex flex-1 items-start gap-3">
                                        <div class="flex h-9 w-9 items-center justify-center rounded-lg bg-white text-slate-500 shadow-sm dark:bg-slate-800" x-html="iconSvg(item.icon)"></div>
                                        <div class="space-y-1">
                                                <div class="flex flex-wrap items-center gap-2">
                                                        <p class="text-sm font-semibold text-slate-900 dark:text-slate-100" x-text="item.label"></p>
                                                        <span class="rounded-full bg-blue-50 px-2 py-0.5 text-[11px] font-medium text-blue-600 dark:bg-blue-500/10 dark:text-blue-200" x-text="platformLabel(item.platform)"></span>
                                                        <span class="rounded-full bg-slate-200 px-2 py-0.5 text-[11px] font-medium text-slate-600 dark:bg-slate-700/60 dark:text-slate-300" x-text="item.visible ? '显示中' : '已隐藏'"></span>
                                                        <span class="rounded-full bg-emerald-100 px-2 py-0.5 text-[11px] font-medium text-emerald-600 dark:bg-emerald-500/10 dark:text-emerald-200" x-show="item.qrImageUrl" x-cloak>二维码</span>
                                                </div>
                                                <p class="text-xs text-slate-500 dark:text-slate-400" x-text="item.value"></p>
                                                <p class="text-xs text-blue-600 dark:text-blue-300" x-show="item.link && item.platform !== 'wechat'" x-text="item.link" x-cloak></p>
                                                <p class="text-xs text-slate-500 dark:text-slate-400" x-show="item.qrImageUrl" x-text="item.qrImageUrl" x-cloak></p>
                                        </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-2">
                                        <button type="button" class="rounded-lg border border-slate-200 px-2 py-1 text-xs text-slate-600 transition-colors hover:border-blue-300 hover:text-blue-600 dark:border-slate-700 dark:text-slate-400 dark:hover:border-blue-500/40 dark:hover:text-blue-200" @click="move(index, -1)" :disabled="index === 0">上移</button>
                                        <button type="button" class="rounded-lg border border-slate-200 px-2 py-1 text-xs text-slate-600 transition-colors hover:border-blue-300 hover:text-blue-600 dark:border-slate-700 dark:text-slate-400 dark:hover:border-blue-500/40 dark:hover:text-blue-200" @click="move(index, 1)" :disabled="index === items.length - 1">下移</button>
                                        <button type="button" class="rounded-lg border border-slate-200 px-2 py-1 text-xs text-slate-600 transition-colors hover:border-blue-300 hover:text-blue-600 dark:border-slate-700 dark:text-slate-400 dark:hover:border-blue-500/40 dark:hover:text-blue-200" @click="toggle(item)">切换显示</button>
                                        <button type="button" class="rounded-lg border border-blue-200 px-2 py-1 text-xs font-medium text-blue-600 transition-colors hover:bg-blue-500/10 dark:border-blue-500/40 dark:text-blue-200" @click="startEdit(item)">编辑</button>
                                        <button type="button" class="rounded-lg border border-rose-200 px-2 py-1 text-xs font-medium text-rose-600 transition-colors hover:bg-rose-50 dark:border-rose-500/40 dark:text-rose-300 dark:hover:bg-rose-500/10" @click="remove(item)">删除</button>
                                </div>
                        </div>
                </template>
        </div>

        <div x-show="showForm" class="rounded-xl border border-dashed border-slate-300 bg-white p-4 dark:border-slate-600 dark:bg-slate-900/70" x-cloak>
                <h4 class="text-sm font-semibold text-slate-900 dark:text-slate-100" x-text="editingId ? '编辑联系方式' : '新增联系方式'"></h4>
                <div class="mt-3 space-y-4">
                        <div class="grid gap-3 md:grid-cols-2">
                                <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
                                        <span>平台<span class="ml-1 text-rose-500">*</span></span>
                                        <select x-model="form.platformType" @change="handlePlatformChange(false)" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-500/20">
                                                <template x-for="option in platformPresets" :key="option.value">
                                                        <option :value="option.value" x-text="option.label"></option>
                                                </template>
                                        </select>
                                </label>
                                <template x-if="form.platformType === 'custom'">
                                        <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
                                                <span>自定义平台标识<span class="ml-1 text-rose-500">*</span></span>
                                                <input type="text" x-model="form.platform" placeholder="如：豆瓣" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-500/20" />
                                        </label>
                                </template>
                                <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
                                        <span>展示名称<span class="ml-1 text-rose-500">*</span></span>
                                        <input type="text" x-model="form.label" @input="labelTouched = true" placeholder="在前台展示的标题" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-500/20" />
                                </label>
                        </div>

                        <div class="grid gap-3 md:grid-cols-2">
                                <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
                                        <span x-text="valueLabel()"></span>
                                        <input type="text" x-model="form.value" @input="handleValueChange()" :placeholder="valuePlaceholder()" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-500/20" />
                                        <span class="text-[11px] text-slate-400 dark:text-slate-500" x-text="valueHelper()" x-show="valueHelper()" x-cloak></span>
                                </label>
                                <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300" x-show="shouldShowLinkInput()" x-cloak>
                                        <span>跳转链接</span>
                                        <input type="url" x-model="form.link" placeholder="https://" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-500/20" />
                                        <span class="text-[11px] text-slate-400 dark:text-slate-500">将直接用于前台跳转，可留空。</span>
                                </label>
                        </div>

                        <div x-show="shouldShowQrField()" x-cloak class="rounded-2xl border border-dashed border-slate-300 bg-white/60 p-4 dark:border-slate-600 dark:bg-slate-900/60">
                                <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                                        <div class="flex items-center gap-4">
                                                <div class="flex h-24 w-24 items-center justify-center overflow-hidden rounded-2xl border border-slate-200 bg-slate-50 shadow-sm dark:border-slate-700 dark:bg-slate-900/60">
                                                        <template x-if="form.qrImageUrl">
                                                                <img :src="form.qrImageUrl" alt="微信二维码" class="h-full w-full object-cover" />
                                                        </template>
                                                        <template x-if="!form.qrImageUrl">
                                                                <span class="text-xs font-medium text-slate-400 dark:text-slate-500">未上传</span>
                                                        </template>
                                                </div>
                                                <div class="max-w-xs space-y-1 text-xs leading-relaxed text-slate-500 dark:text-slate-400">
                                                        <p>上传微信二维码图片，用户在前台悬停图标即可查看。</p>
                                                        <p x-show="form.qrImageUrl" x-text="form.qrImageUrl" class="truncate text-[11px]" x-cloak></p>
                                                </div>
                                        </div>
                                        <div class="flex flex-wrap items-center gap-2">
                                                <input type="file" accept="image/*" class="hidden" x-ref="qrInput" @change="handleQrSelected($event)" />
                                                <button type="button" class="rounded-lg border border-slate-200 px-3 py-2 text-xs font-medium text-slate-600 transition-colors hover:border-blue-200 hover:text-blue-600 dark:border-slate-700 dark:text-slate-300 dark:hover:border-blue-400/50 dark:hover:text-blue-200" @click="triggerQrUpload()" :disabled="qrUploading">
                                                        <span x-show="!qrUploading">上传二维码</span>
                                                        <span x-show="qrUploading">上传中...</span>
                                                </button>
                                                <button type="button" class="rounded-lg border border-rose-200 px-3 py-2 text-xs font-medium text-rose-600 transition-colors hover:bg-rose-50 dark:border-rose-500/40 dark:text-rose-300 dark:hover:bg-rose-500/10" @click="clearQr()" x-show="form.qrImageUrl" x-cloak>移除二维码</button>
                                        </div>
                                </div>
                        </div>

                        <div class="grid gap-3 md:grid-cols-2">
                                <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
                                        <span>显示顺序</span>
                                        <input type="number" x-model.number="form.sort" placeholder="数值越小越靠前" class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm text-slate-900 transition-colors focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-100 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-100 dark:focus:border-blue-400 dark:focus:ring-blue-500/20" />
                                </label>
                                <label class="flex flex-col gap-1 text-xs text-slate-600 dark:text-slate-300">
                                        <span>是否展示</span>
                                        <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                                                <input type="checkbox" x-model="form.visible" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500 dark:border-slate-600" />显示
                                        </label>
                                </label>
                        </div>

                        <div class="flex flex-col gap-1 text-xs text-slate-400 dark:text-slate-500" x-show="linkPreview()" x-cloak>
                                <span>预览链接</span>
                                <span class="truncate text-blue-600 dark:text-blue-300" x-text="linkPreview()"></span>
                        </div>

                        <div class="flex justify-end gap-3">
                                <button type="button" class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 transition-colors hover:bg-slate-100 hover:text-slate-900 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 dark:hover:text-slate-100" @click="cancel()">取消</button>
                                <button type="button" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-500 dark:hover:bg-blue-500/90" @click="submit()">保存信息</button>
                        </div>
                </div>
        </div>
</div>

<script>
        const PLATFORM_PRESETS = [
                { value: 'wechat', label: '微信', icon: 'wechat', labelDefault: '微信', valueLabel: '微信号', valuePlaceholder: '如：commitlog', valueHelper: '', requiresQR: true },
                { value: 'email', label: '邮箱', icon: 'email', labelDefault: '邮箱', valueLabel: '邮箱地址', valuePlaceholder: 'hi@example.com', valueHelper: '我们会自动生成 mailto 链接', autoLink: value => value ? `mailto:${value.trim()}` : '' },
                { value: 'github', label: 'GitHub', icon: 'github', labelDefault: 'GitHub', valueLabel: 'GitHub 用户名', valuePlaceholder: 'commitlog', valueHelper: '无需填写 https://github.com，自动生成链接', autoLink: value => value ? `https://github.com/${value.trim().replace(/^@/, '')}` : '' },
                { value: 'telegram', label: 'Telegram', icon: 'telegram', labelDefault: 'Telegram', valueLabel: 'Telegram 用户名', valuePlaceholder: 'commitlog', valueHelper: '无需填写 https://t.me，自动生成链接', autoLink: value => value ? `https://t.me/${value.trim().replace(/^@/, '')}` : '' },
                { value: 'x', label: 'X / Twitter', icon: 'x', labelDefault: 'X / Twitter', valueLabel: '账号名', valuePlaceholder: 'commitlog', valueHelper: '无需填写 https://x.com，自动生成链接', autoLink: value => value ? `https://x.com/${value.trim().replace(/^@/, '')}` : '' },
                { value: 'website', label: '个人网站', icon: 'website', labelDefault: '网站', valueLabel: '网站地址', valuePlaceholder: 'https://example.com', valueHelper: '请填写完整链接，默认直接跳转', autoLink: value => value ? value.trim() : '' },
                { value: 'custom', label: '自定义', icon: '', labelDefault: '', valueLabel: '展示内容', valuePlaceholder: '请输入要展示的内容', valueHelper: '', manualLink: true }
        ];
        const PROFILE_ICON_SVGS = {{toJSON .profileIconSVGs}} || {};

        function contactManager() {
                return {
                        items: [],
                        loading: false,
                        showForm: false,
                        editingId: null,
                        platformPresets: PLATFORM_PRESETS,
                        form: {
                                platformType: PLATFORM_PRESETS[0].value,
                                platform: PLATFORM_PRESETS[0].value,
                                label: PLATFORM_PRESETS[0].labelDefault || '',
                                value: '',
                                link: '',
                                icon: PLATFORM_PRESETS[0].icon || '',
                                qrImageUrl: '',
                                visible: true,
                                sort: null
                        },
                        labelTouched: false,
                        qrUploading: false,

                        init() {
                                this.fetch();
                                this.handlePlatformChange(true);
                        },

                        platformLabel(value) {
                                const preset = this.findPreset(value);
                                return preset ? preset.label : (value || '自定义');
                        },

                        findPreset(key) {
                                return this.platformPresets.find(preset => preset.value === key) || null;
                        },

                        currentPreset() {
                                return this.findPreset(this.form.platformType) || null;
                        },

                        valueLabel() {
                                const preset = this.currentPreset();
                                return preset ? `${preset.valueLabel || '值'} *` : '值 *';
                        },

                        valuePlaceholder() {
                                const preset = this.currentPreset();
                                return preset ? preset.valuePlaceholder || '' : '';
                        },

                        valueHelper() {
                                const preset = this.currentPreset();
                                return preset ? preset.valueHelper || '' : '';
                        },

                        shouldShowLinkInput() {
                                const preset = this.currentPreset();
                                return preset ? !!preset.manualLink : false;
                        },

                        shouldShowQrField() {
                                const preset = this.currentPreset();
                                return preset ? !!preset.requiresQR : false;
                        },

                        linkPreview() {
                                const preset = this.currentPreset();
                                if (preset && preset.requiresQR) {
                                        return this.form.qrImageUrl || '';
                                }
                                return this.form.link || '';
                        },

                        iconSvg(key) {
                                return PROFILE_ICON_SVGS[key] || PROFILE_ICON_SVGS.default || '';
                        },

                        resetForm() {
                                this.form = {
                                        platformType: PLATFORM_PRESETS[0].value,
                                        platform: PLATFORM_PRESETS[0].value,
                                        label: PLATFORM_PRESETS[0].labelDefault || '',
                                        value: '',
                                        link: '',
                                        icon: PLATFORM_PRESETS[0].icon || '',
                                        qrImageUrl: '',
                                        visible: true,
                                        sort: null
                                };
                                this.labelTouched = false;
                                this.qrUploading = false;
                                this.handlePlatformChange(true);
                        },

                        startCreate() {
                                this.editingId = null;
                                this.resetForm();
                                this.showForm = true;
                        },

                        startEdit(item) {
                                const preset = this.findPreset(item.platform) || this.findPreset('custom');
                                const platformType = preset ? preset.value : 'custom';
                                this.editingId = item.id;
                                this.form = {
                                        platformType: platformType,
                                        platform: platformType === 'custom' ? (item.platform || '') : platformType,
                                        label: item.label || '',
                                        value: item.value || '',
                                        link: item.link || '',
                                        icon: item.icon || '',
                                        qrImageUrl: item.qrImageUrl || (item.platform === 'wechat' ? (item.link || '') : ''),
                                        visible: !!item.visible,
                                        sort: typeof item.sort === 'number' ? item.sort : null
                                };
                                this.labelTouched = true;
                                this.qrUploading = false;
                                this.showForm = true;
                                this.handlePlatformChange(true);
                        },

                        cancel() {
                                this.showForm = false;
                                this.resetForm();
                        },

                        handlePlatformChange(preserveExisting) {
                                const preset = this.currentPreset();
                                if (preset) {
                                        if (preset.value !== 'custom') {
                                                this.form.platform = preset.value;
                                        } else if (!preserveExisting && !this.form.platform) {
                                                this.form.platform = '';
                                        }
                                        this.form.icon = preset.icon || '';
                                        if (!this.labelTouched && preset.labelDefault) {
                                                this.form.label = preset.labelDefault;
                                        }
                                        if (!preset.manualLink) {
                                                this.form.link = preset.autoLink ? preset.autoLink(this.form.value || '') : '';
                                        }
                                        if (!preset.requiresQR && !preserveExisting) {
                                                this.form.qrImageUrl = '';
                                        }
                                }
                        },

                        handleValueChange() {
                                const preset = this.currentPreset();
                                if (preset && !preset.manualLink && preset.autoLink) {
                                        this.form.link = preset.autoLink(this.form.value || '');
                                }
                        },

                        validate() {
                                if (this.form.platformType === 'custom' && !this.form.platform.trim()) {
                                        window.AdminUI.toast({ message: '请填写自定义平台标识', type: 'warning' });
                                        return false;
                                }
                                if (!this.form.label.trim()) {
                                        window.AdminUI.toast({ message: '请填写展示名称', type: 'warning' });
                                        return false;
                                }
                                if (!this.form.value.trim()) {
                                        window.AdminUI.toast({ message: this.valueLabel() + '不能为空', type: 'warning' });
                                        return false;
                                }
                                const preset = this.currentPreset();
                                if (preset && preset.requiresQR && !this.form.qrImageUrl.trim()) {
                                        window.AdminUI.toast({ message: '请上传微信二维码', type: 'warning' });
                                        return false;
                                }
                                return true;
                        },

                        buildPayload() {
                                const preset = this.currentPreset();
                                const trimmedValue = this.form.value.trim();
                                let link = this.form.link.trim();
                                if (preset && !preset.manualLink && preset.autoLink) {
                                        link = preset.autoLink(trimmedValue);
                                }
                                const payload = {
                                        platform: this.form.platformType === 'custom' ? this.form.platform.trim() : (preset ? preset.value : this.form.platform.trim()),
                                        label: this.form.label.trim(),
                                        value: trimmedValue,
                                        link: link,
                                        icon: (this.form.icon || '').trim(),
                                        visible: !!this.form.visible
                                };
                                if (typeof this.form.sort === 'number') {
                                        payload.sort = this.form.sort;
                                }
                                if (preset && preset.requiresQR) {
                                        payload.qrImageUrl = this.form.qrImageUrl.trim();
                                        payload.link = payload.qrImageUrl;
                                }
                                return payload;
                        },

                        async submit() {
                                if (!this.validate()) {
                                        return;
                                }

                                const payload = this.buildPayload();
                                const url = this.editingId ? `/admin/api/profile/contacts/${this.editingId}` : '/admin/api/profile/contacts';
                                const method = this.editingId ? 'PUT' : 'POST';

                                try {
                                        const response = await fetch(url, {
                                                method,
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(payload)
                                        });
                                        const data = await response.json().catch(() => ({}));
                                        if (!response.ok || data.error) {
                                                const message = data && data.error ? data.error : '保存失败，请稍后重试';
                                                window.AdminUI.toast({ message, type: 'error' });
                                                return;
                                        }
                                        window.AdminUI.toast({ message: data.message || '保存成功', type: 'success' });
                                        this.showForm = false;
                                        this.resetForm();
                                        this.fetch();
                                } catch (error) {
                                        const message = error && error.message ? error.message : '保存失败，请稍后重试';
                                        window.AdminUI.toast({ message, type: 'error' });
                                }
                        },

                        async fetch() {
                                this.loading = true;
                                try {
                                        const response = await fetch('/admin/api/profile/contacts');
                                        const data = await response.json().catch(() => ({}));
                                        if (!response.ok || data.error) {
                                                throw new Error(data && data.error ? data.error : '加载展示信息失败');
                                        }
                                        const items = Array.isArray(data.contacts) ? data.contacts.slice() : [];
                                        items.sort((a, b) => {
                                                if (a.sort === b.sort) {
                                                        return a.id - b.id;
                                                }
                                                return a.sort - b.sort;
                                        });
                                        this.items = items.map(item => ({
                                                ...item,
                                                link: item.link || '',
                                                qrImageUrl: item.qrImageUrl || (item.platform === 'wechat' ? (item.link || '') : ''),
                                                icon: item.icon || ''
                                        }));
                                } catch (error) {
                                        const message = error && error.message ? error.message : '加载展示信息失败';
                                        window.AdminUI.toast({ message, type: 'error' });
                                } finally {
                                        this.loading = false;
                                }
                        },

                        buildPayloadFromItem(item) {
                                const payload = {
                                        platform: item.platform,
                                        label: item.label,
                                        value: item.value,
                                        link: item.link || '',
                                        icon: item.icon || '',
                                        visible: item.visible
                                };
                                if (typeof item.sort === 'number') {
                                        payload.sort = item.sort;
                                }
                                if (item.qrImageUrl) {
                                        payload.qrImageUrl = item.qrImageUrl;
                                }
                                return payload;
                        },

                        async toggle(item) {
                                const payload = this.buildPayloadFromItem(item);
                                payload.visible = !item.visible;

                                try {
                                        const response = await fetch(`/admin/api/profile/contacts/${item.id}`, {
                                                method: 'PUT',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(payload)
                                        });
                                        const data = await response.json().catch(() => ({}));
                                        if (!response.ok || data.error) {
                                                const message = data && data.error ? data.error : '更新失败，请稍后重试';
                                                window.AdminUI.toast({ message, type: 'error' });
                                                return;
                                        }
                                        item.visible = !item.visible;
                                        window.AdminUI.toast({ message: item.visible ? '已显示' : '已隐藏', type: 'success' });
                                } catch (error) {
                                        const message = error && error.message ? error.message : '更新失败，请稍后重试';
                                        window.AdminUI.toast({ message, type: 'error' });
                                }
                        },

                        move(index, delta) {
                                const target = index + delta;
                                if (target < 0 || target >= this.items.length) {
                                        return;
                                }
                                const swapped = this.items.slice();
                                const temp = swapped[index];
                                swapped[index] = swapped[target];
                                swapped[target] = temp;
                                this.items = swapped.map((item, i) => ({ ...item, sort: i }));
                                this.persistOrder();
                        },

                        async persistOrder() {
                                const ids = this.items.map(item => item.id);
                                try {
                                        const response = await fetch('/admin/api/profile/contacts/order', {
                                                method: 'PUT',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ ids })
                                        });
                                        if (!response.ok) {
                                                throw new Error('排序同步失败，请刷新重试');
                                        }
                                } catch (error) {
                                        const message = error && error.message ? error.message : '排序同步失败，请刷新重试';
                                        window.AdminUI.toast({ message, type: 'error' });
                                }
                        },

                        async remove(item) {
                                if (!window.AdminUI || !window.AdminUI.confirm) {
                                        return;
                                }
                                const confirmed = await window.AdminUI.confirm({
                                        title: '删除联系方式',
                                        message: `确定删除「${item.label}」吗？`,
                                        confirmText: '删除',
                                        cancelText: '取消',
                                        tone: 'danger'
                                });
                                if (!confirmed) {
                                        return;
                                }

                                try {
                                        const response = await fetch(`/admin/api/profile/contacts/${item.id}`, {
                                                method: 'DELETE'
                                        });
                                        const data = await response.json().catch(() => ({}));
                                        if (!response.ok || data.error) {
                                                const message = data && data.error ? data.error : '删除失败，请稍后重试';
                                                window.AdminUI.toast({ message, type: 'error' });
                                                return;
                                        }
                                        window.AdminUI.toast({ message: data.message || '已删除', type: 'success' });
                                        this.fetch();
                                } catch (error) {
                                        const message = error && error.message ? error.message : '删除失败，请稍后重试';
                                        window.AdminUI.toast({ message, type: 'error' });
                                }
                        },

                        triggerQrUpload() {
                                if (this.qrUploading) {
                                        return;
                                }
                                if (this.$refs.qrInput) {
                                        this.$refs.qrInput.click();
                                }
                        },

                        handleQrSelected(event) {
                                const files = event.target?.files;
                                if (!files || files.length === 0) {
                                        return;
                                }
                                const [file] = files;
                                event.target.value = '';
                                if (!file || !file.type.startsWith('image/')) {
                                        window.AdminUI.toast({ message: '请选择图片文件', type: 'warning' });
                                        return;
                                }
                                this.uploadQr(file);
                        },

                        async uploadQr(file) {
                                this.qrUploading = true;
                                const formData = new FormData();
                                formData.append('image', file);
                                try {
                                        const response = await fetch('/admin/api/upload/image', {
                                                method: 'POST',
                                                body: formData
                                        });
                                        const data = await response.json().catch(() => ({}));
                                        if (!response.ok || data.error || !data.data || !data.data.url) {
                                                const message = data && (data.error || data.message) ? (data.error || data.message) : '二维码上传失败，请稍后重试';
                                                window.AdminUI.toast({ message, type: 'error' });
                                                return;
                                        }
                                        this.form.qrImageUrl = data.data.url;
                                        window.AdminUI.toast({ message: '二维码上传成功', type: 'success' });
                                } catch (error) {
                                        const message = error && error.message ? error.message : '二维码上传失败，请稍后重试';
                                        window.AdminUI.toast({ message, type: 'error' });
                                } finally {
                                        this.qrUploading = false;
                                }
                        },

                        clearQr() {
                                this.form.qrImageUrl = '';
                        }
                };
        }
</script>
{{end}}
