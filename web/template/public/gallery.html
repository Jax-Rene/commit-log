{{template "base" .}} {{define "content"}}
<section class="space-y-10">
    <header class="space-y-3">
        <div
            class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between"
        >
            <div class="space-y-2">
                <h1
                    class="text-3xl font-semibold text-slate-900 dark:text-slate-100"
                >
                    Photography Portfolio
                </h1>
                {{if .site.gallerySubtitle}}
                <p class="text-sm text-slate-600 dark:text-slate-400">
                    {{.site.gallerySubtitle}}
                </p>
                {{end}}
            </div>
        </div>
    </header>

    <div id="gallery-content" class="space-y-6">
        <div
            id="gallery-grid"
            class="grid grid-cols-1 items-start gap-3 sm:grid-cols-2 lg:grid-cols-3"
        >
            {{if .items}} {{range .items}}
            <article data-gallery-card class="relative">
                <button
                    type="button"
                    data-gallery-trigger
                    data-full-url="{{.ImageURL}}"
                    class="block w-full"
                    aria-label="{{if .Title}}{{.Title}}{{else}}摄影作品{{end}}"
                >
                    <div
                        class="relative w-full overflow-hidden"
                        style="padding-top: {{aspectPadding .ImageWidth .ImageHeight}};"
                    >
                        <img
                            src="{{.ImageURL}}"
                            alt="{{if .Title}}{{.Title}}{{else}}摄影作品{{end}}"
                            loading="lazy"
                            class="absolute inset-0 h-full w-full object-cover"
                        />
                    </div>
                </button>
            </article>
            {{end}} {{else}}
            <div
                class="rounded-3xl border border-dashed border-slate-300 bg-white/70 p-12 text-center text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-400"
            >
                暂时没有作品，稍后再来看吧。
            </div>
            {{end}}
        </div>

        {{if .items}} {{if .hasMore}}
        <div
            id="load-more"
            hx-get="/gallery/more?page={{add .page 1}}"
            hx-trigger="revealed"
            hx-target="#load-more"
            hx-swap="outerHTML"
        >
            <div
                class="flex justify-center py-8 text-sm text-slate-500 dark:text-slate-400"
            >
                加载中…
            </div>
        </div>
        {{else}}
        <div
            id="load-more"
            class="py-8 text-center text-sm text-slate-400 dark:text-slate-500"
        >
            已经到底啦 ✨
        </div>
        {{end}} {{end}}
    </div>
</section>

<div
    id="gallery-lightbox"
    class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/80 px-4 py-6 backdrop-blur-sm"
>
    <div class="relative w-full max-w-5xl">
        <button
            type="button"
            id="gallery-lightbox-close"
            class="absolute right-3 top-3 rounded-full bg-white/90 p-2 text-slate-700 shadow-lg transition hover:bg-white"
        >
            <span class="sr-only">关闭</span>
            <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                class="h-5 w-5"
            >
                <path
                    d="M6 6l12 12M18 6L6 18"
                    stroke-width="1.8"
                    stroke-linecap="round"
                ></path>
            </svg>
        </button>
        <div class="overflow-hidden bg-slate-900 shadow-2xl">
            <img
                id="gallery-lightbox-image"
                src=""
                alt=""
                class="max-h-[70vh] w-full object-contain bg-slate-900"
            />
        </div>
    </div>
</div>

<script>
    (() => {
        const grid = document.getElementById("gallery-grid");
        if (!grid) return;

        const applyMasonry = () => {
            grid.style.gridAutoRows = "1px";
            const styles = window.getComputedStyle(grid);
            const rowGap = parseFloat(styles.getPropertyValue("row-gap")) || 0;
            const rowHeight =
                parseFloat(styles.getPropertyValue("grid-auto-rows")) || 1;

            grid.querySelectorAll("[data-gallery-card]").forEach((card) => {
                const cardHeight = card.getBoundingClientRect().height;
                const span = Math.max(
                    1,
                    Math.ceil((cardHeight + rowGap) / (rowHeight + rowGap)),
                );
                card.style.gridRowEnd = `span ${span}`;
            });
        };

        const rafApply = () => window.requestAnimationFrame(applyMasonry);
        rafApply();

        grid.querySelectorAll("img").forEach((img) => {
            if (img.complete) {
                rafApply();
                return;
            }
            img.addEventListener("load", rafApply);
            img.addEventListener("error", rafApply);
        });

        window.addEventListener("resize", rafApply);
        document.addEventListener("htmx:afterSwap", rafApply);

        const lightbox = document.getElementById("gallery-lightbox");
        const lightboxImage = document.getElementById("gallery-lightbox-image");
        const closeButton = document.getElementById("gallery-lightbox-close");

        const closeLightbox = () => {
            if (!lightbox || !lightboxImage) return;
            lightbox.classList.add("hidden");
            lightboxImage.src = "";
            lightboxImage.alt = "";
        };

        grid.addEventListener("click", (event) => {
            const trigger = event.target.closest("[data-gallery-trigger]");
            if (!trigger) return;
            const fullUrl = trigger.getAttribute("data-full-url");
            if (!fullUrl) return;
            const thumb = trigger.querySelector("img");
            const altText = thumb && thumb.alt ? thumb.alt : "摄影作品";
            lightboxImage.src = fullUrl;
            lightboxImage.alt = altText;
            lightbox.classList.remove("hidden");
        });

        closeButton.addEventListener("click", closeLightbox);
        lightbox.addEventListener("click", (event) => {
            if (event.target === lightbox) {
                closeLightbox();
            }
        });
        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                closeLightbox();
            }
        });
    })();
</script>
{{end}}
