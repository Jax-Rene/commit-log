{{template "base" .}} {{define "content"}}
<section class="space-y-10">
    <header class="space-y-2">
        <form
            method="GET"
            action="/"
            class="space-y-4"
            hx-get="/"
            hx-trigger="change"
            hx-target="#post-content"
            hx-select="#post-content"
            hx-swap="outerHTML"
            hx-push-url="true"
        >
            <input type="hidden" name="search" value="{{.search}}" />
            {{if .tagOptions}}
            <div class="flex flex-wrap gap-2 text-xs">
                {{range $tag := .tagOptions}}
                <label
                    class="tag-filter inline-flex items-center cursor-pointer"
                >
                    <input
                        type="checkbox"
                        name="tags"
                        value="{{$tag.Name}}"
                        class="tag-filter-input sr-only"
                        {{range
                        $.tags}}{{if
                        eq
                        .
                        $tag.Name}}checked{{end}}{{end}}
                    />
                    <span class="tag-filter-pill">
                        <span>{{$tag.Name}}</span>
                        <span
                            class="ml-1 text-[10px] font-semibold text-slate-400 dark:text-slate-500"
                        >
                            · {{$tag.Count}}
                        </span>
                    </span>
                </label>
                {{end}}
            </div>
            {{end}}
        </form>
    </header>

    {{ $hasPosts := gt (len .posts) 0 }}
    <div id="post-content" class="space-y-6">
        <div
            id="post-grid"
            class="grid grid-cols-1 items-start gap-x-6 sm:grid-cols-2 xl:grid-cols-3"
            style="row-gap: calc(1.5rem);"
        >
            {{if $hasPosts}} {{range .posts}} {{template "post_card" (dict
            "Post" .)}} {{end}} {{end}}
        </div>

        {{if not $hasPosts}}
        <div
            class="rounded-3xl border border-dashed border-slate-300 bg-white/70 p-12 text-center text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-900/70 dark:text-slate-400"
        >
            暂时没有符合条件的文章，换个关键词试试吧。
        </div>
        {{end}} {{if $hasPosts}} {{if .hasMore}}
        <div
            id="load-more"
            hx-get="/posts/more?page={{add .page 1}}{{.queryParams}}"
            hx-trigger="revealed"
            hx-target="#load-more"
            hx-swap="outerHTML"
        >
            <div
                class="flex justify-center py-8 text-sm text-slate-500 dark:text-slate-400"
            >
                加载中…
            </div>
        </div>
        {{else}}
        <div
            class="py-8 text-center text-sm text-slate-400 dark:text-slate-500"
        >
            已经到底啦 ✨
        </div>
        {{end}} {{end}}
    </div>
</section>

<script>
    (() => {
        const grid = document.getElementById("post-grid");
        if (!grid) return;

        // 通过动态 span 模拟瀑布流，确保垂直间距一致
        const applyMasonry = () => {
            grid.style.gridAutoRows = "1px";
            const styles = window.getComputedStyle(grid);
            const rowGap = parseFloat(styles.getPropertyValue("row-gap")) || 0;
            const rowHeight =
                parseFloat(styles.getPropertyValue("grid-auto-rows")) || 1;

            grid.querySelectorAll("[data-post-card]").forEach((card) => {
                const cardHeight = card.getBoundingClientRect().height;
                const span = Math.max(
                    1,
                    Math.ceil((cardHeight + rowGap) / (rowHeight + rowGap))
                );
                card.style.gridRowEnd = `span ${span}`;
            });
        };

        const rafApply = () => window.requestAnimationFrame(applyMasonry);
        rafApply();

        grid.querySelectorAll("img").forEach((img) => {
            if (img.complete) {
                rafApply();
                return;
            }
            img.addEventListener("load", rafApply);
            img.addEventListener("error", rafApply);
        });

        window.addEventListener("resize", rafApply);
        document.addEventListener("htmx:afterSwap", rafApply);
    })();
</script>
{{end}}
