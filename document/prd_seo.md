# SEO 友好 URL 与 301 管理 PRD

## 1. 背景与目标

当前文章 URL 使用 `/posts/<id>`，可读性与语义不足，不利于长期 SEO 和分享传播。本次优化希望在不大规模迁移历史内容的前提下，提供更友好的文章 URL，并完善 301 跳转与后台配置能力。

**目标：**
- 文章详情 URL 使用 `/posts/<slug>`，避免暴露内部 ID。
- 发布时生成稳定 slug，并确保唯一性与可读性。
- 提供 301 映射表（可编辑/禁用），标题变更触发自动写入映射。
- 后台系统设置中提供 SEO 配置入口（含 LLM 生成开关 + 映射表管理）。

## 2. 范围

**包含：**
- 文章 slug 生成、存储、校验、发布时更新。
- 301 映射表自动写入 + 手工管理。
- 路由与输出（sitemap/rss/canonical/search suggestions）统一更新为 slug。
- 系统设置页新增 SEO 配置与映射管理能力。

**不包含：**
- 历史文章批量迁移（默认不做批量重算）。
- 新增 AI 提示词配置（沿用系统默认，不在本期开放编辑）。

## 3. 目标用户

- 博客作者/站长（后台管理）
- 访问者与搜索引擎爬虫（前台访问）

## 4. 功能需求

### 4.1 文章 URL 规则
- 新文章详情页使用 `/posts/<slug>`。
- 保留 `/posts/<id>` 访问入口，命中后 301 到对应 slug URL。
- canonical、sitemap、RSS、搜索建议、文章卡片链接统一使用 slug URL。

### 4.2 Slug 生成策略
- **优先使用 LLM** 生成英文 slug（系统设置开关控制）。
- LLM 不可用或失败时，使用 **标题拼音** 作为兜底。
- 统一规则：英文小写、仅保留字母数字与 `-`，多分隔符合并。
- 不限制长度，但若生成结果为空则发布失败并提示。

### 4.3 标题唯一性校验
- **发布时强校验**：全站不允许与其他文章标题重复（包含草稿与已发布）。
- 冲突直接报错，终止发布流程。
- 通过标题一致性校验避免 slug 冲突；数据库层面使用 slug 唯一索引兜底。

### 4.4 301 映射表
- 标题变更导致 slug 变化时，发布流程自动写入旧 → 新映射。
- 301 映射支持 **新增、编辑、禁用**。
- 通过 `from_path` 精确匹配请求路径，命中后返回 301。
- 支持查询与筛选（按路径/状态）。

### 4.5 系统设置（SEO）
- 后台系统设置新增 SEO 页签：
  - LLM 生成 slug 开关。
  - 301 映射列表（查看/新增/编辑/禁用/搜索）。

### 4.6 输出与 SEO 资源
- `sitemap.xml`：文章 URL 输出为 `/posts/<slug>`。
- `rss.xml`：item link 输出为 `/posts/<slug>`。
- 搜索建议、列表卡片、文章详情 canonical 全部使用 slug URL。

## 5. 业务流程

### 5.1 发布流程
1. 发布请求进入校验：标题、正文、封面等基础规则。
2. 校验 **标题唯一性**（不允许重复）。
3. 生成 slug（LLM → 拼音兜底 → 规范化）。
4. slug 唯一索引校验（DB 兜底）。
5. 生成/更新发布快照，保存 slug。
6. 若最新线上 slug 与本次 slug 不一致，写入 301 映射（旧 → 新）。

### 5.2 访问流程
- 访问 `/posts/<slug>`：直接渲染文章详情。
- 访问 `/posts/<id>`：若可解析到 slug，301 到 `/posts/<slug>`。
- 任意路径进入 404 之前，先匹配 301 映射表，命中则 301 跳转。

## 6. 数据模型

### 6.1 文章
- `posts.slug`：唯一索引，发布时写入。
- `post_publications.slug`：发布快照保存当时 slug（无需唯一）。

### 6.2 301 映射表
- `redirect_mappings`：
  - `from_path`（唯一索引）
  - `to_path`
  - `enabled`
  - `post_id`（可选关联）
  - `reason`（可选）
  - `created_at` / `updated_at`

### 6.3 系统设置
- `seo_slug_llm_enabled`（bool）：是否启用 LLM 生成 slug。

## 7. API 与权限

**后台：**
- `GET /admin/api/system/settings`：返回 SEO 配置项。
- `PUT /admin/api/system/settings`：更新 SEO 配置项。
- `GET /admin/api/seo/redirects`：分页查询映射。
- `POST /admin/api/seo/redirects`：新增映射。
- `PUT /admin/api/seo/redirects/:id`：编辑映射。
- `PUT /admin/api/seo/redirects/:id/disable`：禁用/启用映射。

**前台：**
- `GET /posts/:slug`：文章详情。
- `GET /posts/:id`：301 跳转到 slug。

## 8. 兼容与迁移策略

- 不做历史文章批量迁移。
- 旧文章在重新发布时会生成 slug，并触发 301。
- 旧 `/posts/<id>` 入口长期保留以兼容历史分享。

## 9. 非功能需求

- 跳转与 slug 校验需在发布事务中完成，保证一致性。
- 映射表查询需有索引支持，避免请求时性能瓶颈。
- slug 生成失败需有明确错误提示，避免静默降级。

## 10. 验收标准

- 发布后文章详情 URL 为 `/posts/<slug>`，旧 `/posts/<id>` 301。
- 标题重复时发布失败，错误信息明确。
- 文章标题变更后发布会自动写入 301 映射。
- 后台 SEO 配置可开启/关闭 LLM，且可管理映射表。
- sitemap、RSS、canonical、搜索建议 URL 均为 slug。

## 11. 风险与待定

- LLM 生成 slug 的一致性与稳定性需要明确提示词策略（本期使用默认策略）。
- 标题唯一性限制可能影响作者编辑习惯，需要清晰提示与校验信息。
